<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
    }
    
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
    }

    h1 {
      color: #d32f2f;
      font-size: 28px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.3s;
    }
    .step-dot.active { background: #e91e63; width: 30px; }
    .step-dot.completed { background: #c44569; }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace { grid-template-columns: 1fr; }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      position: relative;
    }

    .work-panel {
      background: linear-gradient(135deg, #ffffff, #fff9fc);
      border: 2px dashed rgba(255, 107, 157, 0.4);
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .guide-image {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: contain;
      border-radius: 16px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      min-height: 50px;
    }

    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(255,249,252,0.5));
      border-radius: 16px;
      overflow: visible;
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      -webkit-user-drag: none;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    /* ä¼˜åŒ–åçš„å¥¶æ²¹ - SVGèŠ±æœµçŠ¶ */
    .cream-flower {
      position: absolute;
      width: 24px;
      height: 24px;
      pointer-events: none;
      z-index: 15;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
      animation: creamGrow 0.3s ease-out forwards;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      70% { transform: scale(1.1) rotate(180deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    /* æ°´æœ - ç›´æ¥å‡ºç°ï¼Œä¸æ—‹è½¬ */
    .static-fruit {
      position: absolute;
      font-size: 26px;
      z-index: 16;
      /* ç›´æ¥å‡ºç°ï¼Œæ— åŠ¨ç”» */
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      background: transparent !important;
      pointer-events: none;
      line-height: 1;
    }

    /* èœ¡çƒ› - 48px */
    .candle {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      z-index: 20;
      transition: transform 0.2s;
      background: transparent !important;
      pointer-events: auto;
      line-height: 1;
    }

    .candle:hover { transform: scale(1.1); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      background: transparent !important;
      pointer-events: none;
      line-height: 1;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    .emoji-item:hover { transform: translateY(-3px) scale(1.1); }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page {
      display: none;
      animation: fadeIn 1s ease;
    }

    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    @media (max-width: 768px) {
      .result-compare { grid-template-columns: 1fr; }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .result-label {
      font-family: 'ZCOOL KuaiLe', cursive;
      color: #e91e63;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .final-cake-wrapper {
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      position: relative;
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 16px;
      overflow: hidden;
    }

    /* å…‹éš†æ—¶çš„æ ·å¼ä¿®å¤ */
    .final-cake-wrapper .decorations-layer {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .final-cake-wrapper .cake-base-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      top: 0;
      left: 0;
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      background: transparent !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="main-container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>
    
    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">
          ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼
        </div>

        <div class="cake-workspace" id="cakeArea">
          <img src="images/1.jpg" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="font-family: 'ZCOOL KuaiLe', cursive; color: #d32f2f; font-size: 32px; text-align: center;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    
    <div class="result-compare">
      <div class="result-box">
        <div class="result-label">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-wrapper" id="playerCake"></div>
      </div>
      <div class="result-box">
        <div class="result-label">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div class="final-cake-wrapper">
          <img src="images/6.jpg" alt="æˆå“è›‹ç³•" style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;">
        </div>
      </div>
    </div>

    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>

  <script>
    const steps = [
      { guide: 'images/1.jpg', work: 'images/1.jpg', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff' },
      { guide: 'images/2.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/2.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit' },
      { guide: 'images/4.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å››æ­¥ï¼šæ’ä¸Šç”Ÿæ—¥èœ¡çƒ›', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle' },
      { guide: 'images/5.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹ç‡ƒèœ¡çƒ›ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šè‡ªç”±è£…é¥° & å®Œæˆï¼', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    
    const guideImage = document.getElementById('guideImage');
    const workImage = document.getElementById('workImage');
    const guideText = document.getElementById('guideText');
    const instruction = document.getElementById('instruction');
    const cakeArea = document.getElementById('cakeArea');
    const decorLayer = document.getElementById('decorationsLayer');
    const emojiPalette = document.getElementById('emojiPalette');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const finishBtn = document.getElementById('finishBtn');

    const emojis = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­'];

    // SVGå¥¶æ²¹èŠ±æœµæ¨¡æ¿ - æ›´åƒçœŸå®å¥¶æ²¹
    const creamSVG = `
      <svg width="100%" height="100%" viewBox="0 0 24 24" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));">
        <defs>
          <radialGradient id="creamGrad" cx="50%" cy="40%">
            <stop offset="0%" style="stop-color:#fff; stop-opacity:1" />
            <stop offset="50%" style="stop-color:#fff5f5; stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ffe4e1; stop-opacity:1" />
          </radialGradient>
        </defs>
        <!-- äº”ä¸ªèŠ±ç“£ç»„æˆçš„èŠ±æœµ -->
        <g fill="url(#creamGrad)" stroke="rgba(0,0,0,0.05)" stroke-width="0.3">
          <ellipse cx="12" cy="6" rx="3" ry="4" />
          <ellipse cx="18" cy="10" rx="3" ry="4" transform="rotate(72 18 10)" />
          <ellipse cx="15" cy="18" rx="3" ry="4" transform="rotate(144 15 18)" />
          <ellipse cx="9" cy="18" rx="3" ry="4" transform="rotate(216 9 18)" />
          <ellipse cx="6" cy="10" rx="3" ry="4" transform="rotate(288 6 10)" />
          <circle cx="12" cy="12" r="3.5" fill="#fff" />
        </g>
        <!-- é«˜å…‰ -->
        <ellipse cx="9" cy="8" rx="1.5" ry="1" fill="rgba(255,255,255,0.8)" transform="rotate(-30 9 8)" />
      </svg>
    `;

    function init() { updateStep(); }

    function updateStep() {
      const step = steps[currentStep];
      
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.classList.remove('active', 'completed');
        if (idx < currentStep) dot.classList.add('completed');
        if (idx === currentStep) dot.classList.add('active');
      });

      guideImage.src = step.guide;
      workImage.src = step.work;
      guideText.textContent = step.guideText;
      instruction.textContent = step.instruction;
      
      resetInteractions();
      
      if (currentStep === 0) setupFluffInteraction();
      if (currentStep === 1) setupCreamInteraction();
      if (currentStep === 2) setupFruitInteraction();
      if (currentStep === 3) setupCandleInteraction();
      if (currentStep === 4) setupLightInteraction();
      if (currentStep === 5) setupDecorateInteraction();
      
      if (currentStep === 5) {
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'inline-block';
        resetBtn.style.display = 'inline-block';
        emojiPalette.style.display = 'flex';
        createEmojiPalette();
      } else {
        nextBtn.style.display = 'inline-block';
        finishBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        emojiPalette.style.display = 'none';
      }
    }

    function resetInteractions() {
      const newArea = cakeArea.cloneNode(false);
      const oldArea = cakeArea;
      
      // ä¿ç•™è£…é¥°å±‚
      const decor = oldArea.querySelector('.decorations-layer');
      const img = oldArea.querySelector('.cake-base-img');
      
      newArea.appendChild(img);
      newArea.appendChild(decor);
      
      oldArea.parentNode.replaceChild(newArea, oldArea);
      
      // é‡æ–°ç»‘å®šå¼•ç”¨
      Object.defineProperties(window, {
        cakeArea: { value: newArea, writable: true },
        workImage: { value: img, writable: true },
        decorLayer: { value: decor, writable: true }
      });
    }

    function setupFluffInteraction() {
      let isPressed = false;
      workImage.style.transition = 'transform 0.2s';
      
      cakeArea.onmousedown = () => { isPressed = true; workImage.style.transform = 'scaleY(0.9) scaleX(1.05)'; };
      cakeArea.onmouseup = () => { 
        isPressed = false; 
        workImage.style.transform = 'scaleY(1) scaleX(1)'; 
        fluffiness = Math.min(fluffiness + 20, 100);
        if (fluffiness >= 100) nextStep();
      };
      cakeArea.ontouchstart = (e) => { e.preventDefault(); cakeArea.onmousedown(); };
      cakeArea.ontouchend = () => cakeArea.onmouseup();
    }

    function setupCreamInteraction() {
      isDrawing = false;
      
      cakeArea.onmousedown = (e) => {
        isDrawing = true;
        addCream(e);
      };
      
      cakeArea.onmousemove = (e) => {
        if (isDrawing) addCream(e);
      };
      
      cakeArea.onmouseup = () => isDrawing = false;
      cakeArea.onmouseleave = () => isDrawing = false;
      
      cakeArea.ontouchstart = (e) => {
        e.preventDefault();
        isDrawing = true;
        addCream(e.touches[0]);
      };
      
      cakeArea.ontouchmove = (e) => {
        e.preventDefault();
        if (isDrawing) addCream(e.touches[0]);
      };
      
      cakeArea.ontouchend = () => isDrawing = false;
    }

    function addCream(e) {
      const rect = cakeArea.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const cream = document.createElement('div');
      cream.className = 'cream-flower';
      cream.innerHTML = creamSVG;
      cream.style.left = (x - 12) + 'px';
      cream.style.top = (y - 12) + 'px';
      cream.style.width = '24px';
      cream.style.height = '24px';
      // éšæœºæ—‹è½¬è§’åº¦ï¼Œçœ‹èµ·æ¥æ›´è‡ªç„¶
      cream.style.transform = `rotate(${Math.random() * 360}deg)`;
      
      decorLayer.appendChild(cream);
      
      // é™åˆ¶å¥¶æ²¹æ•°é‡ï¼Œé¿å…è¿‡å¤š
      const creams = decorLayer.querySelectorAll('.cream-flower');
      if (creams.length > 50) creams[0].remove();
    }

    function setupFruitInteraction() {
      const fruits = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ‡'];
      
      cakeArea.onclick = (e) => {
        const rect = cakeArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const fruit = document.createElement('div');
        fruit.className = 'static-fruit';
        fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
        fruit.style.left = (x - 13) + 'px';
        fruit.style.top = (y - 13) + 'px';
        // éšæœºè½»å¾®æ—‹è½¬ï¼Œä½†ä¸åŠ¨ç”»
        const rot = (Math.random() - 0.5) * 30;
        fruit.style.transform = `rotate(${rot}deg)`;
        
        decorLayer.appendChild(fruit);
      };
    }

    function setupCandleInteraction() {
      candleCount = 0;
      
      cakeArea.onclick = (e) => {
        if (candleCount >= 5) return;
        
        const rect = cakeArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const candle = document.createElement('div');
        candle.className = 'candle';
        candle.textContent = 'ğŸ•¯ï¸';
        candle.style.left = (x - 24) + 'px';
        candle.style.top = (y - 48) + 'px';
        
        decorLayer.appendChild(candle);
        candleCount++;
      };
    }

    function setupLightInteraction() {
      cakeArea.onclick = (e) => {
        const unlit = decorLayer.querySelectorAll('.candle:not(.lit)');
        
        if (unlit.length === 0) {
          if (candleCount > 0) nextStep();
          return;
        }
        
        const rect = cakeArea.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        unlit.forEach(candle => {
          const cx = parseFloat(candle.style.left) + 24;
          const cy = parseFloat(candle.style.top) + 48;
          const dist = Math.hypot(clickX - cx, clickY - cy);
          if (dist < 60) {
            candle.classList.add('lit');
            if (unlit.length === 1) setTimeout(nextStep, 1000);
          }
        });
      };
    }

    function setupDecorateInteraction() {
      // ç¬¬å…­æ­¥ä¿æŒä¹‹å‰çš„è£…é¥°ï¼Œåªæ·»åŠ æ‹–æ‹½
    }

    function createEmojiPalette() {
      emojiPalette.innerHTML = '';
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        
        const startDrag = (x, y) => {
          const ghost = document.createElement('div');
          ghost.className = 'dragging-ghost';
          ghost.textContent = emoji;
          ghost.style.left = (x - 18) + 'px';
          ghost.style.top = (y - 18) + 'px';
          document.body.appendChild(ghost);
          
          const move = (e) => {
            const cx = e.clientX || (e.touches && e.touches[0].clientX);
            const cy = e.clientY || (e.touches && e.touches[0].clientY);
            if (cx && cy) {
              ghost.style.left = (cx - 18) + 'px';
              ghost.style.top = (cy - 18) + 'px';
            }
          };
          
          const end = (e) => {
            const cx = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const cy = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const rect = cakeArea.getBoundingClientRect();
            
            if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
              const el = document.createElement('div');
              el.className = 'decoration-emoji';
              el.textContent = emoji;
              el.style.left = (cx - rect.left - 14) + 'px';
              el.style.top = (y - rect.top - 14) + 'px';
              decorLayer.appendChild(el);
            }
            
            ghost.remove();
            document.removeEventListener('mousemove', move);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchend', end);
          };
          
          document.addEventListener('mousemove', move);
          document.addEventListener('touchmove', move, { passive: false });
          document.addEventListener('mouseup', end);
          document.addEventListener('touchend', end);
        };
        
        item.onmousedown = (e) => { e.preventDefault(); startDrag(e.clientX, e.clientY); };
        item.ontouchstart = (e) => { 
          e.preventDefault(); 
          if (e.touches[0]) startDrag(e.touches[0].clientX, e.touches[0].clientY); 
        };
        
        emojiPalette.appendChild(item);
      });
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
      }
    }

    function resetStep() {
      decorLayer.innerHTML = '';
      candleCount = 0;
      fluffiness = 0;
      updateStep();
    }

    function finish() {
      // å…³é”®ä¿®å¤ï¼šæ·±åº¦å…‹éš†è›‹ç³•åŒºåŸŸï¼Œç¡®ä¿æ‰€æœ‰è£…é¥°éƒ½è¢«å¤åˆ¶
      const playerCake = document.getElementById('playerCake');
      playerCake.innerHTML = '';
      
      // åˆ›å»ºç›¸åŒçš„ç»“æ„
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'position: relative; width: 100%; height: 100%;';
      
      // 1. æ·»åŠ åº•å›¾ï¼ˆä½¿ç”¨å½“å‰å·¥ä½œå°çš„åº•å›¾ï¼‰
      const baseImg = document.createElement('img');
      baseImg.src = workImage.src;
      baseImg.className = 'cake-base-img';
      baseImg.style.cssText = 'width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; z-index: 1;';
      wrapper.appendChild(baseImg);
      
      // 2. å…‹éš†è£…é¥°å±‚ï¼ˆæ·±åº¦å…‹éš†æ‰€æœ‰å­å…ƒç´ ï¼‰
      const decorClone = document.createElement('div');
      decorClone.className = 'decorations-layer';
      decorClone.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;';
      
      // éå†æ‰€æœ‰è£…é¥°å…ƒç´ å¹¶å…‹éš†
      const decorations = decorLayer.querySelectorAll('*');
      decorations.forEach(el => {
        const clone = el.cloneNode(true);
        // ç§»é™¤åŠ¨ç”»ç±»ï¼Œä¿æŒæœ€ç»ˆçŠ¶æ€
        clone.style.animation = 'none';
        clone.style.transform = el.style.transform; // ä¿æŒæ—‹è½¬è§’åº¦
        decorClone.appendChild(clone);
      });
      
      wrapper.appendChild(decorClone);
      playerCake.appendChild(wrapper);
      
      // æ˜¾ç¤ºç»“æœé¡µ
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      
      // åº†ç¥åŠ¨ç”»
      const celebration = document.getElementById('celebration');
      const symbols = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'âœ¨', 'ğŸ’–'];
      for (let i = 0; i < 40; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = symbols[Math.floor(Math.random() * symbols.length)];
          c.style.left = Math.random() * 100 + 'vw';
          c.style.animationDuration = (3 + Math.random() * 2) + 's';
          c.style.fontSize = (20 + Math.random() * 20) + 'px';
          celebration.appendChild(c);
          setTimeout(() => c.remove(), 4000);
        }, i * 30);
      }
    }

    init();
  </script>
</body>
</html>