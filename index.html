<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }
    
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
    }

    h1 {
      color: #d32f2f;
      font-size: 32px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
    }
    
    .step-dot.active { 
      background: #e91e63; 
      width: 35px; 
      border-radius: 15px;
    }
    
    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace { grid-template-columns: 1fr; }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      position: relative;
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .guide-image {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: contain;
      border-radius: 16px;
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }
    
    .progress-bar.active { display: block; }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.1s linear;
    }

    .cake-workspace {
      position: relative;
      width: 350px;
      height: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.1s;
      display: block;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .cream-flower {
      position: absolute;
      width: 24px;
      height: 24px;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s ease-out forwards;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      font-size: 26px;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s ease-out forwards;
      pointer-events: none;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
      pointer-events: auto;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1) translateY(-5px); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
      pointer-events: none;
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    /* é£˜æµ®æç¤ºæ ·å¼ */
    .floating-tip {
      position: absolute;
      color: #e91e63;
      font-weight: bold;
      font-size: 16px;
      pointer-events: none;
      z-index: 100;
      animation: floatUp 0.8s ease-out forwards;
      text-shadow: 0 2px 4px rgba(255,255,255,0.8);
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.8); opacity: 1; }
      50% { transform: translateY(-30px) scale(1.1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1); opacity: 0; }
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 150px;
      overflow-y: auto;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .emoji-item:hover { 
      transform: translateY(-3px) scale(1.1); 
      border-color: #ff6b9d;
    }

    .special-item {
      width: 60px;
      height: 60px;
      border: 2px dashed #e91e63;
      background: #fff0f5;
    }
    
    .special-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page { display: none; animation: fadeIn 1s; }
    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    @media (max-width: 768px) {
      .result-compare { grid-template-columns: 1fr; }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    /* ä¿®å¤åçš„ç»“æœè›‹ç³•å®¹å™¨ - ç¡®ä¿å°ºå¯¸ä¸å·¥ä½œå°å®Œå…¨ä¸€è‡´ */
    .final-cake-wrapper {
      position: relative;
      width: 350px;
      height: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.5);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .final-cake-wrapper img.base {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      z-index: 1;
    }
    
    .final-cake-wrapper .decor-clone {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }
    
    .dragging-ghost img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      font-size: 14px;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    @media (max-width: 768px) {
      .cake-workspace, .final-cake-wrapper {
        width: 300px;
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>
    
    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" style="position: relative;">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <div class="cake-workspace" id="cakeArea">
          <img src="images/1.jpg" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="text-align: center; color: #d32f2f; font-family: 'ZCOOL KuaiLe', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare">
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-wrapper" id="playerCake"></div>
      </div>
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div class="final-cake-wrapper">
          <img src="images/6.jpg" alt="æˆå“" class="base">
        </div>
      </div>
    </div>
    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>

  <script>
    const steps = [
      { guide: 'images/1.jpg', work: 'images/1.jpg', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: 'images/2.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/2.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true },
      { guide: 'images/4.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: 'images/5.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];

    const emojis = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­'];
    const fruits = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ‡', 'ğŸ‘', 'ğŸŠ'];
    
    // ç‰¹æ®Šè£…é¥°å›¾ç‰‡é…ç½®
    const specialDecorations = [
      { id: 'fox', path: 'images/fox.jpg', name: 'å°ç‹ç‹¸' },
      { id: 'hanyu', path: 'images/q_hanyu.jpg', name: 'é«˜ç€šå®‡' }
    ];

    // Web Audio API éŸ³æ•ˆ
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      if (type === 'fluff') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.15);
      } else if (type === 'cream') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(400, audioCtx.currentTime + 0.15);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.15);
      } else if (type === 'pop') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(600, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.1);
      }
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // æ˜¾ç¤ºé£˜æµ®æç¤º
    function showFloatingTip(x, y, text, parent) {
      const tip = document.createElement('div');
      tip.className = 'floating-tip';
      tip.textContent = text;
      tip.style.left = x + 'px';
      tip.style.top = y + 'px';
      parent.appendChild(tip);
      setTimeout(() => tip.remove(), 800);
    }

    function updateStep() {
      const step = steps[currentStep];
      
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + (idx < currentStep ? ' completed' : '') + (idx === currentStep ? ' active' : '');
      });

      document.getElementById('guideImage').src = step.guide;
      document.getElementById('workImage').src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;
      
      const pbar = document.getElementById('progressBar');
      pbar.style.display = step.hasProgress ? 'block' : 'none';
      updateProgress();
      
      setupInteraction();
      
      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';
      
      if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('emojiPalette').style.display = 'flex';
        createEmojiPalette();
      } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'none';
      }
    }

    function updateProgress() {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) fill.style.width = fluffiness + '%';
      else if (currentStep === 2) fill.style.width = (decorations.filter(d => d.step === 2).length / 10 * 100) + '%';
      else if (currentStep === 3) fill.style.width = (candleCount / 5 * 100) + '%';
    }

    function setupInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const workImage = document.getElementById('workImage');
      const decorLayer = document.getElementById('decorationsLayer');
      const step = steps[currentStep];
      
      // æ¸…é™¤äº‹ä»¶
      cakeArea.onmousedown = null;
      cakeArea.onmousemove = null;
      cakeArea.onmouseup = null;
      cakeArea.onmouseleave = null;
      cakeArea.onclick = null;
      cakeArea.ontouchstart = null;
      cakeArea.ontouchmove = null;
      cakeArea.ontouchend = null;
      
      if (step.action === 'fluff') {
        let pressing = false;
        let interval;
        workImage.style.cursor = 'grab';
        
        const doFluff = (e) => {
          if (!pressing) return;
          
          // ç«‹å³æ›´æ–°è¿›åº¦
          fluffiness = Math.min(fluffiness + 5, 100);
          updateProgress();
          playSound('fluff');
          
          // è·å–åæ ‡æ˜¾ç¤ºé£˜æµ®æç¤º
          const rect = cakeArea.getBoundingClientRect();
          const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
          const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
          
          // åœ¨æŒ‰å‹ä½ç½®æ˜¾ç¤º "+1 è“¬æ¾åº¦"
          showFloatingTip(x, y, '+1 è“¬æ¾åº¦!', cakeArea);
          
          // æŒ‰å‹æ•ˆæœ
          workImage.style.transform = 'scale(0.92, 1.08)';
          
          if (fluffiness >= 100) {
            clearInterval(interval);
            pressing = false;
            workImage.style.transform = 'scale(1)';
            showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
            setTimeout(nextStep, 500);
          }
        };
        
        const start = (e) => {
          e.preventDefault();
          pressing = true;
          doFluff(e); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
          
          interval = setInterval(() => {
            doFluff(e);
          }, 100);
        };
        
        const end = () => {
          pressing = false;
          clearInterval(interval);
          workImage.style.transform = 'scale(1)';
        };
        
        cakeArea.onmousedown = start;
        cakeArea.onmouseup = end;
        cakeArea.onmouseleave = end;
        cakeArea.ontouchstart = (e) => start(e.touches[0]);
        cakeArea.ontouchend = end;
      }
      
      else if (step.action === 'cream') {
        cakeArea.style.cursor = 'crosshair';
        let lastX, lastY;
        
        const addCream = (x, y) => {
          playSound('cream');
          
          const cream = document.createElement('div');
          cream.className = 'cream-flower';
          cream.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" stroke="#ffe4e1" stroke-width="2"/><circle cx="8" cy="8" r="3" fill="#fff5f5"/><circle cx="16" cy="8" r="3" fill="#fff5f5"/><circle cx="12" cy="16" r="3" fill="#fff5f5"/></svg>`;
          cream.style.left = (x - 12) + 'px';
          cream.style.top = (y - 12) + 'px';
          cream.style.width = (18 + Math.random() * 10) + 'px';
          cream.style.height = cream.style.width;
          decorLayer.appendChild(cream);
          decorations.push({step: currentStep, el: cream});
          
          if (decorLayer.querySelectorAll('.cream-flower').length > 50) {
            decorLayer.querySelector('.cream-flower').remove();
          }
        };
        
        cakeArea.onmousedown = (e) => {
          isDrawing = true;
          const rect = cakeArea.getBoundingClientRect();
          lastX = e.clientX - rect.left;
          lastY = e.clientY - rect.top;
          addCream(lastX, lastY);
        };
        
        cakeArea.onmousemove = (e) => {
          if (!isDrawing) return;
          const rect = cakeArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          if (Math.hypot(x - lastX, y - lastY) > 15) {
            addCream(x, y);
            lastX = x;
            lastY = y;
          }
        };
        
        cakeArea.onmouseup = () => isDrawing = false;
        cakeArea.onmouseleave = () => isDrawing = false;
        
        cakeArea.ontouchstart = (e) => {
          e.preventDefault();
          isDrawing = true;
          const rect = cakeArea.getBoundingClientRect();
          addCream(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        };
        
        cakeArea.ontouchmove = (e) => {
          e.preventDefault();
          if (!isDrawing) return;
          const rect = cakeArea.getBoundingClientRect();
          addCream(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        };
        
        cakeArea.ontouchend = () => isDrawing = false;
      }
      
      else if (step.action === 'fruit') {
        cakeArea.style.cursor = 'copy';
        cakeArea.onclick = (e) => {
          playSound('pop');
          const rect = cakeArea.getBoundingClientRect();
          const fruit = document.createElement('div');
          fruit.className = 'static-fruit';
          fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
          fruit.style.left = (e.clientX - rect.left - 13) + 'px';
          fruit.style.top = (e.clientY - rect.top - 13) + 'px';
          decorLayer.appendChild(fruit);
          decorations.push({step: currentStep, el: fruit});
          updateProgress();
        };
      }
      
      else if (step.action === 'candle') {
        cakeArea.style.cursor = 'pointer';
        candleCount = 0;
        updateProgress();
        
        cakeArea.onclick = (e) => {
          if (candleCount >= 5) {
            showToast('æœ€å¤šåªèƒ½æ’5æ ¹èœ¡çƒ›ï¼');
            return;
          }
          playSound('pop');
          const rect = cakeArea.getBoundingClientRect();
          const candle = document.createElement('div');
          candle.className = 'candle';
          candle.textContent = 'ğŸ•¯ï¸';
          candle.style.left = (e.clientX - rect.left - 24) + 'px';
          candle.style.top = (e.clientY - rect.top - 48) + 'px';
          decorLayer.appendChild(candle);
          decorations.push({step: currentStep, el: candle});
          candleCount++;
          updateProgress();
          
          if (candleCount === 5) setTimeout(nextStep, 800);
        };
      }
      
      else if (step.action === 'light') {
        cakeArea.style.cursor = 'pointer';
        
        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;
          const unlit = decorLayer.querySelectorAll('.candle:not(.lit)');
          
          if (unlit.length === 0 && candleCount > 0) {
            nextStep();
            return;
          }
          
          unlit.forEach(candle => {
            const cx = parseFloat(candle.style.left) + 24;
            const cy = parseFloat(candle.style.top) + 24;
            if (Math.hypot(clickX - cx, clickY - cy) < 60) {
              candle.classList.add('lit');
              playSound('pop');
            }
          });
          
          if (decorLayer.querySelectorAll('.candle:not(.lit)').length === 0 && candleCount > 0) {
            showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
            setTimeout(nextStep, 1000);
          }
        };
      }
    }

    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';
      
      // æ·»åŠ emoji
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        
        const drag = (x, y) => {
          const ghost = document.createElement('div');
          ghost.className = 'dragging-ghost';
          ghost.textContent = emoji;
          ghost.style.left = x + 'px';
          ghost.style.top = y + 'px';
          document.body.appendChild(ghost);
          
          const move = (e) => {
            const cx = e.clientX || e.touches?.[0].clientX;
            const cy = e.clientY || e.touches?.[0].clientY;
            if (cx) { ghost.style.left = cx + 'px'; ghost.style.top = cy + 'px'; }
          };
          
          const end = (e) => {
            const cx = e.clientX || e.changedTouches?.[0].clientX;
            const cy = e.clientY || e.changedTouches?.[0].clientY;
            const rect = document.getElementById('cakeArea').getBoundingClientRect();
            if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
              playSound('pop');
              const dec = document.createElement('div');
              dec.className = 'decoration-emoji';
              dec.textContent = emoji;
              dec.style.left = (cx - rect.left - 14) + 'px';
              dec.style.top = (cy - rect.top - 14) + 'px';
              document.getElementById('decorationsLayer').appendChild(dec);
              decorations.push({step: 5, el: dec});
            }
            ghost.remove();
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('touchend', end);
          };
          
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', end);
          document.addEventListener('touchmove', move, {passive:false});
          document.addEventListener('touchend', end);
        };
        
        item.onmousedown = (e) => { e.preventDefault(); drag(e.clientX, e.clientY); };
        item.ontouchstart = (e) => { e.preventDefault(); drag(e.touches[0].clientX, e.touches[0].clientY); };
        palette.appendChild(item);
      });
      
      // æ·»åŠ ç‰¹æ®Šè£…é¥°å›¾ç‰‡ï¼ˆfox å’Œ hanyuï¼‰
      specialDecorations.forEach(special => {
        const item = document.createElement('div');
        item.className = 'emoji-item special-item';
        const img = document.createElement('img');
        img.src = special.path;
        img.alt = special.name;
        item.appendChild(img);
        
        // æ‹–æ‹½ç‰¹æ®Šå›¾ç‰‡
        const drag = (x, y) => {
          const ghost = document.createElement('div');
          ghost.className = 'dragging-ghost';
          const ghostImg = document.createElement('img');
          ghostImg.src = special.path;
          ghost.appendChild(ghostImg);
          ghost.style.left = x + 'px';
          ghost.style.top = y + 'px';
          document.body.appendChild(ghost);
          
          const move = (e) => {
            const cx = e.clientX || e.touches?.[0].clientX;
            const cy = e.clientY || e.touches?.[0].clientY;
            if (cx) { ghost.style.left = cx + 'px'; ghost.style.top = cy + 'px'; }
          };
          
          const end = (e) => {
            const cx = e.clientX || e.changedTouches?.[0].clientX;
            const cy = e.clientY || e.changedTouches?.[0].clientY;
            const rect = document.getElementById('cakeArea').getBoundingClientRect();
            if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
              playSound('pop');
              const dec = document.createElement('img');
              dec.src = special.path;
              dec.style.cssText = `position: absolute; width: 60px; height: 60px; object-fit: cover; border-radius: 8px; left: ${cx - rect.left - 30}px; top: ${cy - rect.top - 30}px; z-index: 20; animation: decorPlace 0.3s ease-out; box-shadow: 0 2px 8px rgba(0,0,0,0.2);`;
              document.getElementById('decorationsLayer').appendChild(dec);
              decorations.push({step: 5, el: dec, isSpecial: true});
            }
            ghost.remove();
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('touchend', end);
          };
          
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', end);
          document.addEventListener('touchmove', move, {passive:false});
          document.addEventListener('touchend', end);
        };
        
        item.onmousedown = (e) => { e.preventDefault(); drag(e.clientX, e.clientY); };
        item.ontouchstart = (e) => { e.preventDefault(); drag(e.touches[0].clientX, e.touches[0].clientY); };
        palette.appendChild(item);
      });
    }

    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          if (currentStep === 0) fluffiness = Math.max(0, fluffiness - 5);
          if (currentStep === 3) candleCount = Math.max(0, candleCount - 1);
          updateProgress();
          return;
        }
      }
    }

    function prevStep() { if (currentStep > 0) { currentStep--; updateStep(); } }
    function nextStep() { if (currentStep < steps.length - 1) { currentStep++; updateStep(); } }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) { d.el.remove(); return false; }
        return true;
      });
      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      updateStep();
      showToast('å·²é‡ç½®');
    }

    function finish() {
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      
      const playerCake = document.getElementById('playerCake');
      playerCake.innerHTML = '';
      
      // åº•å›¾ - ä½¿ç”¨æœ€ç»ˆçš„è›‹ç³•åº•å›¾ï¼ˆimages/2.jpgï¼‰
      const baseImg = document.createElement('img');
      baseImg.src = 'images/2.jpg';
      baseImg.className = 'base';
      playerCake.appendChild(baseImg);
      
      // è£…é¥°å±‚å®¹å™¨ - å¿…é¡»ä½¿ç”¨ä¸åŸè£…é¥°å±‚å®Œå…¨ç›¸åŒçš„åæ ‡ç³»
      const decorClone = document.createElement('div');
      decorClone.className = 'decor-clone';
      
      // å¤åˆ¶æ‰€æœ‰è£…é¥°ï¼Œä¿æŒç²¾ç¡®ä½ç½®
      const sourceDecor = document.getElementById('decorationsLayer');
      Array.from(sourceDecor.children).forEach(child => {
        const clone = child.cloneNode(true);
        // å¦‚æœæ–°å›¾ç‰‡è·¯å¾„éœ€è¦è½¬æ¢ä¸ºå·²æœ‰çš„è·¯å¾„
        if (clone.tagName === 'IMG' && clone.src.includes('fox.jpg')) {
          clone.src = 'fox.jpg';
        } else if (clone.tagName === 'IMG' && clone.src.includes('q_hanyu.jpg')) {
          clone.src = 'q_hanyu.jpg';
        }
        // ç§»é™¤åŠ¨ç”»ï¼Œä¿æŒæœ€ç»ˆçŠ¶æ€
        clone.style.animation = 'none';
        decorClone.appendChild(clone);
      });
      
      playerCake.appendChild(decorClone);
      
      // æ’’èŠ±
      const cel = document.getElementById('celebration');
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = ['ğŸ€','ğŸ‰','ğŸˆ','ğŸ','âœ¨','ğŸ’–'][Math.floor(Math.random()*6)];
          c.style.left = Math.random()*100 + 'vw';
          c.style.animationDuration = (3+Math.random()*2)+'s';
          cel.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i*40);
      }
    }

    updateStep();
  </script>
</body>
</html>





