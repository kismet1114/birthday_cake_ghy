<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }
    
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
      position: relative;
    }

    h1 {
      color: #d32f2f;
      font-size: 32px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      position: relative;
    }
    
    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
    }
    
    .step-dot.active { 
      background: #e91e63; 
      width: 35px; 
      border-radius: 15px;
    }
    
    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace { grid-template-columns: 1fr; }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      position: relative;
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .guide-image {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: contain;
      border-radius: 16px;
      border: 2px solid rgba(0,0,0,0.05);
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }
    
    .progress-bar.active { display: block; }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.3s;
    }

    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
      border: 2px dashed rgba(255, 107, 157, 0.2);
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.2s;
      display: block; /* ç¡®ä¿å›¾ç‰‡æ˜¾ç¤º */
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .cream-flower {
      position: absolute;
      width: 24px;
      height: 24px;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      font-size: 26px;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      pointer-events: none;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1) translateY(-5px); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
      pointer-events: none;
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 120px;
      overflow-y: auto;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .emoji-item:hover { transform: translateY(-3px) scale(1.1); }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(211,47,47,0.4); }
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page { display: none; animation: fadeIn 1s; }
    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    @media (max-width: 768px) {
      .result-compare { grid-template-columns: 1fr; }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: rainbow 3s ease infinite;
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      font-size: 14px;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="main-container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>
    
    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" style="position: relative;">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <div class="cake-workspace" id="cakeArea">
          <img src="1.jpg" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="text-align: center; color: #d32f2f; font-family: 'ZCOOL KuaiLe', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare">
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-wrapper" id="playerCake" style="position: relative; width: 100%; height: 350px; background: #fff9fc; border-radius: 16px;"></div>
      </div>
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div style="position: relative; width: 100%; height: 350px; background: #fff9fc; border-radius: 16px;">
          <img src="6.jpg" alt="æˆå“" style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;">
        </div>
      </div>
    </div>
    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>

  <script>
    // æ³¨æ„ï¼šå›¾ç‰‡è·¯å¾„å·²æ”¹ä¸ºç›´æ¥ 1.jpg, 2.jpg ç­‰ï¼ˆå‡è®¾ä¸HTMLåŒç›®å½•ï¼‰
    // å¦‚æœæ‚¨çš„å›¾ç‰‡åœ¨imagesæ–‡ä»¶å¤¹é‡Œï¼Œè¯·æŠŠè·¯å¾„æ”¹å› images/1.jpg ç­‰
    const steps = [
      { guide: '1.jpg', work: '1.jpg', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: '2.jpg', work: '2.jpg', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: '3.jpg', work: '2.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true },
      { guide: '4.jpg', work: '2.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: '5.jpg', work: '2.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: '6.jpg', work: '2.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];

    const emojis = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­', 'ğŸ±', 'ğŸ€'];
    const fruits = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ‡', 'ğŸ‘', 'ğŸŠ'];

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function updateStep() {
      const step = steps[currentStep];
      
      // æ›´æ–°æŒ‡ç¤ºå™¨
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + (idx < currentStep ? ' completed' : '') + (idx === currentStep ? ' active' : '');
      });

      // æ›´æ–°å†…å®¹
      document.getElementById('guideImage').src = step.guide;
      document.getElementById('workImage').src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;
      
      // è¿›åº¦æ¡
      document.getElementById('progressBar').style.display = step.hasProgress ? 'block' : 'none';
      updateProgressDisplay();
      
      // äº¤äº’è®¾ç½®
      setupInteraction();
      
      // æŒ‰é’®
      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';
      document.getElementById('nextBtn').style.display = currentStep === 5 ? 'none' : 'inline-block';
      document.getElementById('finishBtn').style.display = currentStep === 5 ? 'inline-block' : 'none';
      document.getElementById('emojiPalette').style.display = currentStep === 5 ? 'flex' : 'none';
      
      if (currentStep === 5) createEmojiPalette();
    }

    function setupInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const workImage = document.getElementById('workImage');
      const decorLayer = document.getElementById('decorationsLayer');
      const step = steps[currentStep];
      
      // æ¸…é™¤æ—§äº‹ä»¶
      cakeArea.onmousedown = null;
      cakeArea.onmousemove = null;
      cakeArea.onmouseup = null;
      cakeArea.onmouseleave = null;
      cakeArea.onclick = null;
      cakeArea.ontouchstart = null;
      cakeArea.ontouchmove = null;
      cakeArea.ontouchend = null;
      
      if (step.action === 'fluff') {
        let pressing = false;
        workImage.style.cursor = 'grab';
        
        const start = (e) => {
          e.preventDefault();
          pressing = true;
          workImage.style.transform = 'scale(0.92, 1.08)';
          const interval = setInterval(() => {
            if (!pressing) { clearInterval(interval); return; }
            fluffiness = Math.min(fluffiness + 5, 100);
            updateProgressDisplay();
            if (fluffiness >= 100) {
              clearInterval(interval);
              showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
              setTimeout(nextStep, 500);
            }
          }, 100);
        };
        
        const end = () => {
          pressing = false;
          workImage.style.transform = 'scale(1)';
        };
        
        cakeArea.onmousedown = start;
        cakeArea.onmouseup = end;
        cakeArea.onmouseleave = end;
        cakeArea.ontouchstart = (e) => start(e.touches[0]);
        cakeArea.ontouchend = end;
      }
      
      else if (step.action === 'cream') {
        cakeArea.style.cursor = 'crosshair';
        let lastX, lastY;
        
        const addCream = (x, y) => {
          const cream = document.createElement('div');
          cream.className = 'cream-flower';
          cream.innerHTML = `<svg viewBox="0 0 24 24" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));"><defs><radialGradient id="cg" cx="50%" cy="40%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#ffe4e1"/></defs><g fill="url(#cg)"><ellipse cx="12" cy="6" rx="3" ry="4"/><ellipse cx="6" cy="10" rx="3" ry="4" transform="rotate(60 6 10)"/><ellipse cx="18" cy="10" rx="3" ry="4" transform="rotate(-60 18 10)"/><ellipse cx="9" cy="18" rx="3" ry="4" transform="rotate(120 9 18)"/><ellipse cx="15" cy="18" rx="3" ry="4" transform="rotate(-120 15 18)"/><circle cx="12" cy="12" r="4" fill="white"/></g></svg>`;
          cream.style.left = (x - 12) + 'px';
          cream.style.top = (y - 12) + 'px';
          cream.style.width = (18 + Math.random() * 12) + 'px';
          cream.style.height = cream.style.width;
          decorLayer.appendChild(cream);
          decorations.push({step: currentStep, el: cream});
          
          if (decorLayer.querySelectorAll('.cream-flower').length > 60) {
            decorLayer.querySelector('.cream-flower').remove();
          }
        };
        
        cakeArea.onmousedown = (e) => {
          isDrawing = true;
          const rect = cakeArea.getBoundingClientRect();
          lastX = e.clientX - rect.left;
          lastY = e.clientY - rect.top;
          addCream(lastX, lastY);
        };
        
        cakeArea.onmousemove = (e) => {
          if (!isDrawing) return;
          const rect = cakeArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          if (Math.hypot(x-lastX, y-lastY) > 12) {
            addCream(x, y);
            lastX = x; lastY = y;
          }
        };
        
        cakeArea.onmouseup = cakeArea.onmouseleave = () => isDrawing = false;
        
        cakeArea.ontouchstart = (e) => {
          e.preventDefault();
          isDrawing = true;
          const rect = cakeArea.getBoundingClientRect();
          addCream(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        };
        
        cakeArea.ontouchmove = (e) => {
          e.preventDefault();
          if (!isDrawing) return;
          const rect = cakeArea.getBoundingClientRect();
          addCream(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        };
        
        cakeArea.ontouchend = () => isDrawing = false;
      }
      
      else if (step.action === 'fruit') {
        cakeArea.style.cursor = 'copy';
        let count = 0;
        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const fruit = document.createElement('div');
          fruit.className = 'static-fruit';
          fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
          fruit.style.left = (e.clientX - rect.left - 13) + 'px';
          fruit.style.top = (e.clientY - rect.top - 13) + 'px';
          decorLayer.appendChild(fruit);
          decorations.push({step: currentStep, el: fruit});
          count++;
          updateProgressDisplay(count, 10);
        };
      }
      
      else if (step.action === 'candle') {
        cakeArea.style.cursor = 'pointer';
        candleCount = 0;
        updateProgressDisplay(0, 5);
        
        cakeArea.onclick = (e) => {
          if (candleCount >= 5) { showToast('æœ€å¤š5æ ¹èœ¡çƒ›ï¼'); return; }
          const rect = cakeArea.getBoundingClientRect();
          const candle = document.createElement('div');
          candle.className = 'candle';
          candle.textContent = 'ğŸ•¯ï¸';
          candle.style.left = (e.clientX - rect.left - 24) + 'px';
          candle.style.top = (e.clientY - rect.top - 48) + 'px';
          decorLayer.appendChild(candle);
          decorations.push({step: currentStep, el: candle});
          candleCount++;
          updateProgressDisplay(candleCount, 5);
          if (candleCount === 5) setTimeout(nextStep, 800);
        };
      }
      
      else if (step.action === 'light') {
        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;
          const unlit = decorLayer.querySelectorAll('.candle:not(.lit)');
          
          if (unlit.length === 0 && candleCount > 0) { nextStep(); return; }
          
          let litAny = false;
          unlit.forEach(candle => {
            const cx = parseFloat(candle.style.left) + 24;
            const cy = parseFloat(candle.style.top) + 24;
            if (Math.hypot(clickX - cx, clickY - cy) < 70) {
              candle.classList.add('lit');
              litAny = true;
              // ç«èŠ±
              for (let i = 0; i < 6; i++) {
                const spark = document.createElement('div');
                spark.style.cssText = `position:absolute;left:${cx}px;top:${cy}px;width:4px;height:4px;background:#ffd93d;border-radius:50%;z-index:30;pointer-events:none;`;
                decorLayer.appendChild(spark);
                const ang = (Math.PI*2/6)*i;
                spark.animate([{transform:'translate(0,0)',opacity:1}, {transform:`translate(${Math.cos(ang)*40}px,${Math.sin(ang)*40}px)`,opacity:0}], {duration:600}).onfinish = () => spark.remove();
              }
            }
          });
          
          if (litAny && decorLayer.querySelectorAll('.candle:not(.lit)').length === 0) {
            showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
            setTimeout(nextStep, 1000);
          }
        };
      }
    }

    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        
        const drag = (x, y) => {
          const ghost = document.createElement('div');
          ghost.className = 'dragging-ghost';
          ghost.textContent = emoji;
          ghost.style.left = x + 'px';
          ghost.style.top = y + 'px';
          document.body.appendChild(ghost);
          
          const move = (e) => {
            const cx = e.clientX || e.touches?.[0].clientX;
            const cy = e.clientY || e.touches?.[0].clientY;
            if (cx) { ghost.style.left = cx + 'px'; ghost.style.top = cy + 'px'; }
          };
          
          const end = (e) => {
            const cx = e.clientX || e.changedTouches?.[0].clientX;
            const cy = e.clientY || e.changedTouches?.[0].clientY;
            const rect = document.getElementById('cakeArea').getBoundingClientRect();
            if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
              const dec = document.createElement('div');
              dec.className = 'decoration-emoji';
              dec.textContent = emoji;
              dec.style.left = (cx - rect.left - 14) + 'px';
              dec.style.top = (cy - rect.top - 14) + 'px';
              document.getElementById('decorationsLayer').appendChild(dec);
              decorations.push({step: 5, el: dec});
            }
            ghost.remove();
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('touchend', end);
          };
          
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', end);
          document.addEventListener('touchmove', move, {passive:false});
          document.addEventListener('touchend', end);
        };
        
        item.onmousedown = (e) => { e.preventDefault(); drag(e.clientX, e.clientY); };
        item.ontouchstart = (e) => { e.preventDefault(); drag(e.touches[0].clientX, e.touches[0].clientY); };
        palette.appendChild(item);
      });
    }

    function updateProgressDisplay(cur, max) {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) fill.style.width = fluffiness + '%';
      else if (cur !== undefined) fill.style.width = (cur/max*100) + '%';
    }

    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          showToast('å·²æ’¤é”€');
          return;
        }
      }
      showToast('æ²¡æœ‰å¯æ’¤é”€çš„');
    }

    function prevStep() { if (currentStep > 0) { currentStep--; updateStep(); } }
    function nextStep() { if (currentStep < steps.length - 1) { currentStep++; updateStep(); } }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) { d.el.remove(); return false; }
        return true;
      });
      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      updateStep();
      showToast('å·²é‡ç½®');
    }

    function finish() {
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      const playerCake = document.getElementById('playerCake');
      playerCake.innerHTML = '';
      
      // å…‹éš†æœ€ç»ˆä½œå“
      const baseImg = document.getElementById('workImage').cloneNode();
      baseImg.style.position = 'absolute';
      baseImg.style.top = '0';
      baseImg.style.left = '0';
      baseImg.style.width = '100%';
      baseImg.style.height = '100%';
      
      const decorClone = document.getElementById('decorationsLayer').cloneNode(true);
      decorClone.style.position = 'absolute';
      decorClone.style.top = '0';
      decorClone.style.left = '0';
      decorClone.style.width = '100%';
      decorClone.style.height = '100%';
      
      playerCake.appendChild(baseImg);
      playerCake.appendChild(decorClone);
      
      // æ’’èŠ±
      const cel = document.getElementById('celebration');
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = ['ğŸ€','ğŸ‰','ğŸˆ','ğŸ','âœ¨','ğŸ’–'][Math.floor(Math.random()*6)];
          c.style.left = Math.random()*100 + 'vw';
          c.style.animationDuration = (3+Math.random()*2)+'s';
          cel.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i*40);
      }
    }

    // å¯åŠ¨
    updateStep();
  </script>
</body>
</html>

