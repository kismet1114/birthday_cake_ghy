<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      -webkit-touch-callout: none;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
    }

    h1 {
      color: #d32f2f;
      font-size: 28px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
      letter-spacing: 2px;
    }

    /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.3s;
    }
    .step-dot.active {
      background: #e91e63;
      width: 30px;
      border-radius: 5px;
    }
    .step-dot.completed {
      background: #c44569;
    }

    /* åŒæ å¸ƒå±€ */
    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    /* å·¦è¾¹æŒ‡å¼•åŒº */
    .guide-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      position: relative;
    }

    .guide-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .guide-image {
      width: 100%;
      max-width: 300px;
      height: 300px;
      object-fit: contain;
      border-radius: 16px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
      transition: all 0.5s;
      pointer-events: none;
    }

    .guide-text {
      margin-top: 15px;
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }

    /* å³è¾¹å·¥ä½œåŒº */
    .work-panel {
      background: linear-gradient(135deg, #ffffff, #fff9fc);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px dashed rgba(255, 107, 157, 0.4);
      position: relative;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .work-label {
      display: inline-block;
      background: #ff6b9d;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .instruction-hint {
      font-size: 13px;
      color: #999;
      font-weight: normal;
      margin-top: 5px;
    }

    /* è›‹ç³•å·¥ä½œåŒº */
    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(255,249,252,0.5));
      border-radius: 16px;
      overflow: hidden; /* é˜²æ­¢è£…é¥°æº¢å‡º */
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      transition: transform 0.3s;
      z-index: 1;
      pointer-events: none; /* é˜²æ­¢å›¾ç‰‡è¢«æ‹–æ‹½ */
      -webkit-user-drag: none; /* ç¦æ­¢æ‹–æ‹½å›¾ç‰‡ */
    }

    /* è“¬æ¾åŠ¨ç”» */
    .cake-base-img.squashed {
      transform: scaleY(0.9) scaleX(1.05);
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* è£…é¥°å±‚ä¸é˜»æŒ¡ç‚¹å‡» */
      z-index: 10;
    }

    /* å¥¶æ²¹ - çº¯ç™½è‰²å°åœ†ç‚¹ */
    .cream-drop {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle at 30% 30%, #ffffff, #f5f5f5);
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      pointer-events: none;
      animation: creamPop 0.3s ease-out;
      /* ç¡®ä¿é€æ˜èƒŒæ™¯ */
      background-color: transparent;
    }

    @keyframes creamPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* æ°´æœ - åªä¿ç•™4ç§ */
    .falling-fruit {
      position: absolute;
      font-size: 24px;
      animation: fruitDrop 0.6s ease-out forwards;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      z-index: 15;
      /* å…³é”®ï¼šç¡®ä¿emojiæ²¡æœ‰èƒŒæ™¯è‰² */
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      pointer-events: none;
      line-height: 1;
    }

    @keyframes fruitDrop {
      0% { transform: translateY(-50px) rotate(-180deg) scale(0.5); opacity: 0; }
      60% { transform: translateY(10px) rotate(10deg) scale(1.1); opacity: 1; }
      100% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
    }

    /* ç¬¬å…­æ­¥æ‹–æ‹½çš„è£…é¥°emoji */
    .decoration-emoji {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      animation: emojiPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      cursor: grab;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      /* å…³é”®ï¼šç¡®ä¿æ²¡æœ‰èƒŒæ™¯è‰² */
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      pointer-events: none; /* è£…é¥°ä¸é˜»æŒ¡ */
      line-height: 1;
    }

    @keyframes emojiPop {
      0% { transform: scale(0) rotate(-90deg); opacity: 0; }
      70% { transform: scale(1.2) rotate(10deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    /* èœ¡çƒ› - 0.75å€å¤§å° (48px) */
    .candle {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      z-index: 20;
      transition: transform 0.2s;
      animation: candlePlace 0.3s ease-out;
      /* å…³é”®ï¼šç¡®ä¿emojièœ¡çƒ›æ²¡æœ‰èƒŒæ™¯ */
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      pointer-events: auto; /* èœ¡çƒ›å¯ä»¥ç‚¹å‡»ç‚¹ç‡ƒ */
      line-height: 1;
    }

    @keyframes candlePlace {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .candle:hover {
      transform: scale(1.1);
    }

    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }

    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    /* Emoji é¢æ¿ */
    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      width: 100%;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white; /* é¢æ¿é‡Œçš„emojiæœ‰èƒŒæ™¯æ˜¯æ­£å¸¸çš„ï¼Œä¸ºäº†å¯ç‚¹å‡»åŒºåŸŸ */
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.2s;
      /* é˜²æ­¢è¢«é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      border: 2px solid transparent;
    }

    .emoji-item:hover {
      transform: translateY(-3px) scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      border-color: rgba(255, 107, 157, 0.3);
    }

    .emoji-item:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    /* æŒ‰é’®ç»„ */
    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
      /* é˜²æ­¢æŒ‰é’®è¢«é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(211,47,47,0.4);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    /* è“¬æ¾åº¦æŒ‡ç¤º */
    .fluff-meter {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 12px;
      color: #e91e63;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 30;
      pointer-events: none;
    }

    .fluff-bar {
      width: 80px;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }

    .fluff-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9e, #fecfef);
      width: 0%;
      transition: width 0.3s;
    }

    /* ç»“æœé¡µ - å·¦å³å¯¹æ¯” */
    .result-page {
      display: none;
      animation: fadeIn 1s ease;
    }

    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    @media (max-width: 768px) {
      .result-compare {
        grid-template-columns: 1fr;
      }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .result-label {
      font-family: 'ZCOOL KuaiLe', cursive;
      color: #e91e63;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .final-cake-display {
      width: 100%;
      max-width: 300px;
      height: 300px;
      margin: 0 auto;
      position: relative;
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 16px;
      overflow: hidden;
    }

    .final-cake-display img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3, #54a0ff);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
    }

    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }

    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* ç²’å­æ•ˆæœ */
    .particle {
      position: absolute;
      pointer-events: none;
      z-index: 50;
      animation: particleFly 0.8s ease-out forwards;
    }

    @keyframes particleFly {
      0% { transform: translate(0,0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
    }

    /* éŸ³æ•ˆå¼€å…³æç¤º */
    .sound-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: #666;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    /* æ‹–æ‹½æ—¶çš„å¹½çµå…ƒç´  */
    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      /* ç¡®ä¿æ‹–æ‹½æ—¶æ²¡æœ‰èƒŒæ™¯ */
      background: transparent !important;
      background-color: transparent !important;
      border: none !important;
      outline: none !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="sound-hint" id="soundHint" onclick="initAudio()">
    <span>ğŸ”Š</span> ç‚¹å‡»ä»»æ„å¤„å¼€å¯éŸ³æ•ˆ
  </div>

  <div class="main-container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>
    
    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <!-- å·¦è¾¹æŒ‡å¼•åŒº -->
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">
          é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾
        </div>
      </div>

      <!-- å³è¾¹å·¥ä½œåŒº -->
      <div class="work-panel">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        
        <div class="instruction-text" id="instruction">
          ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼
          <div class="instruction-hint">æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡å‹æ‰ï¼Œæ¾å¼€å›å¼¹</div>
        </div>

        <div class="cake-workspace" id="cakeArea">
          <div class="fluff-meter" id="fluffMeter" style="display: none;">
            è“¬æ¾åº¦
            <div class="fluff-bar">
              <div class="fluff-fill" id="fluffFill"></div>
            </div>
          </div>
          <!-- ç¬¬å…­æ­¥æ—¶è¿™é‡Œåº”è¯¥æ˜¾ç¤ºè›‹ç³•åº•å›¾ï¼Œä¸Šé¢å åŠ è£…é¥° -->
          <img src="images/1.jpg" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•" draggable="false">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½®æœ¬æ­¥ â†©ï¸</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <!-- ç»“æœé¡µ -->
  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="font-family: 'ZCOOL KuaiLe', cursive; color: #d32f2f; font-size: 32px; text-align: center;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    
    <div class="result-compare">
      <div class="result-box">
        <div class="result-label">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-display" id="playerCake"></div>
      </div>
      <div class="result-box">
        <div class="result-label">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div class="final-cake-display">
          <img src="images/6.jpg" alt="æˆå“è›‹ç³•">
        </div>
      </div>
    </div>

    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>

    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>

  <script>
    // éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆä¿æŒä¸å˜ï¼‰
    let audioCtx = null;
    let soundEnabled = false;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        soundEnabled = true;
        const hint = document.getElementById('soundHint');
        if (hint) hint.style.display = 'none';
      }
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    function playSound(type) {
      if (!soundEnabled || !audioCtx) return;
      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      
      const now = audioCtx.currentTime;
      
      switch(type) {
        case 'pop':
          osc.type = 'sine';
          osc.frequency.setValueAtTime(600, now);
          osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
          break;
        case 'complete':
          [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
            const oscC = audioCtx.createOscillator();
            const gainC = audioCtx.createGain();
            oscC.connect(gainC);
            gainC.connect(audioCtx.destination);
            oscC.type = 'sine';
            oscC.frequency.value = freq;
            gainC.gain.setValueAtTime(0, now + i * 0.1);
            gainC.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.05);
            gainC.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.5);
            oscC.start(now + i * 0.1);
            oscC.stop(now + i * 0.1 + 0.5);
          });
          break;
      }
    }

    // æ­¥éª¤é…ç½®
    const steps = [
      { guide: 'images/1.jpg', work: 'images/1.jpg', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', hint: 'æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡å‹æ‰ï¼Œæ¾å¼€å›å¼¹', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff' },
      { guide: 'images/2.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹', hint: 'æŒ‰ä½å¹¶æ‹–åŠ¨é¼ æ ‡ï¼ŒåƒæŒ¤å¥¶æ²¹ä¸€æ ·', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/2.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æ°´æœè£…é¥°', hint: 'ç‚¹å‡»ä»»æ„ä½ç½®æ·»åŠ æ°´æœï¼ˆè‰è“ã€æ¨±æ¡ƒã€è“è“ã€è‘¡è„ï¼‰', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•ï¼Œè®©è‰²å½©æ›´ä¸°å¯Œ', action: 'fruit' },
      { guide: 'images/4.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å››æ­¥ï¼šæ’ä¸Šç”Ÿæ—¥èœ¡çƒ›', hint: 'ç‚¹å‡»æ·»åŠ èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼Œæœ€å¤šå¯ä»¥æ”¾5æ ¹å“¦', action: 'candle' },
      { guide: 'images/5.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹ç‡ƒèœ¡çƒ›ï¼', hint: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', guideText: 'ç‚¹äº®èœ¡çƒ›ï¼Œå‡†å¤‡å”±ç”Ÿæ—¥æ­Œ', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šè‡ªç”±è£…é¥° & å®Œæˆï¼', hint: 'æ‹–æ‹½ä¸‹æ–¹è¡¨æƒ…è£…é¥°è›‹ç³•ï¼Œç„¶åç‚¹å‡»å®Œæˆ', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];
    
    const guideImage = document.getElementById('guideImage');
    const workImage = document.getElementById('workImage');
    const guideText = document.getElementById('guideText');
    const instruction = document.getElementById('instruction');
    const cakeArea = document.getElementById('cakeArea');
    const decorLayer = document.getElementById('decorationsLayer');
    const fluffMeter = document.getElementById('fluffMeter');
    const fluffFill = document.getElementById('fluffFill');
    const emojiPalette = document.getElementById('emojiPalette');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const finishBtn = document.getElementById('finishBtn');

    const emojis = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­'];

    document.addEventListener('click', initAudio, { once: true });
    document.addEventListener('touchstart', initAudio, { once: true });

    function init() {
      updateStep();
    }

    function updateStep() {
      const step = steps[currentStep];
      
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.classList.remove('active', 'completed');
        if (idx < currentStep) dot.classList.add('completed');
        if (idx === currentStep) dot.classList.add('active');
      });

      guideImage.src = step.guide;
      guideText.textContent = step.guideText;
      
      workImage.src = step.work;
      workImage.style.display = 'block';
      
      instruction.innerHTML = `${step.instruction}<div class="instruction-hint">${step.hint}</div>`;
      
      resetInteractions();
      
      if (currentStep === 0) {
        fluffMeter.style.display = 'block';
        setupFluffInteraction();
      } else {
        fluffMeter.style.display = 'none';
      }
      
      if (currentStep === 1) setupCreamInteraction();
      if (currentStep === 2) setupFruitInteraction();
      if (currentStep === 3) setupCandleInteraction();
      if (currentStep === 4) setupLightInteraction();
      if (currentStep === 5) setupDecorateInteraction();
      
      if (currentStep === 5) {
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'inline-block';
        resetBtn.style.display = 'inline-block';
        emojiPalette.style.display = 'flex';
        createEmojiPalette();
      } else {
        nextBtn.style.display = 'inline-block';
        finishBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        emojiPalette.style.display = 'none';
      }
    }

    function resetInteractions() {
      cakeArea.onmousedown = null;
      cakeArea.onmousemove = null;
      cakeArea.onmouseup = null;
      cakeArea.onmouseleave = null;
      cakeArea.ontouchstart = null;
      cakeArea.ontouchmove = null;
      cakeArea.ontouchend = null;
      cakeArea.onclick = null;
    }

    // å¿«é€Ÿç®€åŒ–ç‰ˆäº¤äº’å‡½æ•°ï¼ˆçœç•¥è¯¦ç»†å®ç°ä»¥ä¿æŒç¤ºä¾‹ç®€æ´ï¼‰
    function setupFluffInteraction() {/*...*/}
    function setupCreamInteraction() {
      isDrawing = false;
      let lastTime = 0;
      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const now = Date.now();
        if (now - lastTime < 50) return;
        lastTime = now;
        const rect = cakeArea.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        const cream = document.createElement('div');
        cream.className = 'cream-drop';
        cream.style.left = (x - 5) + 'px';
        cream.style.top = (y - 5) + 'px';
        decorLayer.appendChild(cream);
        decorations.push(cream);
      };
      cakeArea.onmousedown = () => isDrawing = true;
      cakeArea.onmousemove = draw;
      cakeArea.onmouseup = () => isDrawing = false;
      cakeArea.onmouseleave = () => isDrawing = false;
      cakeArea.ontouchstart = (e) => { e.preventDefault(); isDrawing = true; };
      cakeArea.ontouchmove = (e) => { e.preventDefault(); draw(e); };
      cakeArea.ontouchend = () => isDrawing = false;
    }
    function setupFruitInteraction() {
      const fruits = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ‡'];
      cakeArea.onclick = (e) => {
        const rect = cakeArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const fruit = document.createElement('div');
        fruit.className = 'falling-fruit';
        fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
        fruit.style.left = (x - 12) + 'px';
        fruit.style.top = (y - 12) + 'px';
        decorLayer.appendChild(fruit);
        decorations.push(fruit);
        playSound('pop');
      };
    }
    function setupCandleInteraction() {
      candleCount = 0;
      cakeArea.onclick = (e) => {
        if (candleCount >= 5) return;
        const rect = cakeArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const candle = document.createElement('div');
        candle.className = 'candle';
        candle.textContent = 'ğŸ•¯ï¸';
        candle.style.left = (x - 24) + 'px';
        candle.style.top = (y - 48) + 'px';
        decorLayer.appendChild(candle);
        decorations.push(candle);
        candleCount++;
        playSound('pop');
      };
    }
    function setupLightInteraction() {
      cakeArea.onclick = (e) => {
        const candles = decorLayer.querySelectorAll('.candle:not(.lit)');
        if (candles.length === 0) {
          if (candleCount > 0) nextStep();
          return;
        }
        const rect = cakeArea.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        candles.forEach(candle => {
          const cx = parseFloat(candle.style.left) + 24;
          const cy = parseFloat(candle.style.top) + 48;
          const dist = Math.hypot(clickX - cx, clickY - cy);
          if (dist < 60) {
            candle.classList.add('lit');
            playSound('pop');
            if (candles.length === 1) setTimeout(nextStep, 1000);
          }
        });
      };
    }
    function setupDecorateInteraction() {
      // ç¬¬å…­æ­¥ä¿æŒä¹‹å‰æ‰€æœ‰çš„è£…é¥°ï¼Œæ·»åŠ æ‹–æ‹½åŠŸèƒ½
    }

    function createEmojiPalette() {
      emojiPalette.innerHTML = '';
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        item.dataset.emoji = emoji;
        
        const startDrag = (clientX, clientY, emojiChar) => {
          const ghost = document.createElement('div');
          ghost.className = 'dragging-ghost';
          ghost.textContent = emojiChar;
          ghost.style.left = (clientX - 18) + 'px';
          ghost.style.top = (clientY - 18) + 'px';
          document.body.appendChild(ghost);
          playSound('pop');
          
          const moveHandler = (e) => {
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);
            if (x && y) {
              ghost.style.left = (x - 18) + 'px';
              ghost.style.top = (y - 18) + 'px';
            }
          };
          
          const endHandler = (e) => {
            const x = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const y = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            const rect = cakeArea.getBoundingClientRect();
            
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
              const el = document.createElement('div');
              el.className = 'decoration-emoji';
              el.textContent = emojiChar;
              el.style.left = (x - rect.left - 14) + 'px';
              el.style.top = (y - rect.top - 14) + 'px';
              decorLayer.appendChild(el);
              decorations.push(el);
              playSound('pop');
            }
            
            ghost.remove();
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('mouseup', endHandler);
            document.removeEventListener('touchend', endHandler);
          };
          
          document.addEventListener('mousemove', moveHandler);
          document.addEventListener('touchmove', moveHandler, { passive: false });
          document.addEventListener('mouseup', endHandler);
          document.addEventListener('touchend', endHandler);
        };
        
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startDrag(e.clientX, e.clientY, emoji);
        });
        
        item.addEventListener('touchstart', (e) => {
          e.preventDefault();
          if (e.touches[0]) {
            startDrag(e.touches[0].clientX, e.touches[0].clientY, emoji);
          }
        }, { passive: false });
        
        emojiPalette.appendChild(item);
      });
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        playSound('pop');
        updateStep();
      }
    }

    function resetStep() {
      decorLayer.innerHTML = '';
      decorations = [];
      candleCount = 0;
      playSound('pop');
      updateStep();
    }

    function finish() {
      playSound('complete');
      const playerCake = document.getElementById('playerCake');
      const clone = cakeArea.cloneNode(true);
      clone.style.width = '100%';
      clone.style.height = '100%';
      playerCake.innerHTML = '';
      playerCake.appendChild(clone);
      
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      
      // ç®€å•çš„åº†ç¥å½©çº¸
      const celebration = document.getElementById('celebration');
      const symbols = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'âœ¨', 'ğŸ’–'];
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = symbols[Math.floor(Math.random() * symbols.length)];
          c.style.left = Math.random() * 100 + 'vw';
          c.style.animationDuration = (3 + Math.random() * 2) + 's';
          c.style.fontSize = (20 + Math.random() * 20) + 'px';
          celebration.appendChild(c);
          setTimeout(() => c.remove(), 4000);
        }, i * 50);
      }
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>