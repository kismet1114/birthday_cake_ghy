<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
      position: relative;
      transition: all 0.5s;
    }

    .main-container.candle-lit {
      box-shadow: 0 10px 60px rgba(255, 150, 50, 0.3), inset 0 0 100px rgba(255, 200, 100, 0.1);
      border: 2px solid rgba(255, 200, 100, 0.3);
    }

    h1 {
      color: #d32f2f;
      font-size: 32px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      position: relative;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
    }

    .step-dot.active { 
      background: #e91e63; 
      width: 35px; 
      border-radius: 15px;
    }

    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace { grid-template-columns: 1fr; }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      transition: all 0.5s;
    }

    .work-panel.candle-glow {
      box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2);
      border-color: rgba(255, 200, 100, 0.5);
      animation: warmPulse 2s ease-in-out infinite;
    }

    @keyframes warmPulse {
      0%, 100% { box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2); }
      50% { box-shadow: 0 0 70px rgba(255, 160, 60, 0.6), inset 0 0 40px rgba(255, 200, 120, 0.3); }
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .guide-image {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: contain;
      border-radius: 16px;
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active { display: block; }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.3s;
    }

    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.5);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
      transition: all 0.5s;
    }

    .cake-workspace.fluff-cursor {
      cursor: url('images/8.png') 16 16, grab;
    }

    @media (pointer: coarse) {
      .cake-workspace.fluff-cursor {
        cursor: grab;
      }
    }

    .cake-workspace.candle-ambiance {
      box-shadow: 0 0 60px rgba(255, 150, 50, 0.5), inset 0 0 40px rgba(255, 200, 100, 0.3);
      animation: cakeGlow 1.5s ease-in-out infinite alternate;
    }

    @keyframes cakeGlow {
      from { box-shadow: 0 0 40px rgba(255, 140, 40, 0.4), inset 0 0 30px rgba(255, 190, 90, 0.2); }
      to { box-shadow: 0 0 80px rgba(255, 170, 70, 0.7), inset 0 0 50px rgba(255, 210, 130, 0.4); }
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.2s;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .cream-flower {
      position: absolute;
      width: 96px;
      height: 96px;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s ease-out forwards;
    }

    .cream-flower img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      width: 30px;
      height: 30px;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s ease-out forwards;
    }

    .static-fruit.strawberry {
      width: 39px;
      height: 39px;
    }

    .static-fruit.medium {
      width: 48px;
      height: 48px;
    }

    .static-fruit img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      width: 48px;
      height: 48px;
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .candle img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji, .decoration-img {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
    }

    .decoration-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    /* q_hanyu.png 1.7å€å¤§å° (85px) */
    .decoration-img.qhanyu-large {
      width: 85px;
      height: 85px;
    }

    /* Q_ghy2.png 50px */
    .decoration-img.qghy2 {
      width: 50px;
      height: 50px;
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 150px;
      overflow-y: auto;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
      overflow: hidden;
      position: relative;
    }

    .emoji-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .emoji-item:hover { 
      transform: translateY(-3px) scale(1.1); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page { display: none; animation: fadeIn 1s; }
    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    @media (max-width: 768px) {
      .result-compare { grid-template-columns: 1fr; }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    .dragging-ghost img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    /* q_hanyu æ‹–æ‹½å¹½çµ 1.7å€ */
    .dragging-ghost.qhanyu-large img {
      width: 85px;
      height: 85px;
    }

    /* Q_ghy2 æ‹–æ‹½å¹½çµ 50px */
    .dragging-ghost.qghy2 img {
      width: 50px;
      height: 50px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .fluff-popup {
      position: absolute;
      color: #e91e63;
      font-weight: bold;
      font-size: 20px;
      pointer-events: none;
      z-index: 100;
      animation: floatUp 1s ease-out forwards;
      font-family: 'ZCOOL KuaiLe', cursive;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
    }

    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.5); opacity: 0; }
      20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
      100% { transform: translateY(-60px) scale(1); opacity: 0; }
    }

    .save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3000;
    }
    .save-indicator.show { opacity: 1; }

    .hover-preview {
      position: fixed;
      pointer-events: none;
      z-index: 999;
      opacity: 0.5;
      transform: translate(-50%, -50%);
      font-size: 28px;
      transition: opacity 0.1s;
    }

    .hover-preview img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .continue-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #e91e63;
      color: #e91e63;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      display: none;
      z-index: 100;
    }
    .continue-btn:hover {
      background: #e91e63;
      color: white;
    }
  </style>
<base target="_blank">
</head>
<body>
  <div class="main-container" id="makeStage">
    <button class="continue-btn" id="continueBtn" onclick="loadProgress()">ğŸ“‚ ç»§ç»­ä¸Šæ¬¡åˆ¶ä½œ</button>
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>

    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel" id="guidePanel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" style="position: relative;" id="workPanel">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <div class="cake-workspace fluff-cursor" id="cakeArea">
          <img src="images/7.png" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

        <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="saveCakeImage()" id="saveImageBtn" style="display: none; background: linear-gradient(135deg, #4CAF50, #2E7D32);">ğŸ“· ä¿å­˜è›‹ç³•å›¾ç‰‡</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>

  </div>  

  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="text-align: center; color: #d32f2f; font-family: 'ZCOOL KuaiLe', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare" style="grid-template-columns: 1fr; max-width: 500px; margin: 30px auto;">
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div style="position: relative; width: 100%; height: 350px; background: #fff9fc; border-radius: 16px;">
          <img src="images/6.jpg" alt="æˆå“" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
      </div>
    </div>
  </div>
  
  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>
  <div class="save-indicator" id="saveIndicator">ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜</div>
  <div class="hover-preview" id="hoverPreview"></div>

  <script>
    // éŸ³é¢‘ç®¡ç†
    const AudioManager = {
      cream: null,
      bg: null,
      fluff: null,
      initialized: false,

      init() {
        try {
          this.cream = new Audio('music/cream.mp3');
          this.bg = new Audio('music/new.mp3');
          this.fluff = new Audio('music/fluff.mp3');
          this.initialized = true;
        } catch(e) {
          console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥');
        }
      },

      playFluff() {
        if (!this.initialized) return;
        try {
          const audio = this.fluff && this.fluff.src ? this.fluff.cloneNode() : 
                       (this.cream && this.cream.src ? this.cream.cloneNode() : null);
          if (!audio) return;
          audio.playbackRate = 2.0 + Math.random() * 0.2;
          audio.volume = 2.0;
          audio.play().catch(() => {});
        } catch(e) {}
      },

      playFruit() {
        if (!this.initialized || !this.cream) return;
        try {
          const audio = this.cream.cloneNode();
          audio.playbackRate = 1.5;
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch(e) {}
      }
    };
    AudioManager.init();

    // æ­¥éª¤é…ç½® - ç¬¬3æ­¥åŠä¹‹åä½¿ç”¨ creamcake.jpg
    const steps = [
      { guide: 'images/1.jpg', work: 'images/7.png', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: 'images/2.jpg', work: 'images/7.png', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true, clearCream: true },
      { guide: 'images/4.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: 'images/5.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];
    let hasLitCandle = false;

    // æ‹æ‰“æç¤ºè¯­æ•°ç»„
    const fluffMessages = [
      'è“¬æ¾åº¦ +1',
      'è›‹ç³•èƒšå˜æ¾è½¯äº†ï½',
      'æ‰‹æ„Ÿè¶Šæ¥è¶Šå¥½äº†ï¼',
      'ç»§ç»­æ‹ï¼Œæ›´è“¬æ¾âœ¨',
      'è›‹ç³•èƒšå¿«è¦è“¬æ¾äº†',
      'å·²ç»å¾ˆå®Œç¾äº†ï¼',
      'è›‹ç³•è“¬æ¾çš„è¦é£èµ·æ¥äº†ğŸˆ',
      'æ¾è½¯åº¦UPï¼'
    ];

    const emojis = ['ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­', 'ğŸ±', 'ğŸ€'];
    const fruits = ['images/blue.png', 'images/lemon.png', 'images/strawberry.png'];
    const mediumFruits = ['images/blue.png', 'images/lemon.png'];
    const largeFruits = ['images/strawberry.png'];

    // å›¾ç‰‡é…ç½®ï¼šq_hanyu 1.7å€(85px)ï¼ŒQ_ghy2 50px
    const extraImages = [
      { src: 'images/fox2.png', name: 'fox2', scale: 1 },
      { src: 'images/Q_ghy2.png', name: 'qghy2', scale: 1 },  // 50px
      { src: 'images/q_hanyu.png', name: 'qhanyu', scale: 1.7 }, // 85px
      { src: 'images/fox.png', name: 'fox', scale: 1 }
    ];

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    function saveProgress() {
      const data = {
        currentStep,
        fluffiness,
        candleCount,
        hasLitCandle,
        html: document.getElementById('decorationsLayer').innerHTML,
        timestamp: new Date().toLocaleString()
      };
      localStorage.setItem('cakeProgress', JSON.stringify(data));
      showSaveIndicator();
    }

    function loadProgress() {
      const saved = localStorage.getItem('cakeProgress');
      if (saved) {
        const data = JSON.parse(saved);
        currentStep = data.currentStep;
        fluffiness = data.fluffiness || 0;
        candleCount = data.candleCount || 0;
        hasLitCandle = data.hasLitCandle || false;

        if (data.html) {
          document.getElementById('decorationsLayer').innerHTML = data.html;
          rebindDecorations();
        }

        updateStep();

        if (hasLitCandle) {
          applyCandleAmbiance();
        }

        showToast(`å·²æ¢å¤ ${data.timestamp} çš„åˆ¶ä½œè¿›åº¦`);
        document.getElementById('continueBtn').style.display = 'none';
      }
    }

    function rebindDecorations() {
      decorations = [];
      const decorEls = document.getElementById('decorationsLayer').children;
      for (let el of decorEls) {
        let step = 0;
        if (el.classList.contains('cream-flower')) step = 1;
        else if (el.classList.contains('static-fruit')) step = 2;
        else if (el.classList.contains('candle')) step = 3;
        else if (el.classList.contains('decoration-emoji') || el.classList.contains('decoration-img')) step = 5;
        decorations.push({ step, el });
      }
    }

    function checkSavedProgress() {
      const saved = localStorage.getItem('cakeProgress');
      if (saved) {
        document.getElementById('continueBtn').style.display = 'block';
      }
    }

    function applyCandleAmbiance() {
      document.getElementById('makeStage').classList.add('candle-lit');
      document.getElementById('workPanel').classList.add('candle-glow');
      document.getElementById('cakeArea').classList.add('candle-ambiance');
    }

    function removeCandleAmbiance() {
      document.getElementById('makeStage').classList.remove('candle-lit');
      document.getElementById('workPanel').classList.remove('candle-glow');
      document.getElementById('cakeArea').classList.remove('candle-ambiance');
    }

    function showFluffPopupWithMessage(x, y, message) {
      const popup = document.createElement('div');
      popup.className = 'fluff-popup';
      popup.textContent = message;
      popup.style.left = x + 'px';
      popup.style.top = y + 'px';
      document.getElementById('cakeArea').appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    function updateStep() {
      const step = steps[currentStep];

      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + (idx < currentStep ? ' completed' : '') + (idx === currentStep ? ' active' : '');
      });

      document.getElementById('guideImage').src = step.guide;
      document.getElementById('workImage').src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;

      const pbar = document.getElementById('progressBar');
      pbar.style.display = step.hasProgress ? 'block' : 'none';
      updateProgressDisplay();

      setupStepInteraction();

      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';

            if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('saveImageBtn').style.display = 'inline-block';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'flex';
        createEmojiPalette();
      } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('saveImageBtn').style.display = 'none';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'none';
      }

      if (currentStep !== 4 && !hasLitCandle) {
        removeCandleAmbiance();
      }

      if (step.clearCream) {
        clearCreamTraces();
      }
    }

    function clearCreamTraces() {
      const decorLayer = document.getElementById('decorationsLayer');
      const creams = decorLayer.querySelectorAll('.cream-flower');
      creams.forEach(cream => cream.remove());
      decorations = decorations.filter(d => d.step !== 1);
    }

    function setupStepInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const workImage = document.getElementById('workImage');
      const decorLayer = document.getElementById('decorationsLayer');
      const step = steps[currentStep];

      cakeArea.onmousedown = null;
      cakeArea.onmousemove = null;
      cakeArea.onmouseup = null;
      cakeArea.onmouseleave = null;
      cakeArea.onclick = null;
      cakeArea.ontouchstart = null;
      cakeArea.ontouchmove = null;
      cakeArea.ontouchend = null;

      cakeArea.classList.remove('fluff-cursor');
      cakeArea.style.cursor = 'default';

      if (step.action === 'fluff') {
        let pressing = false;
        let interval;
        let lastMsgIndex = -1;

        cakeArea.classList.add('fluff-cursor');

        const startFluff = (e) => {
          e.preventDefault();
          pressing = true;
          workImage.style.transform = 'scale(0.95, 1.05)';

          AudioManager.playFluff();

          const rect = cakeArea.getBoundingClientRect();
          const clientX = e.clientX || (e.touches && e.touches[0].clientX);
          const clientY = e.clientY || (e.touches && e.touches[0].clientY);
          const x = clientX - rect.left;
          const y = clientY - rect.top;

          let msgIndex;
          do {
            msgIndex = Math.floor(Math.random() * fluffMessages.length);
          } while (msgIndex === lastMsgIndex && fluffMessages.length > 1);
          lastMsgIndex = msgIndex;

          showFluffPopupWithMessage(x - 40, y - 40, fluffMessages[msgIndex]);

          interval = setInterval(() => {
            if (fluffiness < 50) {
              fluffiness = Math.min(fluffiness + 2, 50);
              updateProgressDisplay();

              if (fluffiness % 5 === 0 && fluffiness < 50) {
                AudioManager.playFluff();
                let newMsgIndex;
                do {
                  newMsgIndex = Math.floor(Math.random() * fluffMessages.length);
                } while (newMsgIndex === lastMsgIndex);
                lastMsgIndex = newMsgIndex;
                showFluffPopupWithMessage(x - 40 + (Math.random() * 20 - 10), y - 40 + (Math.random() * 20 - 10), fluffMessages[newMsgIndex]);
              }
            }

            if (fluffiness >= 50) {
              clearInterval(interval);
              showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
              saveProgress();
              setTimeout(nextStep, 500);
            }
          }, 100);
        };

        const endFluff = () => {
          pressing = false;
          clearInterval(interval);
          workImage.style.transform = 'scale(1)';
        };

        cakeArea.onmousedown = startFluff;
        cakeArea.ontouchstart = startFluff;
        cakeArea.onmouseup = endFluff;
        cakeArea.onmouseleave = endFluff;
        cakeArea.ontouchend = endFluff;
      }

      else if (step.action === 'cream') {
        cakeArea.style.cursor = 'crosshair';
        let lastX = 0;
        let lastY = 0;
        let isPressed = false;

        const addCreamAt = (x, y) => {
          AudioManager.playFluff();

          const cream = document.createElement('div');
          cream.className = 'cream-flower';
          cream.innerHTML = `<img src="images/cream.png" alt="cream">`;
          cream.style.left = (x - 48) + 'px';
          cream.style.top = (y - 48) + 'px';

          const speed = Math.min(10, Math.abs(x - lastX) + Math.abs(y - lastY));
          const scale = 0.9 + Math.random() * 0.2 - (speed * 0.01);
          const rotation = (Math.random() - 0.5) * 30 * (speed / 5);
          cream.style.transform = `scale(${scale}) rotate(${rotation}deg)`;

          decorLayer.appendChild(cream);
          trackDecoration(cream);

          const creams = decorLayer.querySelectorAll('.cream-flower');
          if (creams.length % 10 === 0) {
            saveProgress();
          }

          if (creams.length > 200) {
            creams[0].remove();
          }
        };

        cakeArea.onmousedown = (e) => {
          e.preventDefault();
          isPressed = true;
          const rect = cakeArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          lastX = x;
          lastY = y;
          addCreamAt(x, y);
        };

        cakeArea.onmousemove = (e) => {
          if (!isPressed) return;
          e.preventDefault();

          const rect = cakeArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const dx = x - lastX;
          const dy = y - lastY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance > 10) {
            const steps = Math.ceil(distance / 10);

            for (let i = 0; i < steps; i++) {
              const t = (i + 1) / steps;
              const ix = lastX + dx * t;
              const iy = lastY + dy * t;
              addCreamAt(ix, iy);
            }

            lastX = x;
            lastY = y;
          }
        };

        const stopDrawing = () => {
          if (isPressed) {
            isPressed = false;
            saveProgress();
          }
        };

        cakeArea.onmouseup = stopDrawing;
        cakeArea.onmouseleave = stopDrawing;

        cakeArea.ontouchstart = (e) => {
          e.preventDefault();
          isPressed = true;
          const touch = e.touches[0];
          const rect = cakeArea.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;
          lastX = x;
          lastY = y;
          addCreamAt(x, y);
        };

        cakeArea.ontouchmove = (e) => {
          e.preventDefault();
          if (!isPressed) return;

          const touch = e.touches[0];
          const rect = cakeArea.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;

          const dx = x - lastX;
          const dy = y - lastY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance > 10) {
            const steps = Math.ceil(distance / 10);
            for (let i = 0; i < steps; i++) {
              const t = (i + 1) / steps;
              const ix = lastX + dx * t;
              const iy = lastY + dy * t;
              addCreamAt(ix, iy);
            }
            lastX = x;
            lastY = y;
          }
        };

        cakeArea.ontouchend = stopDrawing;
      }

      else if (step.action === 'fruit') {
        cakeArea.style.cursor = 'copy';
        let count = 0;

        cakeArea.onclick = (e) => {
          AudioManager.playFruit();

          const rect = cakeArea.getBoundingClientRect();
          const fruit = document.createElement('div');
          fruit.className = 'static-fruit';

          const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
          fruit.innerHTML = `<img src="${randomFruit}" alt="fruit">`;

          let offset = 15;
          if (randomFruit.includes('strawberry')) {
            fruit.classList.add('strawberry');
            offset = 19.5;
          } else {
            fruit.classList.add('medium');
            offset = 24;
          }

          fruit.style.left = (e.clientX - rect.left - offset) + 'px';
          fruit.style.top = (e.clientY - rect.top - offset) + 'px';

          const rotation = Math.random() * 360;
          setTimeout(() => {
            fruit.style.transform = `rotate(${rotation}deg)`;
          }, 500);

          decorLayer.appendChild(fruit);
          trackDecoration(fruit);
          count++;
          updateProgressDisplay(count, 10);

          saveProgress();
        };
      }

      else if (step.action === 'candle') {
        cakeArea.style.cursor = 'pointer';
        candleCount = 0;
        updateProgressDisplay(0, 5);

        cakeArea.onclick = (e) => {
          if (candleCount >= 5) {
            showToast('æœ€å¤šåªèƒ½æ’5æ ¹èœ¡çƒ›ï¼');
            return;
          }
          const rect = cakeArea.getBoundingClientRect();
          const candle = document.createElement('div');
          candle.className = 'candle';
          candle.innerHTML = `<img src="images/candle.png" alt="candle">`;
          candle.style.left = (e.clientX - rect.left - 24) + 'px';
          candle.style.top = (e.clientY - rect.top - 48) + 'px';
          decorLayer.appendChild(candle);
          trackDecoration(candle);
          candleCount++;
          updateProgressDisplay(candleCount, 5);

          saveProgress();

          if (candleCount === 5) {
            showToast('èœ¡çƒ›æ’æ»¡äº†ï¼Œå‡†å¤‡ç‚¹ç‡ƒï¼');
            setTimeout(nextStep, 800);
          }
        };
      }

      else if (step.action === 'light') {
        cakeArea.style.cursor = 'pointer';

        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;

          const candles = decorLayer.querySelectorAll('.candle:not(.lit)');
          if (candles.length === 0 && candleCount > 0) {
            nextStep();
            return;
          }

          let litNew = false;
          candles.forEach(candle => {
            const cx = parseFloat(candle.style.left) + 24;
            const cy = parseFloat(candle.style.top) + 24;
            if (Math.hypot(clickX - cx, clickY - cy) < 60) {
              if (!candle.classList.contains('lit')) {
                candle.classList.add('lit');
                litNew = true;

                AudioManager.playFluff();

                for (let i = 0; i < 6; i++) {
                  const spark = document.createElement('div');
                  spark.style.cssText = `position: absolute; left: ${cx}px; top: ${cy}px; width: 4px; height: 4px; background: #ffd93d; border-radius: 50%; pointer-events: none; z-index: 30;`;
                  decorLayer.appendChild(spark);
                  const angle = (Math.PI * 2 / 6) * i;
                  const dist = 30;
                  spark.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`, opacity: 0 }
                  ], { duration: 600, easing: 'ease-out' }).onfinish = () => spark.remove();
                }
              }
            }
          });

          if (litNew && !hasLitCandle) {
            hasLitCandle = true;
            applyCandleAmbiance();
            saveProgress();
          }

          const remaining = decorLayer.querySelectorAll('.candle:not(.lit)').length;
          if (remaining === 0 && candleCount > 0) {
            showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
            setTimeout(nextStep, 1000);
          }
        };
      }
    }

    function trackDecoration(el) {
      decorations.push({ step: currentStep, el: el });
    }

    function saveCakeImage() {
  const cakeArea = document.getElementById('cakeArea');
  showToast('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...');
  html2canvas(cakeArea, {
    scale: 2,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#fff9fc',
    logging: false
  }).then(canvas => {
    const imageData = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = 'å¥¶ç³•çš„ç”Ÿæ—¥è›‹ç³•_' + new Date().getTime() + '.png';
    link.href = imageData;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('è›‹ç³•å›¾ç‰‡å·²ä¿å­˜ï¼ğŸ‰');
    setTimeout(() => {
      document.getElementById('saveImageBtn').style.display = 'none';
      document.getElementById('finishBtn').style.display = 'inline-block';
    }, 1000);
  }).catch(err => {
    console.error('ä¿å­˜å¤±è´¥:', err);
    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}
    
    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          showToast('å·²æ’¤é”€');
          saveProgress();
          return;
        }
      }
      showToast('æ²¡æœ‰å¯æ’¤é”€çš„');
    }

    function updateProgressDisplay(current, max) {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) {
        fill.style.width = (fluffiness / 50 * 100) + '%';
      } else if (current !== undefined && max) {
        fill.style.width = (current / max * 100) + '%';
      }
    }

    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';

      extraImages.forEach(imgData => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        const img = document.createElement('img');
        img.src = imgData.src;
        img.alt = imgData.name;
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.objectFit = 'contain';
        item.appendChild(img);

        item.onmouseenter = (e) => showHoverPreview(e, imgData.src, 'image');
        item.onmouseleave = hideHoverPreview;

        setupDrag(item, imgData.src, 'image', imgData.scale || 1);
        palette.appendChild(item);
      });

      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;

        item.onmouseenter = (e) => showHoverPreview(e, emoji, 'emoji');
        item.onmouseleave = hideHoverPreview;

        setupDrag(item, emoji, 'emoji', 1);
        palette.appendChild(item);
      });
    }

    function showHoverPreview(e, content, type) {
      const preview = document.getElementById('hoverPreview');
      if (type === 'emoji') {
        preview.textContent = content;
        preview.innerHTML = content;
      } else {
        preview.innerHTML = `<img src="${content}" style="width:50px;height:50px;">`;
      }
      preview.style.display = 'block';
      preview.style.left = e.clientX + 'px';
      preview.style.top = e.clientY + 'px';
    }

    function hideHoverPreview() {
      document.getElementById('hoverPreview').style.display = 'none';
    }

    document.addEventListener('mousemove', (e) => {
      const preview = document.getElementById('hoverPreview');
      if (preview.style.display === 'block') {
        preview.style.left = e.clientX + 'px';
        preview.style.top = e.clientY + 'px';
      }
    });

    function setupDrag(item, content, type, scale = 1) {
      const startDrag = (x, y) => {
        hideHoverPreview();

        const ghost = document.createElement('div');
        ghost.className = 'dragging-ghost';

        if (content.includes('q_hanyu')) {
          ghost.classList.add('qhanyu-large');
        } else if (content.includes('Q_ghy2')) {
          ghost.classList.add('qghy2');
        }

        if (type === 'emoji') {
          ghost.textContent = content;
          ghost.style.fontSize = '36px';
        } else {
          ghost.innerHTML = `<img src="${content}" style="width:${50 * scale}px;height:${50 * scale}px;object-fit:contain;">`;
        }
        ghost.style.left = x + 'px';
        ghost.style.top = y + 'px';
        document.body.appendChild(ghost);

        const move = (e) => {
          const cx = e.clientX || (e.touches?.[0]?.clientX);
          const cy = e.clientY || (e.touches?.[0]?.clientY);
          if (cx !== undefined) {
            ghost.style.left = cx + 'px';
            ghost.style.top = cy + 'px';
          }
        };

        const end = (e) => {
          const cx = e.clientX || (e.changedTouches?.[0]?.clientX);
          const cy = e.clientY || (e.changedTouches?.[0]?.clientY);
          const cakeRect = document.getElementById('cakeArea').getBoundingClientRect();

          if (cx >= cakeRect.left && cx <= cakeRect.right && cy >= cakeRect.top && cy <= cakeRect.bottom) {
            AudioManager.playFruit();

            if (type === 'emoji') {
              const decor = document.createElement('div');
              decor.className = 'decoration-emoji';
              decor.textContent = content;
              decor.style.left = (cx - cakeRect.left - 14) + 'px';
              decor.style.top = (cy - cakeRect.top - 14) + 'px';
              document.getElementById('decorationsLayer').appendChild(decor);
              trackDecoration(decor);
            } else {
              const decor = document.createElement('img');
              decor.className = 'decoration-img';
              
              if (content.includes('q_hanyu')) {
                decor.classList.add('qhanyu-large');
              } else if (content.includes('Q_ghy2')) {
                decor.classList.add('qghy2');
              }
              
              decor.src = content;
              const size = (50 * scale) / 2;
              decor.style.left = (cx - cakeRect.left - size) + 'px';
              decor.style.top = (cy - cakeRect.top - size) + 'px';
              document.getElementById('decorationsLayer').appendChild(decor);
              trackDecoration(decor);
            }

            saveProgress();
          }

          ghost.remove();
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', end);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', end);
        };

        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
        document.addEventListener('touchmove', move, {passive: false});
        document.addEventListener('touchend', end);
      };

      item.onmousedown = (e) => { 
        e.preventDefault(); 
        hideHoverPreview();
        startDrag(e.clientX, e.clientY); 
      };
      item.ontouchstart = (e) => { 
        e.preventDefault(); 
        hideHoverPreview();
        startDrag(e.touches[0].clientX, e.touches[0].clientY); 
      };
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
        saveProgress();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
        saveProgress();
      }
    }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) {
          d.el.remove();
          return false;
        }
        return true;
      });

      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      if (currentStep === 4) {
        hasLitCandle = false;
        removeCandleAmbiance();
      }

      updateStep();
      saveProgress();
      showToast('å·²é‡ç½®å½“å‰æ­¥éª¤');
    }

   function finish() {
  document.getElementById('makeStage').style.display = 'none';
  document.getElementById('resultPage').style.display = 'block';
  localStorage.removeItem('cakeProgress');
  try {
    AudioManager.bg.play().catch(e => {});
  } catch(e) {}
  const celebration = document.getElementById('celebration');
  for (let i = 0; i < 40; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.textContent = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'ğŸŠ', 'âœ¨', 'ğŸ§'][Math.floor(Math.random() * 7)];
      c.style.left = Math.random() * 100 + 'vw';
      c.style.animationDuration = (3 + Math.random() * 2) + 's';
      celebration.appendChild(c);
      setTimeout(() => c.remove(), 5000);
    }, i * 50);
  }
}
    document.addEventListener('contextmenu', event => event.preventDefault());

    checkSavedProgress();
    updateStep();
  </script>
</body>
</html>















