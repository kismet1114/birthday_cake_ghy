
# ç”Ÿæˆä¼˜åŒ–åçš„å®Œæ•´HTMLä»£ç 
optimized_code = '''<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }

    body {
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      min-height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œè§£å†³ç§»åŠ¨ç«¯åœ°å€æ é—®é¢˜ */
      display: flex;
      justify-content: center;
      align-items: flex-start; /* æ”¹ä¸ºflex-starté¿å…å±…ä¸­åç§» */
      padding: 10px;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 20px;
      position: relative;
      transition: all 0.5s;
      margin: 10px auto;
    }

    @media (max-width: 480px) {
      .main-container {
        padding: 15px;
        border-radius: 16px;
        margin: 5px auto;
      }
    }

    .main-container.candle-lit {
      box-shadow: 0 10px 60px rgba(255, 150, 50, 0.3), inset 0 0 100px rgba(255, 200, 100, 0.1);
      border: 2px solid rgba(255, 200, 100, 0.3);
    }

    h1 {
      color: #d32f2f;
      font-size: clamp(24px, 5vw, 32px);
      text-align: center;
      margin-bottom: 20px;
      font-family: 'ZCOOL KuaiLe', cursive;
      line-height: 1.2;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      position: relative;
      flex-wrap: wrap;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
      flex-shrink: 0;
    }

    .step-dot.active { 
      background: #e91e63; 
      width: 30px; 
      border-radius: 15px;
    }

    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .workspace { 
        grid-template-columns: 1fr; 
        gap: 15px;
      }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 15px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      transition: all 0.5s;
    }

    @media (max-width: 480px) {
      .guide-panel, .work-panel {
        padding: 12px;
        border-radius: 16px;
      }
    }

    .work-panel.candle-glow {
      box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2);
      border-color: rgba(255, 200, 100, 0.5);
      animation: warmPulse 2s ease-in-out infinite;
    }

    @keyframes warmPulse {
      0%, 100% { box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2); }
      50% { box-shadow: 0 0 70px rgba(255, 160, 60, 0.6), inset 0 0 40px rgba(255, 200, 120, 0.3); }
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      margin-bottom: 12px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
    }

    .guide-image {
      width: 100%;
      max-width: 260px;
      height: auto;
      aspect-ratio: 1;
      object-fit: contain;
      border-radius: 16px;
      display: block;
      margin: 0 auto;
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
      line-height: 1.4;
    }

    .instruction-text {
      color: #e91e63;
      font-size: clamp(14px, 3.5vw, 18px);
      font-weight: bold;
      margin: 12px 0;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
      line-height: 1.3;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active { display: block; }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.3s;
    }

    /* å…³é”®ä¿®å¤ï¼šè›‹ç³•å·¥ä½œåŒºä½¿ç”¨aspect-ratioä¿æŒæ¯”ä¾‹ */
    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 320px;
      aspect-ratio: 1;
      margin: 0 auto;
      background: rgba(255,255,255,0.5);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
      transition: all 0.5s;
    }

    @media (max-width: 480px) {
      .cake-workspace {
        max-width: 280px;
      }
    }

    .cake-workspace.fluff-cursor {
      cursor: url('images/8.png') 16 16, grab;
    }

    @media (pointer: coarse) {
      .cake-workspace.fluff-cursor {
        cursor: grab;
      }
    }

    .cake-workspace.candle-ambiance {
      box-shadow: 0 0 60px rgba(255, 150, 50, 0.5), inset 0 0 40px rgba(255, 200, 100, 0.3);
      animation: cakeGlow 1.5s ease-in-out infinite alternate;
    }

    @keyframes cakeGlow {
      from { box-shadow: 0 0 40px rgba(255, 140, 40, 0.4), inset 0 0 30px rgba(255, 190, 90, 0.2); }
      to { box-shadow: 0 0 80px rgba(255, 170, 70, 0.7), inset 0 0 50px rgba(255, 210, 130, 0.4); }
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.2s;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    /* è£…é¥°å…ƒç´ ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½ï¼Œç¡®ä¿å“åº”å¼ */
    .cream-flower {
      position: absolute;
      width: 18%;  /* ç›¸å¯¹äºå®¹å™¨å®½åº¦ */
      height: auto;
      aspect-ratio: 1;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s ease-out forwards;
      transform-origin: center center;
    }

    .cream-flower img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      width: 8%;
      height: auto;
      aspect-ratio: 1;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s ease-out forwards;
      transform-origin: center center;
    }

    .static-fruit.strawberry {
      width: 11%;
    }

    .static-ruit.medium {
      width: 13%;
    }

    .static-fruit img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      width: 12%;
      height: auto;
      aspect-ratio: 1;
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      transform-origin: center bottom;
    }

    .candle img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji, .decoration-img {
      position: absolute;
      font-size: clamp(20px, 6vw, 28px);
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
      transform-origin: center center;
    }

    .decoration-img {
      width: 14%;
      height: auto;
      aspect-ratio: 1;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .decoration-img.qhanyu-large {
      width: 24%; /* 1.7å€äºæ™®é€šå°ºå¯¸ */
    }

    .decoration-img.qghy2 {
      width: 14%;
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 140px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .emoji-item {
      width: 42px;
      height: 42px;
      font-size: 22px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }

    @media (max-width: 480px) {
      .emoji-item {
        width: 38px;
        height: 38px;
        font-size: 20px;
      }
    }

    .emoji-item img {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }

    @media (max-width: 480px) {
      .emoji-item img {
        width: 32px;
        height: 32px;
      }
    }

    .emoji-item:hover { 
      transform: translateY(-2px) scale(1.05); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .emoji-item:active {
      transform: scale(0.95);
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: clamp(14px, 3.5vw, 16px);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
      white-space: nowrap;
      touch-action: manipulation;
    }

    @media (max-width: 480px) {
      .btn {
        padding: 8px 18px;
      }
    }

    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: scale(0.98); }

    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page { 
      display: none; 
      animation: fadeIn 1s;
      padding: 20px;
    }

    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .result-compare { 
        grid-template-columns: 1fr; 
        gap: 15px;
      }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .final-cake-wrapper {
      position: relative;
      width: 100%;
      max-width: 320px;
      aspect-ratio: 1;
      margin: 0 auto;
      background: #fff9fc;
      border-radius: 16px;
      overflow: visible;
    }

    @media (max-width: 480px) {
      .final-cake-wrapper {
        max-width: 280px;
      }
    }

    .final-message {
      font-size: clamp(28px, 8vw, 42px);
      text-align: center;
      margin: 20px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
      background-size: 200% 200%;
      line-height: 1.3;
    }

    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      font-size: clamp(18px, 5vw, 24px);
      animation: fall 4s linear forwards;
      will-change: transform;
    }

    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 32px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
      will-change: transform;
    }

    .dragging-ghost img {
      width: 46px;
      height: 46px;
      object-fit: contain;
    }

    .dragging-ghost.qhanyu-large img {
      width: 78px;
      height: 78px;
    }

    .dragging-ghost.qghy2 img {
      width: 46px;
      height: 46px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      font-size: 14px;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .fluff-popup {
      position: absolute;
      color: #e91e63;
      font-weight: bold;
      font-size: clamp(14px, 4vw, 18px);
      pointer-events: none;
      z-index: 100;
      animation: floatUp 1s ease-out forwards;
      font-family: 'ZCOOL KuaiLe', cursive;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
      white-space: nowrap;
    }

    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.5); opacity: 0; }
      20% { transform: translateY(-15px) scale(1.1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1); opacity: 0; }
    }

    .save-indicator {
      position: fixed;
      top: 15px;
      right: 15px;
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .save-indicator.show { opacity: 1; }

    .hover-preview {
      position: fixed;
      pointer-events: none;
      z-index: 999;
      opacity: 0.6;
      transform: translate(-50%, -50%);
      font-size: 26px;
      transition: opacity 0.1s;
      display: none;
    }

    .hover-preview img {
      width: 46px;
      height: 46px;
      object-fit: contain;
    }

    .continue-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.95);
      border: 2px solid #e91e63;
      color: #e91e63;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      display: none;
      z-index: 100;
      font-family: 'ZCOOL KuaiLe', cursive;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }

    .continue-btn:hover, .continue-btn:active {
      background: #e91e63;
      color: white;
      transform: scale(1.05);
    }

    /* é˜²æ­¢iOSåŒå‡»ç¼©æ”¾ */
    @media (pointer: coarse) {
      .cake-workspace, .emoji-item, .btn, .continue-btn {
        touch-action: manipulation;
      }
    }

    /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
    .emoji-palette::-webkit-scrollbar {
      width: 4px;
    }
    .emoji-palette::-webkit-scrollbar-thumb {
      background: rgba(233,30,99,0.3);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="main-container" id="makeStage">
    <button class="continue-btn" id="continueBtn" onclick="loadProgress()">ğŸ“‚ ç»§ç»­ä¸Šæ¬¡åˆ¶ä½œ</button>
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>

    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel" id="guidePanel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾" loading="lazy">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" style="position: relative;" id="workPanel">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <div class="cake-workspace fluff-cursor" id="cakeArea">
          <img src="images/7.png" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•" loading="eager">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage">
    <h1 style="text-align: center; color: #d32f2f; font-family: \'ZCOOL KuaiLe\', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare">
      <div class="result-box">
        <div style="font-family: \'ZCOOL KuaiLe\', cursive; color: #e91e63; margin-bottom: 10px; font-size: clamp(16px, 4vw, 20px);">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-wrapper" id="playerCake"></div>
      </div>
      <div class="result-box">
        <div style="font-family: \'ZCOOL KuaiLe\', cursive; color: #e91e63; margin-bottom: 10px; font-size: clamp(16px, 4vw, 20px);">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div class="final-cake-wrapper">
          <img src="images/6.jpg" alt="æˆå“" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;">
        </div>
      </div>
    </div>
    <div class="final-message">ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>
  <div class="save-indicator" id="saveIndicator">ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜</div>
  <div class="hover-preview" id="hoverPreview"></div>

  <script>
    // ==================== éŸ³é¢‘ç®¡ç†å™¨ï¼ˆå¸¦é™çº§å¤„ç†ï¼‰====================
    const AudioManager = {
      cream: null,
      bg: null,
      fluff: null,
      initialized: false,
      muted: false,

      init() {
        try {
          // ä½¿ç”¨å ä½éŸ³é¢‘æˆ–æ£€æµ‹æ”¯æŒ
          this.cream = new Audio();
          this.cream.src = 'music/cream.mp3';
          this.bg = new Audio();
          this.bg.src = 'music/new.mp3';
          this.fluff = new Audio();
          this.fluff.src = 'music/fluff.mp3';
          this.initialized = true;
          
          // iOSéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾
          document.addEventListener('touchstart', () => this.unlockAudio(), {once:true});
          document.addEventListener('click', () => this.unlockAudio(), {once:true});
        } catch(e) {
          console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥', e);
          this.initialized = false;
        }
      },

      unlockAudio() {
        if (!this.initialized) return;
        [this.cream, this.bg, this.fluff].forEach(audio => {
          if (audio) {
            audio.play().then(() => audio.pause()).catch(() => {});
            audio.currentTime = 0;
          }
        });
      },

      playFluff() {
        if (!this.initialized || this.muted) return;
        try {
          const audio = new Audio(this.fluff?.src || this.cream?.src);
          audio.playbackRate = 2.0 + Math.random() * 0.2;
          audio.volume = 0.5; // é™ä½éŸ³é‡é¿å…æƒŠå“
          audio.play().catch(() => {});
        } catch(e) {}
      },

      playFruit() {
        if (!this.initialized || this.muted) return;
        try {
          const audio = new Audio(this.cream?.src);
          audio.playbackRate = 1.5;
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch(e) {}
      }
    };
    AudioManager.init();

    // ==================== æ­¥éª¤é…ç½® ====================
    const steps = [
      { guide: 'images/1.jpg', work: 'images/7.png', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: 'images/2.jpg', work: 'images/7.png', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true, clearCream: true },
      { guide: 'images/4.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: 'images/5.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    // ==================== å…¨å±€çŠ¶æ€ ====================
    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];
    let hasLitCandle = false;
    let cakeRect = null; // ç¼“å­˜è›‹ç³•åŒºåŸŸå°ºå¯¸

    // æ‹æ‰“æç¤ºè¯­
    const fluffMessages = [
      'è“¬æ¾åº¦ +1', 'è›‹ç³•èƒšå˜æ¾è½¯äº†ï½', 'æ‰‹æ„Ÿè¶Šæ¥è¶Šå¥½äº†ï¼',
      'ç»§ç»­æ‹ï¼Œæ›´è“¬æ¾âœ¨', 'è›‹ç³•èƒšå¿«è¦è“¬æ¾äº†', 'å·²ç»å¾ˆå®Œç¾äº†ï¼',
      'è›‹ç³•è“¬æ¾çš„è¦é£èµ·æ¥äº†ğŸˆ', 'æ¾è½¯åº¦UPï¼'
    ];

    const emojis = ['ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­', 'ğŸ€'];
    const fruits = ['images/blue.png', 'images/lemon.png', 'images/strawberry.png'];
    
    const extraImages = [
      { src: 'images/fox2.png', name: 'fox2', scale: 1 },
      { src: 'images/Q_ghy2.png', name: 'qghy2', scale: 1 },
      { src: 'images/q_hanyu.png', name: 'qhanyu', scale: 1.7 },
      { src: 'images/fox.png', name: 'fox', scale: 1 }
    ];

    // ==================== å·¥å…·å‡½æ•° ====================
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showToast(msg, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    // ==================== åæ ‡è½¬æ¢å·¥å…·ï¼ˆå…³é”®ä¿®å¤ï¼‰====================
    // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºè›‹ç³•åŒºåŸŸå†…çš„ç›¸å¯¹åæ ‡ï¼ˆ0-1ï¼‰
    function getRelativeCoordinates(clientX, clientY, element) {
      const rect = element.getBoundingClientRect();
      // è€ƒè™‘é¡µé¢æ»šåŠ¨
      const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
      const scrollY = window.pageYOffset || document.documentElement.scrollTop;
      
      return {
        x: (clientX - rect.left) / rect.width,
        y: (clientY - rect.top) / rect.height,
        width: rect.width,
        height: rect.height
      };
    }

    // éªŒè¯åæ ‡æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    function isValidPosition(x, y) {
      return x >= -0.2 && x <= 1.2 && y >= -0.2 && y <= 1.2; // å…è®¸ç¨å¾®è¶…å‡ºè¾¹ç•Œ
    }

    // ==================== è¿›åº¦ç®¡ç† ====================
    function saveProgress() {
      try {
        const decorData = decorations.map(d => ({
          step: d.step,
          type: d.type,
          x: d.x, // ä¿å­˜ç›¸å¯¹åæ ‡
          y: d.y,
          src: d.src,
          emoji: d.emoji,
          scale: d.scale,
          rotation: d.rotation,
          className: d.className
        }));

        const data = {
          currentStep,
          fluffiness,
          candleCount,
          hasLitCandle,
          decorations: decorData,
          timestamp: new Date().toISOString(),
          version: 2 // ç‰ˆæœ¬å·ï¼Œç”¨äºå…¼å®¹æ€§æ£€æŸ¥
        };
        localStorage.setItem('cakeProgress_v2', JSON.stringify(data));
        showSaveIndicator();
      } catch(e) {
        console.log('ä¿å­˜å¤±è´¥', e);
      }
    }

    function loadProgress() {
      try {
        const saved = localStorage.getItem('cakeProgress_v2');
        if (!saved) {
          showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è®°å½•');
          return;
        }

        const data = JSON.parse(saved);
        
        // éªŒè¯ç‰ˆæœ¬
        if (data.version !== 2) {
          showToast('ä¿å­˜çš„ç‰ˆæœ¬ä¸å…¼å®¹');
          return;
        }

        currentStep = data.currentStep || 0;
        fluffiness = data.fluffiness || 0;
        candleCount = data.candleCount || 0;
        hasLitCandle = data.hasLitCandle || false;

        // æ¸…ç©ºå½“å‰è£…é¥°
        document.getElementById('decorationsLayer').innerHTML = '';
        decorations = [];

        // æ¢å¤è£…é¥°ï¼ˆä½¿ç”¨ä¿å­˜çš„ç›¸å¯¹åæ ‡ï¼‰
        if (data.decorations && Array.isArray(data.decorations)) {
          data.decorations.forEach(d => restoreDecoration(d));
        }

        updateStep();

        if (hasLitCandle) {
          applyCandleAmbiance();
        }

        const date = new Date(data.timestamp);
        showToast(`å·²æ¢å¤ ${date.getMonth()+1}/${date.getDate()} çš„åˆ¶ä½œè¿›åº¦`);
        document.getElementById('continueBtn').style.display = 'none';
      } catch(e) {
        console.log('åŠ è½½å¤±è´¥', e);
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°å¼€å§‹');
      }
    }

    function restoreDecoration(data) {
      const decorLayer = document.getElementById('decorationsLayer');
      let el;

      if (data.type === 'cream') {
        el = document.createElement('div');
        el.className = 'cream-flower';
        el.innerHTML = '<img src="images/cream.png" alt="cream">';
        el.style.left = (data.x * 100 - 9) + '%'; // 9%æ˜¯å®½åº¦18%çš„ä¸€åŠ
        el.style.top = (data.y * 100 - 9) + '%';
      } else if (data.type === 'fruit') {
        el = document.createElement('div');
        el.className = data.className || 'static-fruit';
        const sizeClass = data.className?.includes('strawberry') ? 'strawberry' : 
                         data.className?.includes('medium') ? 'medium' : '';
        if (sizeClass) el.classList.add(sizeClass);
        el.innerHTML = `<img src="${data.src}" alt="fruit">`;
        const offset = sizeClass === 'strawberry' ? 5.5 : sizeClass === 'medium' ? 6.5 : 4;
        el.style.left = (data.x * 100 - offset) + '%';
        el.style.top = (data.y * 100 - offset) + '%';
        if (data.rotation) {
          setTimeout(() => { el.style.transform = `rotate(${data.rotation}deg)`; }, 10);
        }
      } else if (data.type === 'candle') {
        el = document.createElement('div');
        el.className = 'candle';
        if (data.className?.includes('lit')) el.classList.add('lit');
        el.innerHTML = '<img src="images/candle.png" alt="candle">';
        el.style.left = (data.x * 100 - 6) + '%'; // 6%æ˜¯å®½åº¦12%çš„ä¸€åŠ
        el.style.top = (data.y * 100 - 12) + '%';
      } else if (data.type === 'emoji') {
        el = document.createElement('div');
        el.className = 'decoration-emoji';
        el.textContent = data.emoji;
        el.style.left = (data.x * 100) + '%';
        el.style.top = (data.y * 100) + '%';
      } else if (data.type === 'image') {
        el = document.createElement('img');
        el.className = 'decoration-img';
        if (data.className) {
          data.className.split(' ').forEach(c => { if(c) el.classList.add(c); });
        }
        el.src = data.src;
        const sizePercent = data.scale === 1.7 ? 12 : 7; // 24%/2 æˆ– 14%/2
        el.style.left = (data.x * 100 - sizePercent) + '%';
        el.style.top = (data.y * 100 - sizePercent) + '%';
      }

      if (el) {
        decorLayer.appendChild(el);
        decorations.push({...data, el});
      }
    }

    function checkSavedProgress() {
      try {
        const saved = localStorage.getItem('cakeProgress_v2');
        if (saved) {
          document.getElementById('continueBtn').style.display = 'block';
        }
      } catch(e) {}
    }

    // ==================== UI æ§åˆ¶ ====================
    function applyCandleAmbiance() {
      document.getElementById('makeStage').classList.add('candle-lit');
      document.getElementById('workPanel').classList.add('candle-glow');
      document.getElementById('cakeArea').classList.add('candle-ambiance');
    }

    function removeCandleAmbiance() {
      document.getElementById('makeStage').classList.remove('candle-lit');
      document.getElementById('workPanel').classList.remove('candle-glow');
      document.getElementById('cakeArea').classList.remove('candle-ambiance');
    }

    function showFluffPopup(x, y, message) {
      const popup = document.createElement('div');
      popup.className = 'fluff-popup';
      popup.textContent = message;
      // ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½
      popup.style.left = (x * 100) + '%';
      popup.style.top = (y * 100) + '%';
      popup.style.transform = 'translate(-50%, -50%)';
      document.getElementById('cakeArea').appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    // ==================== æ­¥éª¤æ›´æ–° ====================
    function updateStep() {
      const step = steps[currentStep];
      if (!step) return;

      // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + 
          (idx < currentStep ? ' completed' : '') + 
          (idx === currentStep ? ' active' : '');
      });

      // æ›´æ–°å›¾ç‰‡å’Œæ–‡å­—
      const guideImg = document.getElementById('guideImage');
      const workImg = document.getElementById('workImage');
      
      guideImg.src = step.guide;
      workImg.src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;

      // è¿›åº¦æ¡
      const pbar = document.getElementById('progressBar');
      pbar.style.display = step.hasProgress ? 'block' : 'none';
      updateProgressDisplay();

      // è®¾ç½®äº¤äº’
      setupStepInteraction();

      // æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';

      if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('emojiPalette').style.display = 'flex';
        createEmojiPalette();
      } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'none';
      }

      if (currentStep !== 4 && !hasLitCandle) {
        removeCandleAmbiance();
      }

      if (step.clearCream) {
        clearCreamTraces();
      }

      // æ›´æ–°ç¼“å­˜çš„å°ºå¯¸
      updateCakeRect();
    }

    function updateCakeRect() {
      cakeRect = document.getElementById('cakeArea').getBoundingClientRect();
    }

    function clearCreamTraces() {
      const decorLayer = document.getElementById('decorationsLayer');
      const creams = decorLayer.querySelectorAll('.cream-flower');
      creams.forEach(cream => cream.remove());
      decorations = decorations.filter(d => d.type !== 'cream');
    }

    // ==================== äº¤äº’è®¾ç½® ====================
    function setupStepInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const workImage = document.getElementById('workImage');
      const decorLayer = document.getElementById('decorationsLayer');
      const step = steps[currentStep];

      // æ¸…é™¤æ—§äº‹ä»¶
      const newCakeArea = cakeArea.cloneNode(true);
      cakeArea.parentNode.replaceChild(newCakeArea, cakeArea);
      
      // é‡æ–°è·å–å¼•ç”¨ï¼ˆå› ä¸ºcloneNodeåå¼•ç”¨å¤±æ•ˆï¼‰
      const freshCakeArea = document.getElementById('cakeArea');
      const freshDecorLayer = document.getElementById('decorationsLayer');
      
      // æ¢å¤è£…é¥°å±‚å¼•ç”¨
      decorations.forEach(d => {
        if (!d.el.parentNode) {
          freshDecorLayer.appendChild(d.el);
        }
      });

      freshCakeArea.classList.remove('fluff-cursor');
      freshCakeArea.style.cursor = 'default';

      // æ­¥éª¤1ï¼šæ‹æ‰“è“¬æ¾
      if (step.action === 'fluff') {
        setupFluffInteraction(freshCakeArea, workImage);
      }
      // æ­¥éª¤2ï¼šæ¶‚æŠ¹å¥¶æ²¹
      else if (step.action === 'cream') {
        setupCreamInteraction(freshCakeArea, freshDecorLayer);
      }
      // æ­¥éª¤3ï¼šæ·»åŠ æ°´æœ
      else if (step.action === 'fruit') {
        setupFruitInteraction(freshCakeArea, freshDecorLayer);
      }
      // æ­¥éª¤4ï¼šæ’èœ¡çƒ›
      else if (step.action === 'candle') {
        setupCandleInteraction(freshCakeArea, freshDecorLayer);
      }
      // æ­¥éª¤5ï¼šç‚¹ç‡ƒèœ¡çƒ›
      else if (step.action === 'light') {
        setupLightInteraction(freshCakeArea, freshDecorLayer);
      }

      // å»¶è¿Ÿæ›´æ–°å°ºå¯¸ç¼“å­˜ï¼ˆç¡®ä¿DOMå·²æ›´æ–°ï¼‰
      setTimeout(updateCakeRect, 100);
    }

    function setupFluffInteraction(cakeArea, workImage) {
      let pressing = false;
      let interval;
      let lastMsgIndex = -1;

      cakeArea.classList.add('fluff-cursor');

      const startFluff = (e) => {
        e.preventDefault();
        if (pressing) return;
        pressing = true;
        
        workImage.style.transform = 'scale(0.95, 1.05)';
        AudioManager.playFluff();

        const coords = getPointerCoords(e);
        const relativeCoords = getRelativeCoordinates(coords.x, coords.y, cakeArea);

        let msgIndex;
        do { msgIndex = Math.floor(Math.random() * fluffMessages.length); }
        while (msgIndex === lastMsgIndex && fluffMessages.length > 1);
        lastMsgIndex = msgIndex;

        showFluffPopup(relativeCoords.x, relativeCoords.y, fluffMessages[msgIndex]);

        interval = setInterval(() => {
          if (fluffiness < 50) {
            fluffiness = Math.min(fluffiness + 2, 50);
            updateProgressDisplay();

            if (fluffiness % 5 === 0 && fluffiness < 50) {
              AudioManager.playFluff();
              let newMsgIndex;
              do { newMsgIndex = Math.floor(Math.random() * fluffMessages.length); }
              while (newMsgIndex === lastMsgIndex);
              lastMsgIndex = newMsgIndex;
              
              // æ·»åŠ éšæœºåç§»é¿å…é‡å 
              const offsetX = (Math.random() - 0.5) * 0.1;
              const offsetY = (Math.random() - 0.5) * 0.1;
              showFluffPopup(
                Math.max(0, Math.min(1, relativeCoords.x + offsetX)),
                Math.max(0, Math.min(1, relativeCoords.y + offsetY)),
                fluffMessages[newMsgIndex]
              );
            }
          }

          if (fluffiness >= 50) {
            clearInterval(interval);
            showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
            saveProgress();
            setTimeout(nextStep, 500);
          }
        }, 100);
      };

      const endFluff = () => {
        pressing = false;
        clearInterval(interval);
        workImage.style.transform = 'scale(1)';
      };

      cakeArea.addEventListener('mousedown', startFluff, {passive: false});
      cakeArea.addEventListener('touchstart', startFluff, {passive: false});
      cakeArea.addEventListener('mouseup', endFluff);
      cakeArea.addEventListener('mouseleave', endFluff);
      cakeArea.addEventListener('touchend', endFluff);
      cakeArea.addEventListener('touchcancel', endFluff);
    }

    function setupCreamInteraction(cakeArea, decorLayer) {
      cakeArea.style.cursor = 'crosshair';
      let isPressed = false;
      let lastX = 0, lastY = 0;
      let frameId = null;
      let points = [];

      const addCream = (relX, relY, speed) => {
        AudioManager.playFluff();

        const cream = document.createElement('div');
        cream.className = 'cream-flower';
        cream.innerHTML = '<img src="images/cream.png" alt="cream">';
        
        // ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½ï¼Œå±…ä¸­
        cream.style.left = (relX * 100 - 9) + '%';
        cream.style.top = (relY * 100 - 9) + '%';

        const scale = 0.9 + Math.random() * 0.2 - Math.min(speed * 0.01, 0.2);
        const rotation = (Math.random() - 0.5) * 30 * Math.min(speed / 5, 2);
        cream.style.transform = `scale(${Math.max(0.5, scale)}) rotate(${rotation}deg)`;

        decorLayer.appendChild(cream);
        decorations.push({
          step: currentStep,
          type: 'cream',
          x: relX,
          y: relY,
          el: cream
        });

        // é™åˆ¶å¥¶æ²¹æ•°é‡
        if (decorations.filter(d => d.type === 'cream').length > 150) {
          const oldCream = decorations.find(d => d.type === 'cream');
          if (oldCream) {
            oldCream.el.remove();
            decorations = decorations.filter(d => d !== oldCream);
          }
        }
      };

      const processPoints = () => {
        if (points.length < 2) {
          frameId = null;
          return;
        }

        const p1 = points[0];
        const p2 = points[points.length - 1];
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const distance = Math.sqrt(dx*dx + dy*dy);

        if (distance > 0.02) { // é˜ˆå€¼æ”¹ä¸ºç›¸å¯¹å•ä½
          const steps = Math.min(Math.ceil(distance / 0.02), 10);
          for (let i = 0; i < steps; i++) {
            const t = (i + 1) / steps;
            addCream(p1.x + dx*t, p1.y + dy*t, distance * 100);
          }
          points = [p2];
        }

        if (points.length > 5) points = points.slice(-5);
        frameId = requestAnimationFrame(processPoints);
      };

      const handleStart = (e) => {
        e.preventDefault();
        isPressed = true;
        const coords = getPointerCoords(e);
        const rel = getRelativeCoordinates(coords.x, coords.y, cakeArea);
        
        if (isValidPosition(rel.x, rel.y)) {
          lastX = rel.x;
          lastY = rel.y;
          points = [{x: rel.x, y: rel.y}];
          addCream(rel.x, rel.y, 0);
          
          if (!frameId) frameId = requestAnimationFrame(processPoints);
        }
      };

      const handleMove = (e) => {
        if (!isPressed) return;
        e.preventDefault();
        
        const coords = getPointerCoords(e);
        const rel = getRelativeCoordinates(coords.x, coords.y, cakeArea);
        
        if (isValidPosition(rel.x, rel.y)) {
          points.push({x: rel.x, y: rel.y});
          lastX = rel.x;
          lastY = rel.y;
        }
      };

      const handleEnd = () => {
        if (isPressed) {
          isPressed = false;
          if (frameId) {
            cancelAnimationFrame(frameId);
            frameId = null;
          }
          points = [];
          saveProgress();
        }
      };

      cakeArea.addEventListener('mousedown', handleStart, {passive: false});
      cakeArea.addEventListener('mousemove', handleMove, {passive: false});
      cakeArea.addEventListener('mouseup', handleEnd);
      cakeArea.addEventListener('mouseleave', handleEnd);
      
      cakeArea.addEventListener('touchstart', handleStart, {passive: false});
      cakeArea.addEventListener('touchmove', handleMove, {passive: false});
      cakeArea.addEventListener('touchend', handleEnd);
      cakeArea.addEventListener('touchcancel', handleEnd);
    }

    function setupFruitInteraction(cakeArea, decorLayer) {
      cakeArea.style.cursor = 'copy';

      const handleClick = (e) => {
        e.preventDefault();
        AudioManager.playFruit();

        const coords = getPointerCoords(e);
        const rel = getRelativeCoordinates(coords.x, coords.y, cakeArea);
        
        if (!isValidPosition(rel.x, rel.y)) return;

        const fruit = document.createElement('div');
        const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
        fruit.innerHTML = `<img src="${randomFruit}" alt="fruit">`;
        
        let className = 'static-fruit';
        let offsetPercent = 4; // é»˜è®¤8%å®½åº¦çš„ä¸€åŠ

        if (randomFruit.includes('strawberry')) {
          className += ' strawberry';
          offsetPercent = 5.5; // 11%çš„ä¸€åŠ
        } else {
          className += ' medium';
          offsetPercent = 6.5; // 13%çš„ä¸€åŠ
        }
        fruit.className = className;

        // ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½
        fruit.style.left = (rel.x * 100 - offsetPercent) + '%';
        fruit.style.top = (rel.y * 100 - offsetPercent) + '%';

        const rotation = Math.random() * 360;
        setTimeout(() => {
          fruit.style.transform = `rotate(${rotation}deg)`;
        }, 50);

        decorLayer.appendChild(fruit);
        decorations.push({
          step: currentStep,
          type: 'fruit',
          x: rel.x,
          y: rel.y,
          src: randomFruit,
          rotation: rotation,
          className: className,
          el: fruit
        });

        const count = decorations.filter(d => d.type === 'fruit').length;
        updateProgressDisplay(count, 10);
        saveProgress();
      };

      cakeArea.addEventListener('click', handleClick);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault(); // é˜²æ­¢è§¦å‘click
        handleClick(e);
      }, {passive: false});
    }

    function setupCandleInteraction(cakeArea, decorLayer) {
      cakeArea.style.cursor = 'pointer';
      candleCount = 0;
      updateProgressDisplay(0, 5);

      const handleClick = (e) => {
        e.preventDefault();
        if (candleCount >= 5) {
          showToast('æœ€å¤šåªèƒ½æ’5æ ¹èœ¡çƒ›ï¼');
          return;
        }

        const coords = getPointerCoords(e);
        const rel = getRelativeCoordinates(coords.x, coords.y, cakeArea);
        
        if (!isValidPosition(rel.x, rel.y)) return;

        const candle = document.createElement('div');
        candle.className = 'candle';
        candle.innerHTML = '<img src="images/candle.png" alt="candle">';
        
        // èœ¡çƒ›å®½12%ï¼Œé«˜è‡ªé€‚åº”ï¼Œä»åº•éƒ¨ä¸­å¿ƒå®šä½
        candle.style.left = (rel.x * 100 - 6) + '%';
        candle.style.top = (rel.y * 100 - 12) + '%';

        decorLayer.appendChild(candle);
        decorations.push({
          step: currentStep,
          type: 'candle',
          x: rel.x,
          y: rel.y,
          el: candle
        });

        candleCount++;
        updateProgressDisplay(candleCount, 5);
        saveProgress();

        if (candleCount === 5) {
          showToast('èœ¡çƒ›æ’æ»¡äº†ï¼Œå‡†å¤‡ç‚¹ç‡ƒï¼');
          setTimeout(nextStep, 800);
        }
      };

      cakeArea.addEventListener('click', handleClick);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        handleClick(e);
      }, {passive: false});
    }

    function setupLightInteraction(cakeArea, decorLayer) {
      cakeArea.style.cursor = 'pointer';

      const handleClick = (e) => {
        e.preventDefault();
        const coords = getPointerCoords(e);
        const rel = getRelativeCoordinates(coords.x, coords.y, cakeArea);

        const candles = decorLayer.querySelectorAll('.candle:not(.lit)');
        if (candles.length === 0 && candleCount > 0) {
          nextStep();
          return;
        }

        let litNew = false;
        candles.forEach(candle => {
          // è®¡ç®—èœ¡çƒ›ä¸­å¿ƒç›¸å¯¹ä½ç½®
          const candleX = (parseFloat(candle.style.left) + 6) / 100;
          const candleY = (parseFloat(candle.style.top) + 12) / 100;
          
          const dist = Math.hypot(rel.x - candleX, rel.y - candleY);
          
          if (dist < 0.15) { // 15%å®¹å·®èŒƒå›´
            if (!candle.classList.contains('lit')) {
              candle.classList.add('lit');
              litNew = true;
              AudioManager.playFluff();

              // ç«èŠ±æ•ˆæœ
              for (let i = 0; i < 6; i++) {
                const spark = document.createElement('div');
                spark.style.cssText = `
                  position: absolute; 
                  left: ${candleX * 100}%; 
                  top: ${candleY * 100}%; 
                  width: 4px; height: 4px; 
                  background: #ffd93d; 
                  border-radius: 50%; 
                  pointer-events: none; 
                  z-index: 30;
                `;
                decorLayer.appendChild(spark);
                const angle = (Math.PI * 2 / 6) * i;
                const dist = 8; // ç™¾åˆ†æ¯”è·ç¦»
                spark.animate([
                  { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                  { transform: `translate(calc(-50% + ${Math.cos(angle)*dist}%), calc(-50% + ${Math.sin(angle)*dist}%)) scale(0)`, opacity: 0 }
                ], { duration: 600, easing: 'ease-out' }).onfinish = () => spark.remove();
              }

              // æ›´æ–°è£…é¥°æ•°æ®
              const decorData = decorations.find(d => d.el === candle);
              if (decorData) decorData.className = 'candle lit';
            }
          }
        });

        if (litNew && !hasLitCandle) {
          hasLitCandle = true;
          applyCandleAmbiance();
          saveProgress();
        }

        const remaining = decorLayer.querySelectorAll('.candle:not(.lit)').length;
        if (remaining === 0 && candleCount > 0) {
          showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
          setTimeout(nextStep, 1000);
        }
      };

      cakeArea.addEventListener('click', handleClick);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        handleClick(e);
      }, {passive: false});
    }

    // ==================== è¾…åŠ©å‡½æ•°ï¼šè·å–æŒ‡é’ˆåæ ‡ï¼ˆç»Ÿä¸€mouseå’Œtouchï¼‰====================
    function getPointerCoords(e) {
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }

    function updateProgressDisplay(current, max) {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) {
        fill.style.width = (fluffiness / 50 * 100) + '%';
      } else if (current !== undefined && max) {
        fill.style.width = (current / max * 100) + '%';
      }
    }

    // ==================== è£…é¥°é¢æ¿ ====================
    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';

      extraImages.forEach(imgData => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        const img = document.createElement('img');
        img.src = imgData.src;
        img.alt = imgData.name;
        img.loading = 'lazy';
        item.appendChild(img);

        const handleStart = (e) => {
          e.preventDefault();
          hideHoverPreview();
          startDrag(e, imgData.src, 'image', imgData.scale || 1);
        };

        item.addEventListener('mousedown', handleStart, {passive: false});
        item.addEventListener('touchstart', handleStart, {passive: false});
        
        item.addEventListener('mouseenter', (e) => showHoverPreview(e, imgData.src, 'image'));
        item.addEventListener('mouseleave', hideHoverPreview);

        palette.appendChild(item);
      });

      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;

        const handleStart = (e) => {
          e.preventDefault();
          hideHoverPreview();
          startDrag(e, emoji, 'emoji', 1);
        };

        item.addEventListener('mousedown', handleStart, {passive: false});
        item.addEventListener('touchstart', handleStart, {passive: false});
        
        item.addEventListener('mouseenter', (e) => showHoverPreview(e, emoji, 'emoji'));
        item.addEventListener('mouseleave', hideHoverPreview);

        palette.appendChild(item);
      });
    }

    function showHoverPreview(e, content, type) {
      if (e.type.includes('touch')) return; // è§¦æ‘¸è®¾å¤‡ä¸æ˜¾ç¤ºé¢„è§ˆ
      const preview = document.getElementById('hoverPreview');
      if (type === 'emoji') {
        preview.textContent = content;
        preview.innerHTML = content;
      } else {
        preview.innerHTML = `<img src="${content}" style="width:46px;height:46px;">`;
      }
      preview.style.display = 'block';
      movePreview(e);
    }

    function hideHoverPreview() {
      document.getElementById('hoverPreview').style.display = 'none';
    }

    function movePreview(e) {
      const preview = document.getElementById('hoverPreview');
      if (preview.style.display === 'block') {
        const coords = getPointerCoords(e);
        preview.style.left = coords.x + 'px';
        preview.style.top = coords.y + 'px';
      }
    }

    document.addEventListener('mousemove', movePreview);

    // ==================== æ‹–æ‹½ç³»ç»Ÿï¼ˆå…³é”®ä¿®å¤ï¼šä½¿ç”¨ç›¸å¯¹åæ ‡ï¼‰====================
    function startDrag(startEvent, content, type, scale = 1) {
      const ghost = document.createElement('div');
      ghost.className = 'dragging-ghost';
      
      if (content.includes('q_hanyu')) ghost.classList.add('qhanyu-large');
      else if (content.includes('Q_ghy2')) ghost.classList.add('qghy2');

      if (type === 'emoji') {
        ghost.textContent = content;
      } else {
        ghost.innerHTML = `<img src="${content}" alt="">`;
      }

      const startCoords = getPointerCoords(startEvent);
      ghost.style.left = startCoords.x + 'px';
      ghost.style.top = startCoords.y + 'px';
      document.body.appendChild(ghost);

      let hasMoved = false;

      const moveHandler = (e) => {
        e.preventDefault();
        hasMoved = true;
        const coords = getPointerCoords(e);
        ghost.style.left = coords.x + 'px';
        ghost.style.top = coords.y + 'px';
      };

      const endHandler = (e) => {
        e.preventDefault();
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);

        const endCoords = getPointerCoords(e);
        const cakeArea = document.getElementById('cakeArea');
        const cakeRect = cakeArea.getBoundingClientRect();

        // æ£€æŸ¥æ˜¯å¦åœ¨è›‹ç³•åŒºåŸŸå†…
        if (endCoords.x >= cakeRect.left && endCoords.x <= cakeRect.right &&
            endCoords.y >= cakeRect.top && endCoords.y <= cakeRect.bottom) {
          
          AudioManager.playFruit();

          const relX = (endCoords.x - cakeRect.left) / cakeRect.width;
          const relY = (endCoords.y - cakeRect.top) / cakeRect.height;

          if (type === 'emoji') {
            const decor = document.createElement('div');
            decor.className = 'decoration-emoji';
            decor.textContent = content;
            decor.style.left = (relX * 100) + '%';
            decor.style.top = (relY * 100) + '%';
            decor.style.transform = 'translate(-50%, -50%)';
            document.getElementById('decorationsLayer').appendChild(decor);
            
            decorations.push({
              step: currentStep,
              type: 'emoji',
              x: relX,
              y: relY,
              emoji: content,
              el: decor
            });
          } else {
            const decor = document.createElement('img');
            decor.className = 'decoration-img';
            decor.src = content;
            
            let className = '';
            let sizePercent = 7; // é»˜è®¤14%/2
            
            if (content.includes('q_hanyu')) {
              className = 'qhanyu-large';
              sizePercent = 12; // 24%/2
            } else if (content.includes('Q_ghy2')) {
              className = 'qghy2';
            }
            
            if (className) decor.classList.add(className);
            
            decor.style.left = (relX * 100 - sizePercent) + '%';
            decor.style.top = (relY * 100 - sizePercent) + '%';
            document.getElementById('decorationsLayer').appendChild(decor);
            
            decorations.push({
              step: currentStep,
              type: 'image',
              x: relX,
              y: relY,
              src: content,
              scale: scale,
              className: className,
              el: decor
            });
          }

          saveProgress();
        }

        ghost.remove();
      };

      document.addEventListener('mousemove', moveHandler, {passive: false});
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, {passive: false});
      document.addEventListener('touchend', endHandler);
    }

    // ==================== æ’¤é”€å’Œå¯¼èˆª ====================
    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          showToast('å·²æ’¤é”€');
          saveProgress();
          
          // æ›´æ–°è®¡æ•°
          if (currentStep === 3) {
            candleCount = decorations.filter(d => d.type === 'candle').length;
            updateProgressDisplay(candleCount, 5);
          } else if (currentStep === 2) {
            const count = decorations.filter(d => d.type === 'fruit').length;
            updateProgressDisplay(count, 10);
          }
          return;
        }
      }
      showToast('æ²¡æœ‰å¯æ’¤é”€çš„');
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
        saveProgress();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
        saveProgress();
      }
    }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) {
          d.el.remove();
          return false;
        }
        return true;
      });

      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      if (currentStep === 4) {
        hasLitCandle = false;
        removeCandleAmbiance();
        // ç†„ç­æ‰€æœ‰èœ¡çƒ›
        decorations.filter(d => d.type === 'candle').forEach(d => {
          d.el.classList.remove('lit');
          d.className = 'candle';
        });
      }

      updateStep();
      saveProgress();
      showToast('å·²é‡ç½®å½“å‰æ­¥éª¤');
    }

    // ==================== å®Œæˆå‡½æ•°ï¼ˆå…³é”®ä¿®å¤ï¼šä½¿ç”¨ç™¾åˆ†æ¯”ç¡®ä¿ä¸€è‡´æ€§ï¼‰====================
    function finish() {
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      
      try {
        localStorage.removeItem('cakeProgress_v2');
        AudioManager.bg.play().catch(() => {});
      } catch(e) {}

      const playerCake = document.getElementById('playerCake');
      playerCake.innerHTML = '';

      // åˆ›å»ºç»“æœå®¹å™¨ - ä½¿ç”¨ä¸åˆ¶ä½œæ—¶ç›¸åŒçš„ç»“æ„
      const container = document.createElement('div');
      container.style.cssText = `
        position: relative;
        width: 100%;
        height: 100%;
        overflow: visible;
      `;

      // åº•å›¾
      const baseImg = document.createElement('img');
      baseImg.src = steps[currentStep].work;
      baseImg.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 16px;
        z-index: 1;
      `;
      container.appendChild(baseImg);

      // è£…é¥°å±‚ - å…³é”®ï¼šæ‰€æœ‰å®šä½éƒ½ä½¿ç”¨ç™¾åˆ†æ¯”ï¼Œä¸åˆ¶ä½œæ—¶å®Œå…¨ä¸€è‡´
      const decorClone = document.createElement('div');
      decorClone.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      `;

      decorations.forEach(d => {
        const clone = d.el.cloneNode(true);
        
        // ä¿æŒåŸå§‹å®šä½ï¼ˆå·²ç»æ˜¯ç™¾åˆ†æ¯”ï¼‰
        clone.style.position = 'absolute';
        clone.style.left = d.el.style.left;
        clone.style.top = d.el.style.top;
        clone.style.width = d.el.style.width || '';
        clone.style.height = d.el.style.height || '';
        clone.style.transform = d.el.style.transform || '';
        
        // æ¸…ç†äº¤äº’
        clone.onmousedown = null;
        clone.onclick = null;
        clone.style.cursor = 'default';
        clone.style.pointerEvents = 'none';
        
        // åœæ­¢åŠ¨ç”»ä½†ä¿ç•™å‘å…‰
        if (clone.classList.contains('candle') && clone.classList.contains('lit')) {
          clone.style.animation = 'none';
          clone.style.filter = 'drop-shadow(0 0 8px #ff6b35) drop-shadow(0 0 16px #ffd93d)';
        }
        
        decorClone.appendChild(clone);
      });

      container.appendChild(decorClone);
      playerCake.appendChild(container);

      // åº†ç¥åŠ¨ç”»
      createCelebration();
      
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function createCelebration() {
      const celebration = document.getElementById('celebration');
      const colors = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'ğŸŠ', 'âœ¨', 'ğŸ§', 'ğŸ°', 'ğŸ‚'];
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = colors[Math.floor(Math.random() * colors.length)];
          c.style.left = Math.random() * 100 + 'vw';
          c.style.animationDuration = (3 + Math.random() * 2) + 's';
          c.style.fontSize = (Math.random() * 10 + 20) + 'px';
          celebration.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i * 30);
      }
    }

    // ==================== çª—å£å¤§å°æ”¹å˜å¤„ç† ====================
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        updateCakeRect();
      }, 250);
    });

    // æ–¹å‘æ”¹å˜æ—¶é‡æ–°è®¡ç®—
    window.addEventListener('orientationchange', () => {
      setTimeout(updateCakeRect, 300);
    });

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ
    document.body.addEventListener('touchmove', (e) => {
      if (e.target.closest('.emoji-palette')) return; // å…è®¸æ»šåŠ¨é¢æ¿
      e.preventDefault();
    }, { passive: false });

    checkSavedProgress();
    updateStep();
  </script>
</body>
</html>












