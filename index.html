<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 30px;
      position: relative;
    }

    h1 {
      color: #d32f2f;
      font-size: 32px;
      text-align: center;
      margin-bottom: 25px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      position: relative;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
    }

    .step-dot.active { 
      background: #e91e63; 
      width: 35px; 
      border-radius: 15px;
    }

    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .workspace { grid-template-columns: 1fr; }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }

    .guide-image {
      width: 100%;
      max-width: 280px;
      height: 280px;
      object-fit: contain;
      border-radius: 16px;
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
    }

    .instruction-text {
      color: #e91e63;
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active { display: block; }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.3s;
    }

    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.5);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.2s;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .cream-flower {
      position: absolute;
      width: 24px;
      height: 24px;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s ease-out forwards;
    }

    .cream-flower img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      width: 30px;
      height: 30px;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s ease-out forwards;
    }

    .static-fruit img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }
    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji, .decoration-img {
      position: absolute;
      font-size: 28px;
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
    }

    .decoration-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 150px;
      overflow-y: auto;
    }

    .emoji-item {
      width: 45px;
      height: 45px;
      font-size: 24px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
      overflow: hidden;
    }

    .emoji-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .emoji-item:hover { transform: translateY(-3px) scale(1.1); }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
    }

    .result-page { display: none; animation: fadeIn 1s; }
    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    @media (max-width: 768px) {
      .result-compare { grid-template-columns: 1fr; }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .final-message {
      font-size: 42px;
      text-align: center;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    .confetti {
      position: absolute;
      font-size: 24px;
      animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }

    .dragging-ghost {
      position: fixed;
      font-size: 36px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    .dragging-ghost img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .audio-control {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 20px;
    }
  </style>
<base target="_blank">
</head>
<body>
  <div class="main-container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>

    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" style="position: relative;">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <div class="cake-workspace" id="cakeArea">
          <img src="images/1.jpg" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
          <div class="decorations-layer" id="decorationsLayer"></div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage" style="display: none;">
    <h1 style="text-align: center; color: #d32f2f; font-family: 'ZCOOL KuaiLe', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare">
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <div class="final-cake-wrapper" id="playerCake" style="position: relative; width: 100%; height: 350px; background: #fff9fc; border-radius: 16px;"></div>
      </div>
      <div class="result-box">
        <div style="font-family: 'ZCOOL KuaiLe', cursive; color: #e91e63; margin-bottom: 10px;">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div style="position: relative; width: 100%; height: 350px; background: #fff9fc; border-radius: 16px;">
          <img src="images/6.jpg" alt="æˆå“" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
      </div>
    </div>
    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>

  <script>
    // éŸ³é¢‘èµ„æº
    const creamSound = new Audio('music/cream.mp3');
    const bgMusic = new Audio('music/song.mp3');
    creamSound.volume = 0.5;
    bgMusic.volume = 0.4;
    bgMusic.loop = true;

    // æ­¥éª¤é…ç½®
    const steps = [
      { guide: 'images/1.jpg', work: 'images/1.jpg', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½å³ä¾§è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: 'images/2.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/2.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true },
      { guide: 'images/4.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: 'images/5.jpg', work: 'images/2.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/2.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let isDrawing = false;
    let decorations = [];

    // åŸºç¡€emojiè£…é¥°
    const emojis = ['ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­', 'ğŸ±', 'ğŸ€'];

    // æ°´æœå›¾ç‰‡ç´ æï¼ˆéšæœºä¸‰é€‰ä¸€ï¼‰
    const fruits = ['images/blue.png', 'images/lemon.png', 'images/strawberry.png'];

    // é¢å¤–è£…é¥°å›¾ç‰‡ç´ æ
    const extraImages = [
      { src: 'images/fox2.png', name: 'fox' },
      { src: 'images/Q_ghy2.png', name: 'qghy' }
    ];

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function updateStep() {
      const step = steps[currentStep];

      // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + (idx < currentStep ? ' completed' : '') + (idx === currentStep ? ' active' : '');
      });

      // æ›´æ–°æ–‡æœ¬å’Œå›¾ç‰‡
      document.getElementById('guideImage').src = step.guide;
      document.getElementById('workImage').src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;

      // è¿›åº¦æ¡
      const pbar = document.getElementById('progressBar');
      pbar.style.display = step.hasProgress ? 'block' : 'none';
      updateProgressDisplay();

      // è®¾ç½®äº¤äº’
      setupStepInteraction();

      // æŒ‰é’®æ§åˆ¶
      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';

      if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('emojiPalette').style.display = 'flex';
        createEmojiPalette();
      } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'none';
      }
    }

    function setupStepInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const workImage = document.getElementById('workImage');
      const decorLayer = document.getElementById('decorationsLayer');
      const step = steps[currentStep];

      // æ¸…é™¤æ‰€æœ‰æ—§äº‹ä»¶å¤„ç†å™¨
      cakeArea.onmousedown = null;
      cakeArea.onmousemove = null;
      cakeArea.onmouseup = null;
      cakeArea.onmouseleave = null;
      cakeArea.onclick = null;
      cakeArea.ontouchstart = null;
      cakeArea.ontouchmove = null;
      cakeArea.ontouchend = null;

      // æ ¹æ®æ­¥éª¤è®¾ç½®æ–°äº¤äº’
      if (step.action === 'fluff') {
        let pressing = false;
        let interval;

        workImage.style.cursor = 'grab';

        cakeArea.onmousedown = cakeArea.ontouchstart = (e) => {
          e.preventDefault();
          pressing = true;
          workImage.style.transform = 'scale(0.9, 1.1)';

          interval = setInterval(() => {
            fluffiness = Math.min(fluffiness + 5, 100);
            updateProgressDisplay();
            if (fluffiness >= 100) {
              clearInterval(interval);
              showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
              setTimeout(nextStep, 500);
            }
          }, 100);
        };

        const endPress = () => {
          pressing = false;
          clearInterval(interval);
          workImage.style.transform = 'scale(1)';
        };

        cakeArea.onmouseup = cakeArea.onmouseleave = cakeArea.ontouchend = endPress;
      }

      else if (step.action === 'cream') {
        cakeArea.style.cursor = 'crosshair';
        let lastX, lastY;

        const addCream = (x, y) => {
          // æ’­æ”¾æŒ¤å¥¶æ²¹éŸ³æ•ˆ
          try {
            creamSound.currentTime = 0;
            creamSound.play().catch(e => {});
          } catch(e) {}

          const cream = document.createElement('div');
          cream.className = 'cream-flower';
          // ä½¿ç”¨cream.pngå›¾ç‰‡
          cream.innerHTML = `<img src="images/cream.png" alt="cream">`;
          cream.style.left = (x - 12) + 'px';
          cream.style.top = (y - 12) + 'px';
          // éšæœºå¾®è°ƒå¤§å°ï¼Œå¢åŠ è‡ªç„¶æ„Ÿ
          const scale = 0.8 + Math.random() * 0.4;
          cream.style.transform = `scale(${scale})`;
          decorLayer.appendChild(cream);
          trackDecoration(cream);

          // é™åˆ¶æ•°é‡
          const creams = decorLayer.querySelectorAll('.cream-flower');
          if (creams.length > 50) creams[0].remove();
        };

        cakeArea.onmousedown = (e) => {
          isDrawing = true;
          const rect = cakeArea.getBoundingClientRect();
          lastX = e.clientX - rect.left;
          lastY = e.clientY - rect.top;
          addCream(lastX, lastY);
        };

        cakeArea.onmousemove = (e) => {
          if (!isDrawing) return;
          const rect = cakeArea.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          // å¢åŠ é—´éš”é˜ˆå€¼ï¼Œè®©å¥¶æ²¹æ¶‚æŠ¹æ›´è‡ªç„¶
          if (Math.hypot(x - lastX, y - lastY) > 20) {
            addCream(x, y);
            lastX = x;
            lastY = y;
          }
        };

        cakeArea.onmouseup = cakeArea.onmouseleave = () => isDrawing = false;

        // è§¦æ‘¸æ”¯æŒ
        cakeArea.ontouchstart = (e) => {
          e.preventDefault();
          isDrawing = true;
          const touch = e.touches[0];
          const rect = cakeArea.getBoundingClientRect();
          addCream(touch.clientX - rect.left, touch.clientY - rect.top);
        };

        cakeArea.ontouchmove = (e) => {
          e.preventDefault();
          if (!isDrawing) return;
          const touch = e.touches[0];
          const rect = cakeArea.getBoundingClientRect();
          addCream(touch.clientX - rect.left, touch.clientY - rect.top);
        };

        cakeArea.ontouchend = () => isDrawing = false;
      }

      else if (step.action === 'fruit') {
        cakeArea.style.cursor = 'copy';
        let count = 0;

        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const fruit = document.createElement('div');
          fruit.className = 'static-fruit';

          // éšæœºé€‰æ‹©æ°´æœå›¾ç‰‡
          const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
          fruit.innerHTML = `<img src="${randomFruit}" alt="fruit">`;

          // ç‚¹å‡»ä½ç½®å±…ä¸­
          fruit.style.left = (e.clientX - rect.left - 15) + 'px';
          fruit.style.top = (e.clientY - rect.top - 15) + 'px';

          // éšæœºå¾®è°ƒè§’åº¦
          const rotation = Math.random() * 360;
          fruit.style.transform = `rotate(${rotation}deg)`;

          decorLayer.appendChild(fruit);
          trackDecoration(fruit);
          count++;
          updateProgressDisplay(count, 10);
        };
      }

      else if (step.action === 'candle') {
        cakeArea.style.cursor = 'pointer';
        candleCount = 0;
        updateProgressDisplay(0, 5);

        cakeArea.onclick = (e) => {
          if (candleCount >= 5) {
            showToast('æœ€å¤šåªèƒ½æ’5æ ¹èœ¡çƒ›ï¼');
            return;
          }
          const rect = cakeArea.getBoundingClientRect();
          const candle = document.createElement('div');
          candle.className = 'candle';
          candle.textContent = 'ğŸ•¯ï¸';
          candle.style.left = (e.clientX - rect.left - 24) + 'px';
          candle.style.top = (e.clientY - rect.top - 48) + 'px';
          decorLayer.appendChild(candle);
          trackDecoration(candle);
          candleCount++;
          updateProgressDisplay(candleCount, 5);

          if (candleCount === 5) {
            showToast('èœ¡çƒ›æ’æ»¡äº†ï¼Œå‡†å¤‡ç‚¹ç‡ƒï¼');
            setTimeout(nextStep, 800);
          }
        };
      }

      else if (step.action === 'light') {
        cakeArea.onclick = (e) => {
          const rect = cakeArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;

          const candles = decorLayer.querySelectorAll('.candle:not(.lit)');
          if (candles.length === 0 && candleCount > 0) {
            nextStep();
            return;
          }

          candles.forEach(candle => {
            const cx = parseFloat(candle.style.left) + 24;
            const cy = parseFloat(candle.style.top) + 24;
            if (Math.hypot(clickX - cx, clickY - cy) < 60) {
              candle.classList.add('lit');
              // ç«èŠ±ç‰¹æ•ˆ
              for (let i = 0; i < 6; i++) {
                const spark = document.createElement('div');
                spark.style.cssText = `position: absolute; left: ${cx}px; top: ${cy}px; width: 4px; height: 4px; background: #ffd93d; border-radius: 50%; pointer-events: none; z-index: 30;`;
                decorLayer.appendChild(spark);
                const angle = (Math.PI * 2 / 6) * i;
                const dist = 30;
                spark.animate([
                  { transform: 'translate(0,0) scale(1)', opacity: 1 },
                  { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`, opacity: 0 }
                ], { duration: 600, easing: 'ease-out' }).onfinish = () => spark.remove();
              }
            }
          });

          // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ç‚¹ç‡ƒ
          const remaining = decorLayer.querySelectorAll('.candle:not(.lit)').length;
          if (remaining === 0 && candleCount > 0) {
            showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
            setTimeout(nextStep, 1000);
          }
        };
      }
    }

    function trackDecoration(el) {
      decorations.push({ step: currentStep, el: el });
    }

    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          showToast('å·²æ’¤é”€');
          return;
        }
      }
      showToast('æ²¡æœ‰å¯æ’¤é”€çš„');
    }

    function updateProgressDisplay(current, max) {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) {
        fill.style.width = fluffiness + '%';
      } else if (current !== undefined && max) {
        fill.style.width = (current / max * 100) + '%';
      }
    }

    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';

      // æ·»åŠ åŸºç¡€emoji
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        setupDrag(item, emoji, 'emoji');
        palette.appendChild(item);
      });

      // æ·»åŠ é¢å¤–å›¾ç‰‡ç´ æï¼ˆfox2.png å’Œ Q_ghy2.pngï¼‰
      extraImages.forEach(imgData => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        const img = document.createElement('img');
        img.src = imgData.src;
        img.alt = imgData.name;
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.objectFit = 'contain';
        item.appendChild(img);
        setupDrag(item, imgData.src, 'image');
        palette.appendChild(item);
      });
    }

    function setupDrag(item, content, type) {
      const startDrag = (x, y) => {
        const ghost = document.createElement('div');
        ghost.className = 'dragging-ghost';
        if (type === 'emoji') {
          ghost.textContent = content;
          ghost.style.fontSize = '36px';
        } else {
          ghost.innerHTML = `<img src="${content}" style="width:50px;height:50px;object-fit:contain;">`;
        }
        ghost.style.left = x + 'px';
        ghost.style.top = y + 'px';
        document.body.appendChild(ghost);

        const move = (e) => {
          const cx = e.clientX || (e.touches?.[0]?.clientX);
          const cy = e.clientY || (e.touches?.[0]?.clientY);
          if (cx !== undefined) {
            ghost.style.left = cx + 'px';
            ghost.style.top = cy + 'px';
          }
        };

        const end = (e) => {
          const cx = e.clientX || (e.changedTouches?.[0]?.clientX);
          const cy = e.clientY || (e.changedTouches?.[0]?.clientY);
          const cakeRect = document.getElementById('cakeArea').getBoundingClientRect();

          if (cx >= cakeRect.left && cx <= cakeRect.right && cy >= cakeRect.top && cy <= cakeRect.bottom) {
            if (type === 'emoji') {
              const decor = document.createElement('div');
              decor.className = 'decoration-emoji';
              decor.textContent = content;
              decor.style.left = (cx - cakeRect.left - 14) + 'px';
              decor.style.top = (cy - cakeRect.top - 14) + 'px';
              document.getElementById('decorationsLayer').appendChild(decor);
              trackDecoration(decor);
            } else {
              const decor = document.createElement('img');
              decor.className = 'decoration-img';
              decor.src = content;
              decor.style.left = (cx - cakeRect.left - 25) + 'px';
              decor.style.top = (cy - cakeRect.top - 25) + 'px';
              document.getElementById('decorationsLayer').appendChild(decor);
              trackDecoration(decor);
            }
          }

          ghost.remove();
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', end);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', end);
        };

        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', end);
        document.addEventListener('touchmove', move, {passive: false});
        document.addEventListener('touchend', end);
      };

      item.onmousedown = (e) => { e.preventDefault(); startDrag(e.clientX, e.clientY); };
      item.ontouchstart = (e) => { e.preventDefault(); startDrag(e.touches[0].clientX, e.touches[0].clientY); };
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
      }
    }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) {
          d.el.remove();
          return false;
        }
        return true;
      });

      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      updateStep();
      showToast('å·²é‡ç½®å½“å‰æ­¥éª¤');
    }

    function finish() {
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';

      // æ’­æ”¾åº†ç¥éŸ³ä¹
      try {
        bgMusic.play().catch(e => {
          console.log('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾');
        });
      } catch(e) {}

      // å¤åˆ¶ä½œå“
      const playerCake = document.getElementById('playerCake');
      const workImg = document.getElementById('workImage').cloneNode();
      const decorClone = document.getElementById('decorationsLayer').cloneNode(true);

      playerCake.appendChild(workImg);
      playerCake.appendChild(decorClone);

      // åº†ç¥åŠ¨ç”»
      const celebration = document.getElementById('celebration');
      for (let i = 0; i < 40; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'âœ¨', 'ğŸ’–'][Math.floor(Math.random() * 6)];
          c.style.left = Math.random() * 100 + 'vw';
          c.style.animationDuration = (3 + Math.random() * 2) + 's';
          celebration.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i * 50);
      }
    }

    // åˆå§‹åŒ–
    updateStep();
  </script>
</body>
</html>