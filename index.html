<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&display=swap');
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 50%, #ffe6f0 100%);
      background-size: 400% 400%;
      font-family: "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: gradientShift 15s ease infinite;
      user-select: none;
      overflow-x: hidden;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* ç»ç’ƒæ‹Ÿæ€å®¹å™¨ */
    .container {
      width: 92%;
      max-width: 520px;
      text-align: center;
      padding: 25px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      box-shadow: 
        0 8px 32px rgba(31, 38, 135, 0.15),
        inset 0 0 0 1px rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.4);
      position: relative;
      overflow: hidden;
    }

    /* è£…é¥°æ€§èƒŒæ™¯ç²’å­ */
    .bg-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    .bg-particle {
      position: absolute;
      opacity: 0.3;
      animation: float 20s infinite ease-in-out;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    h1 {
      color: #d32f2f;
      font-size: 26px;
      margin: 0 0 15px 0;
      font-weight: bold;
      position: relative;
      z-index: 1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
      letter-spacing: 1px;
    }

    /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .step-dot.active {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      width: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(255, 107, 157, 0.4);
    }
    .step-dot.completed {
      background: #c44569;
      transform: scale(0.8);
    }

    .step-instruction {
      font-size: 20px;
      color: #e91e63;
      margin: 15px 0;
      font-weight: bold;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
      animation: textPop 0.5s ease;
    }
    
    @keyframes textPop {
      0% { opacity: 0; transform: translateY(-10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .instruction-hint {
      font-size: 13px;
      color: #888;
      margin-top: 6px;
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* è›‹ç³•åŒºåŸŸ 3Dæ•ˆæœ */
    .cake-area {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 400px;
      margin: 20px auto;
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,249,252,0.9));
      border-radius: 24px;
      overflow: visible;
      cursor: pointer;
      box-shadow: 
        0 10px 40px rgba(0,0,0,0.08),
        0 0 0 1px rgba(255,255,255,0.8),
        inset 0 0 20px rgba(255,255,255,0.5);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-style: preserve-3d;
      perspective: 1000px;
      z-index: 1;
    }
    
    .cake-area:hover {
      transform: translateY(-5px) rotateX(2deg);
      box-shadow: 
        0 20px 50px rgba(0,0,0,0.12),
        0 0 0 1px rgba(255,255,255,0.8),
        inset 0 0 20px rgba(255,255,255,0.5);
    }

    .cake-base {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 24px;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
      z-index: 1;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));
    }

    /* è“¬æ¾åº¦ä»ªè¡¨ç›˜ */
    .fluffiness-meter {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-weight: bold;
      color: #e91e63;
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.6);
    }
    .fluffiness-meter.show {
      transform: translateX(-50%) scale(1);
    }
    .fluff-bar {
      width: 120px;
      height: 8px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }
    .fluff-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9e, #fecfef, #ffd1ff);
      background-size: 200% 100%;
      width: 0%;
      transition: width 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border-radius: 4px;
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* è£…é¥°å±‚ */
    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      pointer-events: none;
    }

    /* é«˜çº§å¥¶æ²¹æ•ˆæœ - SVGæ ·å¼ */
    .cream-drop {
      position: absolute;
      pointer-events: none;
      z-index: 15;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      animation: creamPop 0.3s ease-out;
    }
    
    @keyframes creamPop {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      50% { transform: scale(1.3) rotate(180deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    /* æ°´æœç‰©ç†å¼¹è·³ */
    .falling-item {
      position: absolute;
      font-size: 28px;
      z-index: 12;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
      animation: fruitBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      cursor: grab;
    }
    
    @keyframes fruitBounce {
      0% { transform: translateY(-100px) scale(0.3) rotate(-180deg); opacity: 0; }
      40% { transform: translateY(20px) scale(1.1) rotate(0deg); opacity: 1; }
      60% { transform: translateY(-10px) scale(0.95) rotate(10deg); }
      80% { transform: translateY(5px) scale(1.02) rotate(-5deg); }
      100% { transform: translateY(0) scale(1) rotate(0deg); }
    }

    /* èœ¡çƒ›å…‰æ•ˆå¼ºåŒ– */
    .candle {
      position: absolute;
      font-size: 64px;
      cursor: pointer;
      transition: all 0.3s;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
      z-index: 15;
    }
    .candle:hover {
      transform: scale(1.1) translateY(-5px);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }
    .candle.lit {
      animation: flicker 1s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 20px #ff6b35, 0 0 40px #ff8c42, 0 0 60px #ffd93d);
    }
    @keyframes flicker {
      0% { transform: scale(1) rotate(-2deg); filter: drop-shadow(0 0 15px #ff6b35, 0 0 30px #ff8c42); }
      100% { transform: scale(1.05) rotate(2deg); filter: drop-shadow(0 0 25px #ff6b35, 0 0 50px #ff8c42, 0 0 70px #ffd93d); }
    }

    /* è¿å‡»ç³»ç»Ÿ */
    .combo-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      color: #ff6b6b;
      text-shadow: 
        0 0 10px rgba(255,107,107,0.5),
        0 0 20px rgba(255,107,107,0.3),
        2px 2px 0px white;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s;
    }
    .combo-display.active {
      opacity: 1;
      animation: comboZoom 1s ease-out forwards;
    }
    @keyframes comboZoom {
      0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
      50% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
    }

    /* åé¦ˆç²’å­ */
    .particle {
      position: absolute;
      pointer-events: none;
      z-index: 50;
    }

    /* æŒ‰é’®ç»„ */
    .button-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }
    
    .btn {
      padding: 14px 32px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 
        0 4px 15px rgba(211,47,47,0.3),
        0 0 0 1px rgba(255,255,255,0.2);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:active::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:hover { 
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 8px 25px rgba(211,47,47,0.4),
        0 0 0 1px rgba(255,255,255,0.3);
    }
    
    .btn:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f2f;
      box-shadow: 0 4px 15px rgba(255,154,158,0.3);
    }

    /* Emoji é¢æ¿ - ç»ç’ƒæ‹Ÿæ€ */
    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
      min-height: 80px;
      gap: 10px;
      position: relative;
      z-index: 1;
      padding: 15px;
      background: rgba(255,255,255,0.6);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.8);
    }
    
    .emoji-item {
      width: 50px;
      height: 50px;
      font-size: 28px;
      cursor: grab;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 4px 6px rgba(0,0,0,0.05),
        0 0 0 1px rgba(0,0,0,0.05);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
    }
    
    .emoji-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.4), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .emoji-item:hover {
      transform: translateY(-5px) scale(1.15) rotate(5deg);
      box-shadow: 
        0 10px 20px rgba(0,0,0,0.1),
        0 0 0 2px rgba(255,107,157,0.3);
    }
    
    .emoji-item:hover::after {
      opacity: 1;
    }
    
    .emoji-item:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    /* ç»“æœé¡µ */
    .result-page {
      display: none;
      width: 100%;
      text-align: center;
      animation: fadeInUp 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(50px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .final-cake-container {
      position: relative;
      width: 90%;
      max-width: 500px;
      height: 500px;
      margin: 20px auto;
      border-radius: 30px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        0 0 0 1px rgba(255,255,255,0.5);
      overflow: hidden;
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      animation: float 4s ease-in-out infinite;
      transform-style: preserve-3d;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotateY(0deg); }
      50% { transform: translateY(-15px) rotateY(2deg); }
    }
    
    .sparkle-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      border: 2px solid rgba(255,215,0,0.3);
      border-radius: 50%;
      animation: rotate 10s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rotate {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .final-message {
      font-size: 52px;
      margin: 30px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3, #54a0ff, #5f27cd);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: rainbow 3s ease infinite, bounceIn 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
      line-height: 1.3;
    }
    
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0) rotate(-10deg); opacity: 0; }
      60% { transform: scale(1.1) rotate(5deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    .characters {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 25px 0;
      animation: slideUp 1s ease 0.5s both;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .character {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.15),
        0 0 0 4px white,
        0 0 0 6px rgba(255,183,197,0.3);
      transition: all 0.4s;
    }
    
    .character:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 
        0 12px 30px rgba(0,0,0,0.2),
        0 0 0 4px white,
        0 0 0 8px rgba(255,183,197,0.5);
    }

    /* åº†ç¥å½©å¸¦ */
    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }
    
    .confetti {
      position: absolute;
      font-size: 24px;
      opacity: 0;
      animation: fall 5s linear forwards;
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.1));
    }
    
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg) scale(1); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
    }

    /* å“åº”å¼ */
    @media (max-width: 480px) {
      .cake-area { height: 360px; }
      .final-cake-container { height: 360px; }
      h1 { font-size: 22px; }
      .final-message { font-size: 40px; }
      .character { width: 100px; height: 100px; }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯è£…é¥°ç²’å­ -->
  <div class="bg-particles" id="bgParticles"></div>

  <div class="container" id="makeStage">
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>
    
    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="step-instruction" id="instruction">
      ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼
      <div class="instruction-hint">
        <span>ğŸ‘†</span> æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡å‹æ‰ï¼Œæ¾å¼€å›å¼¹è†¨èƒ€
      </div>
    </div>

    <div class="combo-display" id="comboDisplay">è¿å‡» x<span id="comboCount">0</span></div>

    <div class="cake-area step-0" id="cakeArea">
      <div class="fluffiness-meter" id="fluffMeter">
        è“¬æ¾åº¦
        <div class="fluff-bar">
          <div class="fluff-fill" id="fluffFill"></div>
        </div>
      </div>
      <img src="images/1.jpg" class="cake-base" id="cakeImg" alt="è›‹ç³•" draggable="false">
      <div class="decorations-layer" id="decorationsLayer"></div>
    </div>

    <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>

    <div class="button-group">
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†©ï¸</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage">
    <h1 style="font-family: 'ZCOOL KuaiLe', cursive; color: #d32f2f; font-size: 32px;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div id="finalCakePlaceholder"></div>
    <div class="final-message">é«˜ç€šå®‡<br>ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div style="font-size: 18px; color: #666; font-family: 'Ma Shan Zheng', cursive; margin-top: 10px;">
      æ„¿ä½ æ¯å¤©éƒ½åƒè¿™ä¸ªè›‹ç³•ä¸€æ ·ç”œ ğŸ’•
    </div>
    <div class="characters">
      <img src="images/q_hanyu.jpg" alt="é«˜ç€šå®‡" class="character">
      <img src="images/fox.jpg" alt="èŒå® " class="character">
    </div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()" style="margin-top: 20px;">å†åšä¸€ä¸ª ğŸ”„</button>
      <button class="btn btn-secondary" onclick="saveCake()" style="margin-top: 20px;">ä¿å­˜è›‹ç³• ğŸ“¸</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>

  <script>
    // ä½¿ç”¨æ›´çœŸå®çš„è·¯å¾„ç»˜åˆ¶å¥¶æ²¹ SVG
    const CREAM_SVGS = [
      `<svg width="16" height="16" viewBox="0 0 16 16" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));">
        <circle cx="8" cy="8" r="7" fill="white"/>
        <circle cx="5" cy="5" r="2" fill="rgba(255,255,255,0.8)"/>
      </svg>`,
      `<svg width="14" height="14" viewBox="0 0 14 14" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));">
        <ellipse cx="7" cy="7" rx="6" ry="5" fill="white"/>
        <ellipse cx="4" cy="4" rx="1.5" ry="1" fill="#f0f0f0"/>
      </svg>`,
      `<svg width="12" height="12" viewBox="0 0 12 12" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));">
        <circle cx="6" cy="6" r="5" fill="url(#creamGrad)"/>
        <defs>
          <radialGradient id="creamGrad" cx="30%" cy="30%">
            <stop offset="0%" style="stop-color:white"/>
            <stop offset="100%" style="stop-color:#f5f5f5"/>
          </radialGradient>
        </defs>
      </svg>`
    ];

    class CakeGame {
      constructor() {
        this.steps = [
          { name: 'base', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', hint: 'ğŸ‘† æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡å‹æ‰ï¼Œæ¾å¼€å›å¼¹è†¨èƒ€', image: 'images/1.jpg' },
          { name: 'cream', instruction: 'ç¬¬äºŒæ­¥ï¼šæŒ‰ä½å¹¶æ‹–åŠ¨æ¶‚æŠ¹å¥¶æ²¹', hint: 'ğŸ§ åƒçœŸå®æŒ¤å¥¶æ²¹ä¸€æ ·æ‹–åŠ¨é¼ æ ‡', image: 'images/2.jpg' },
          { name: 'fruit', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœ', hint: 'ğŸ“ğŸ’ ç‚¹å‡»ä»»æ„ä½ç½®æ‰è½æ°´æœ', image: 'images/3.jpg' },
          { name: 'candle', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', hint: 'ğŸ•¯ï¸ åœ¨è›‹ç³•ä¸Šç‚¹å‡»æ’èœ¡çƒ›', image: 'images/4.jpg' },
          { name: 'light', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', hint: 'ğŸ”¥ ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒ', image: 'images/4.jpg' },
          { name: 'party', instruction: 'ç¬¬å…­æ­¥ï¼šè‡ªç”±è£…é¥°è›‹ç³•', hint: 'ğŸ¨ æ‹–æ‹½è¡¨æƒ…åˆ°è›‹ç³•ä¸Š', image: 'images/6.jpg' }
        ];
        
        this.currentStep = 0;
        this.candleCount = 0;
        this.isDrawingCream = false;
        this.fluffiness = 0;
        this.maxFluffiness = 100;
        this.isPressed = false;
        this.combo = 0;
        this.comboTimer = null;
        this.lastMousePos = null;
        this.creamThrottle = 0;
        
        this.elements = {
          cakeArea: document.getElementById('cakeArea'),
          cakeImg: document.getElementById('cakeImg'),
          decorationsLayer: document.getElementById('decorationsLayer'),
          instruction: document.getElementById('instruction'),
          fluffMeter: document.getElementById('fluffMeter'),
          fluffFill: document.getElementById('fluffFill'),
          comboDisplay: document.getElementById('comboDisplay'),
          comboCount: document.getElementById('comboCount'),
          stepIndicator: document.getElementById('stepIndicator'),
          emojiPalette: document.getElementById('emojiPalette'),
          nextBtn: document.getElementById('nextBtn'),
          finishBtn: document.getElementById('finishBtn'),
          undoBtn: document.getElementById('undoBtn')
        };
        
        this.emojis = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­'];
        this.decorations = []; // è®°å½•æ‰€æœ‰è£…é¥°ç”¨äºæ’¤é”€
        
        this.init();
      }
      
      init() {
        this.createBgParticles();
        this.updateStep();
        this.bindGlobalEvents();
      }
      
      createBgParticles() {
        const container = document.getElementById('bgParticles');
        const shapes = ['ğŸ€', 'ğŸ’–', 'âœ¨', 'ğŸŒ¸', 'ğŸˆ'];
        for (let i = 0; i < 15; i++) {
          const p = document.createElement('div');
          p.className = 'bg-particle';
          p.textContent = shapes[Math.floor(Math.random() * shapes.length)];
          p.style.left = Math.random() * 100 + '%';
          p.style.top = Math.random() * 100 + '%';
          p.style.fontSize = (20 + Math.random() * 30) + 'px';
          p.style.animationDelay = Math.random() * 5 + 's';
          p.style.animationDuration = (15 + Math.random() * 10) + 's';
          container.appendChild(p);
        }
      }
      
      updateStep() {
        const step = this.steps[this.currentStep];
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        const dots = this.elements.stepIndicator.querySelectorAll('.step-dot');
        dots.forEach((dot, idx) => {
          dot.classList.remove('active', 'completed');
          if (idx < this.currentStep) dot.classList.add('completed');
          if (idx === this.currentStep) dot.classList.add('active');
        });
        
        // æ–‡å­—åŠ¨ç”»æ›´æ–°
        this.elements.instruction.style.animation = 'none';
        setTimeout(() => {
          this.elements.instruction.innerHTML = `
            ${step.instruction}
            <div class="instruction-hint">
              <span>${step.hint.split(' ')[0]}</span> ${step.hint.split(' ').slice(1).join(' ')}
            </div>
          `;
          this.elements.instruction.style.animation = 'textPop 0.5s ease';
        }, 10);
        
        this.elements.cakeImg.src = step.image;
        this.elements.cakeArea.className = 'cake-area step-' + this.currentStep;
        
        // è“¬æ¾åº¦ä»ªè¡¨
        if (this.currentStep === 0) {
          this.elements.fluffMeter.classList.add('show');
        } else {
          this.elements.fluffMeter.classList.remove('show');
        }
        
        // æŒ‰é’®çŠ¶æ€
        if (this.currentStep === 5) {
          this.elements.emojiPalette.style.display = 'flex';
          this.elements.nextBtn.style.display = 'none';
          this.elements.finishBtn.style.display = 'inline-block';
          this.elements.undoBtn.style.display = 'inline-block';
          this.createEmojiPalette();
        } else {
          this.elements.emojiPalette.style.display = 'none';
          this.elements.nextBtn.style.display = 'inline-block';
          this.elements.finishBtn.style.display = 'none';
          this.elements.undoBtn.style.display = 'none';
        }
        
        this.bindStepInteraction();
      }
      
      bindStepInteraction() {
        const area = this.elements.cakeArea;
        area.onmousedown = null;
        area.onmousemove = null;
        area.onmouseup = null;
        area.onmouseleave = null;
        area.ontouchstart = null;
        area.ontouchmove = null;
        area.ontouchend = null;
        area.onclick = null;
        
        switch (this.currentStep) {
          case 0:
            this.bindFluffInteraction();
            break;
          case 1:
            this.bindCreamInteraction();
            break;
          case 2:
            area.onclick = (e) => {
              this.addFruit(e);
              this.vibrate(10);
            };
            break;
          case 3:
            area.onclick = (e) => {
              if (this.candleCount >= 5) {
                this.showFeedback("æœ€å¤š5æ ¹å“¦ï¼");
                return;
              }
              this.addCandle(e);
              this.vibrate(20);
            };
            break;
          case 4:
            this.bindLightInteraction();
            break;
        }
      }
      
      bindFluffInteraction() {
        const area = this.elements.cakeArea;
        const img = this.elements.cakeImg;
        
        const startPress = (e) => {
          if (this.fluffiness >= this.maxFluffiness) return;
          this.isPressed = true;
          img.classList.add('squashed');
          this.combo++;
          this.updateCombo();
          
          // è§¦æ„Ÿåé¦ˆ
          this.vibrate(15);
          
          clearTimeout(this.comboTimer);
          this.comboTimer = setTimeout(() => {
            this.combo = 0;
            this.elements.comboDisplay.classList.remove('active');
          }, 1000);
        };
        
        const endPress = (e) => {
          if (!this.isPressed) return;
          this.isPressed = false;
          img.classList.remove('squashed');
          
          const increase = 5 + Math.min(this.combo * 2, 15);
          this.fluffiness = Math.min(this.fluffiness + increase, this.maxFluffiness);
          
          this.createParticles(e, 'flour');
          if (this.fluffiness % 20 < 10) this.createSteam();
          this.updateFluffiness();
          
          img.classList.remove('growing');
          void img.offsetWidth;
          img.classList.add('growing');
          
          // éŸ³æ•ˆæ¨¡æ‹Ÿï¼ˆè§†è§‰åé¦ˆå¼ºåŒ–ï¼‰
          this.showFeedback(`+${increase}% è“¬æ¾åº¦ï¼`);
        };
        
        area.onmousedown = startPress;
        area.ontouchstart = (e) => { e.preventDefault(); startPress(e.touches[0]); };
        document.addEventListener('mouseup', endPress);
        document.addEventListener('touchend', endPress);
      }
      
      bindCreamInteraction() {
        const area = this.elements.cakeArea;
        
        const draw = (e) => {
          if (!this.isDrawingCream) return;
          e.preventDefault();
          
          const t = Date.now();
          if (t - this.creamThrottle < 30) return; // èŠ‚æµï¼Œæ›´è‡ªç„¶çš„é—´éš”
          this.creamThrottle = t;
          
          const rect = area.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          
          // ä½¿ç”¨SVGå¥¶æ²¹
          const cream = document.createElement('div');
          cream.className = 'cream-drop';
          cream.innerHTML = CREAM_SVGS[Math.floor(Math.random() * CREAM_SVGS.length)];
          
          const size = 12 + Math.random() * 8;
          cream.style.left = (x - size/2) + 'px';
          cream.style.top = (y - size/2) + 'px';
          cream.style.width = size + 'px';
          cream.style.height = size + 'px';
          
          this.elements.decorationsLayer.appendChild(cream);
          this.decorations.push({ el: cream, step: 1 });
          
          this.lastMousePos = { x, y };
        };
        
        area.onmousedown = () => { this.isDrawingCream = true; this.vibrate(5); };
        area.onmousemove = draw;
        area.onmouseup = () => this.isDrawingCream = false;
        area.onmouseleave = () => this.isDrawingCream = false;
        area.ontouchstart = (e) => { e.preventDefault(); this.isDrawingCream = true; this.vibrate(5); };
        area.ontouchmove = (e) => { draw(e); };
        area.ontouchend = () => this.isDrawingCream = false;
      }
      
      addFruit(e) {
        const fruits = ['ğŸ“', 'ğŸ’', 'ğŸ«', 'ğŸ‡'];
        const fruit = fruits[Math.floor(Math.random() * fruits.length)];
        const rect = this.elements.cakeArea.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        
        const el = document.createElement('div');
        el.className = 'falling-item';
        el.textContent = fruit;
        el.style.left = (x - 14) + 'px';
        el.style.top = (y - 14) + 'px';
        
        // éšæœºæ—‹è½¬è§’åº¦
        const rot = (Math.random() - 0.5) * 30;
        el.style.transform = `rotate(${rot}deg)`;
        
        this.elements.decorationsLayer.appendChild(el);
        this.decorations.push({ el, step: 2 });
        
        // æœæ±ç²’å­æ•ˆæœ
        this.createParticles(e, 'juice', fruit);
      }
      
      addCandle(e) {
        const rect = this.elements.cakeArea.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        
        const el = document.createElement('div');
        el.className = 'candle';
        el.textContent = 'ğŸ•¯ï¸';
        el.style.left = (x - 32) + 'px';
        el.style.top = (y - 64) + 'px';
        el.style.transform = 'scale(0)';
        el.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        
        this.elements.decorationsLayer.appendChild(el);
        this.decorations.push({ el, step: 3 });
        this.candleCount++;
        
        setTimeout(() => el.style.transform = 'scale(1)', 10);
        
        // èœ¡çƒ›æ’å…¥éŸ³æ•ˆæ¨¡æ‹Ÿ
        this.showFeedback(`èœ¡çƒ› ${this.candleCount}/5`);
      }
      
      bindLightInteraction() {
        this.elements.cakeArea.onclick = (e) => {
          const rect = this.elements.cakeArea.getBoundingClientRect();
          const clickX = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
          const clickY = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
          
          const unlit = this.elements.decorationsLayer.querySelectorAll('.candle:not(.lit)');
          
          if (unlit.length === 0) {
            if (this.candleCount === 0) this.showFeedback("å…ˆæ’èœ¡çƒ›ï¼");
            else {
              this.showFeedback("å…¨éƒ¨ç‚¹ç‡ƒï¼âœ¨");
              this.vibrate([50, 50, 50]);
              setTimeout(() => { this.currentStep = 5; this.updateStep(); }, 1000);
            }
            return;
          }
          
          // å¯»æ‰¾æœ€è¿‘çš„èœ¡çƒ›
          let nearest = null;
          let minDist = Infinity;
          
          unlit.forEach(candle => {
            const cx = parseFloat(candle.style.left) + 32;
            const cy = parseFloat(candle.style.top) + 64;
            const dist = Math.hypot(clickX - cx, clickY - cy);
            if (dist < minDist && dist < 100) {
              minDist = dist;
              nearest = candle;
            }
          });
          
          if (nearest) {
            nearest.classList.add('lit');
            this.vibrate([30, 30]);
            this.createParticles(e, 'sparkle');
            this.showFeedback("ç‚¹ç‡ƒï¼ğŸ”¥");
            
            if (unlit.length === 1) {
              setTimeout(() => {
                this.showFeedback("ç”Ÿæ—¥å¿«ä¹ï¼âœ¨");
                this.vibrate([50, 100, 50]);
                setTimeout(() => { this.currentStep = 5; this.updateStep(); }, 1500);
              }, 800);
            }
          } else {
            this.showFeedback("ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒ");
          }
        };
      }
      
      createEmojiPalette() {
        const palette = this.elements.emojiPalette;
        palette.innerHTML = '';
        
        this.emojis.forEach((emoji, idx) => {
          const item = document.createElement('div');
          item.className = 'emoji-item';
          item.textContent = emoji;
          item.style.animationDelay = (idx * 0.05) + 's';
          item.dataset.emoji = emoji;
          
          item.addEventListener('mousedown', (e) => this.startDrag(e, emoji));
          item.addEventListener('touchstart', (e) => { e.preventDefault(); this.startDrag(e.touches[0], emoji); }, { passive: false });
          
          palette.appendChild(item);
        });
      }
      
      startDrag(e, emoji) {
        this.dragElement = document.createElement('div');
        this.dragElement.style.cssText = `
          position: fixed;
          font-size: 40px;
          pointer-events: none;
          z-index: 1000;
          opacity: 0.9;
          filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
          transition: transform 0.1s;
        `;
        this.dragElement.textContent = emoji;
        document.body.appendChild(this.dragElement);
        
        this.isDragging = true;
        this.currentEmoji = emoji;
        
        this.moveDrag(e);
        this.vibrate(10);
        
        document.addEventListener('mousemove', this.boundDragMove);
        document.addEventListener('mouseup', this.boundDragEnd);
        document.addEventListener('touchmove', this.boundDragMove, { passive: false });
        document.addEventListener('touchend', this.boundDragEnd);
      }
      
      moveDrag(e) {
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        if (this.dragElement) {
          this.dragElement.style.left = (clientX - 20) + 'px';
          this.dragElement.style.top = (clientY - 20) + 'px';
        }
      }
      
      endDrag(e) {
        this.isDragging = false;
        if (this.dragElement) {
          document.body.removeChild(this.dragElement);
          this.dragElement = null;
        }
        
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
        const rect = this.elements.cakeArea.getBoundingClientRect();
        
        if (this.isInside(clientX, clientY, rect)) {
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          this.addDecoration(x, y, this.currentEmoji);
          this.vibrate([20, 20]);
        }
        
        document.removeEventListener('mousemove', this.boundDragMove);
        document.removeEventListener('mouseup', this.boundDragEnd);
        document.removeEventListener('touchmove', this.boundDragMove);
        document.removeEventListener('touchend', this.boundDragEnd);
      }
      
      addDecoration(x, y, emoji) {
        const el = document.createElement('div');
        el.className = 'falling-item';
        el.textContent = emoji;
        el.style.left = (x - 18) + 'px';
        el.style.top = (y - 18) + 'px';
        el.style.fontSize = (32 + Math.random() * 8) + 'px';
        el.style.zIndex = 20;
        
        this.elements.decorationsLayer.appendChild(el);
        this.decorations.push({ el, step: 5, x, y, emoji });
        
        this.showFeedback(`+${emoji}`);
      }
      
      undoLast() {
        if (this.decorations.length === 0) return;
        
        // æ‰¾åˆ°æœ€åä¸€æ­¥çš„è£…é¥°
        const lastStep = this.decorations[this.decorations.length - 1].step;
        const toRemove = [];
        
        for (let i = this.decorations.length - 1; i >= 0; i--) {
          if (this.decorations[i].step === lastStep) {
            toRemove.push(this.decorations[i]);
          } else break;
        }
        
        toRemove.forEach(dec => {
          dec.el.style.transform = 'scale(0)';
          dec.el.style.opacity = '0';
          setTimeout(() => dec.el.remove(), 300);
          const idx = this.decorations.indexOf(dec);
          if (idx > -1) this.decorations.splice(idx, 1);
        });
        
        if (lastStep === 3) this.candleCount = Math.max(0, this.candleCount - toRemove.length);
        
        this.vibrate(10);
        this.showFeedback("å·²æ’¤é”€ â†©ï¸");
      }
      
      // å·¥å…·å‡½æ•°
      vibrate(pattern) {
        if (navigator.vibrate) navigator.vibrate(pattern);
      }
      
      isInside(x, y, rect) {
        return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      }
      
      updateCombo() {
        this.elements.comboCount.textContent = this.combo;
        this.elements.comboDisplay.classList.add('active');
        clearTimeout(this.comboTimer);
        this.comboTimer = setTimeout(() => {
          this.elements.comboDisplay.classList.remove('active');
        }, 1000);
      }
      
      updateFluffiness() {
        const pct = (this.fluffiness / this.maxFluffiness) * 100;
        this.elements.fluffFill.style.width = pct + '%';
        
        const scale = 0.9 + (this.fluffiness / this.maxFluffiness) * 0.2;
        this.elements.cakeImg.style.setProperty('--current-scale', scale);
        this.elements.cakeImg.style.transform = `scale(${scale})`;
        
        if (this.fluffiness >= this.maxFluffiness) {
          this.showPerfect();
        }
      }
      
      createParticles(e, type, data = null) {
        const rect = this.elements.cakeArea.getBoundingClientRect();
        const x = (e.clientX || rect.width/2) - rect.left;
        const y = (e.clientY || rect.height/2) - rect.top;
        
        const count = type === 'flour' ? 8 : type === 'sparkle' ? 12 : 6;
        const symbols = type === 'flour' ? ['âœ¨', 'â­', 'ğŸŒŸ'] : 
                       type === 'juice' ? [data] :
                       type === 'sparkle' ? ['âœ¨', 'ğŸ’«', 'â­'] : ['ğŸ’¨'];
        
        for (let i = 0; i < count; i++) {
          const p = document.createElement('div');
          p.className = 'particle';
          p.textContent = symbols[Math.floor(Math.random() * symbols.length)];
          p.style.left = x + 'px';
          p.style.top = y + 'px';
          p.style.fontSize = (12 + Math.random() * 16) + 'px';
          p.style.animation = `flourFly ${0.5 + Math.random() * 0.5}s ease-out forwards`;
          
          const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
          const dist = 30 + Math.random() * 60;
          p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
          p.style.setProperty('--ty', Math.sin(angle) * dist - 30 + 'px');
          p.style.setProperty('--rot', Math.random() * 360 + 'deg');
          
          this.elements.decorationsLayer.appendChild(p);
          setTimeout(() => p.remove(), 1000);
        }
      }
      
      createSteam() {
        const steam = document.createElement('div');
        steam.className = 'steam-particle';
        steam.textContent = ['â˜ï¸', 'ğŸ’¨', 'âœ¨'][Math.floor(Math.random() * 3)];
        steam.style.left = (20 + Math.random() * 60) + '%';
        steam.style.bottom = (20 + Math.random() * 20) + '%';
        steam.style.fontSize = (24 + Math.random() * 16) + 'px';
        this.elements.decorationsLayer.appendChild(steam);
        setTimeout(() => steam.remove(), 2000);
      }
      
      showPerfect() {
        const perfect = document.createElement('div');
        perfect.className = 'perfect-text';
        perfect.textContent = 'å®Œç¾è“¬æ¾ï¼ğŸ‰';
        this.elements.decorationsLayer.appendChild(perfect);
        setTimeout(() => perfect.remove(), 2500);
        
        for (let i = 0; i < 3; i++) {
          setTimeout(() => this.createParticles({clientX: 0, clientY: 0}, 'sparkle'), i * 200);
        }
      }
      
      showFeedback(text) {
        const fb = document.createElement('div');
        fb.className = 'feedback';
        fb.textContent = text;
        fb.style.cssText = `
          position: absolute;
          left: 50%;
          top: 40%;
          transform: translateX(-50%);
          font-size: 22px;
          color: #d32f2f;
          font-weight: bold;
          pointer-events: none;
          z-index: 100;
          text-shadow: 0 2px 4px rgba(255,255,255,0.9);
          animation: comboFloat 1.2s ease-out forwards;
        `;
        this.elements.decorationsLayer.appendChild(fb);
        setTimeout(() => fb.remove(), 1200);
      }
      
      bindGlobalEvents() {
        this.boundDragMove = (e) => this.moveDrag(e);
        this.boundDragEnd = (e) => this.endDrag(e);
        
        document.getElementById('nextBtn').onclick = () => {
          this.currentStep++;
          this.updateStep();
          this.vibrate(20);
        };
        
        document.getElementById('finishBtn').onclick = () => this.finish();
        document.getElementById('undoBtn').onclick = () => this.undoLast();
      }
      
      finish() {
        this.vibrate([50, 100, 50]);
        
        const final = this.elements.cakeArea.cloneNode(true);
        final.className = 'final-cake-container';
        final.innerHTML += '<div class="sparkle-ring"></div>';
        
        document.getElementById('finalCakePlaceholder').innerHTML = '';
        document.getElementById('finalCakePlaceholder').appendChild(final);
        
        document.getElementById('makeStage').style.display = 'none';
        document.getElementById('resultPage').style.display = 'block';
        
        this.celebrate();
      }
      
      celebrate() {
        const symbols = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'âœ¨', 'ğŸ’–', 'ğŸ¬', 'ğŸ­', 'ğŸŒŸ', 'ğŸŠ'];
        const container = document.getElementById('celebration');
        
        for (let i = 0; i < 60; i++) {
          setTimeout(() => {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            c.style.left = Math.random() * 100 + 'vw';
            c.style.animationDuration = (3 + Math.random() * 3) + 's';
            c.style.fontSize = (20 + Math.random() * 30) + 'px';
            container.appendChild(c);
            setTimeout(() => c.remove(), 6000);
          }, i * 80);
        }
      }
    }

    // åˆå§‹åŒ–æ¸¸æˆ
    const game = new CakeGame();
    
    // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.nextStep = () => {
      // é€šè¿‡æŒ‰é’®ç‚¹å‡»è§¦å‘
    };
    window.finish = () => game.finish();
    window.undoLast = () => game.undoLast();
    window.saveCake = () => {
      alert('é•¿æŒ‰è›‹ç³•å›¾ç‰‡å³å¯ä¿å­˜åˆ°ç›¸å†Œå“¦ï¼ğŸ“¸');
    };
  </script>
</body>
</html>



