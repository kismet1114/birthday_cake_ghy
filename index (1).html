
ultimate_fix = '''<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
      user-select: none !important;
      -webkit-user-select: none !important;
      touch-action: manipulation;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      background: linear-gradient(135deg, #ffe6f0 0%, #f8d7ff 100%);
      font-family: "Microsoft YaHei", sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 10px;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 20px;
      position: relative;
      margin: 10px auto;
    }

    @media (max-width: 480px) {
      .main-container {
        padding: 15px;
        border-radius: 16px;
        margin: 5px auto;
      }
    }

    .main-container.candle-lit {
      box-shadow: 0 10px 60px rgba(255, 150, 50, 0.3), inset 0 0 100px rgba(255, 200, 100, 0.1);
      border: 2px solid rgba(255, 200, 100, 0.3);
    }

    h1 {
      color: #d32f2f;
      font-size: clamp(22px, 5vw, 32px);
      text-align: center;
      margin-bottom: 20px;
      font-family: 'ZCOOL KuaiLe', cursive;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
      transition: all 0.4s;
    }

    .step-dot.active { 
      background: #e91e63; 
      width: 30px; 
      border-radius: 15px;
    }

    .step-dot.completed { 
      background: #c44569; 
    }

    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .workspace { 
        grid-template-columns: 1fr; 
        gap: 15px;
      }
    }

    .guide-panel, .work-panel {
      background: linear-gradient(135deg, #fff9fc, #fff0f5);
      border-radius: 20px;
      padding: 15px;
      text-align: center;
      border: 2px solid rgba(255, 182, 193, 0.3);
      position: relative;
    }

    .work-panel.candle-glow {
      box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2);
      border-color: rgba(255, 200, 100, 0.5);
      animation: warmPulse 2s ease-in-out infinite;
    }

    @keyframes warmPulse {
      0%, 100% { box-shadow: 0 0 50px rgba(255, 180, 80, 0.4), inset 0 0 30px rgba(255, 220, 150, 0.2); }
      50% { box-shadow: 0 0 70px rgba(255, 160, 60, 0.6), inset 0 0 40px rgba(255, 200, 120, 0.3); }
    }

    .guide-label, .work-label {
      display: inline-block;
      background: #e91e63;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      margin-bottom: 12px;
      font-weight: bold;
    }

    .work-label {
      background: #ff6b9d;
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .guide-image {
      width: 100%;
      max-width: 260px;
      height: auto;
      aspect-ratio: 1;
      object-fit: contain;
      border-radius: 16px;
    }

    .guide-text {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    .instruction-text {
      color: #e91e63;
      font-size: clamp(14px, 3.5vw, 17px);
      font-weight: bold;
      margin: 12px 0;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed rgba(233,30,99,0.3);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active { display: block; }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b9d, #e91e63);
      width: 0%;
      transition: width 0.3s;
    }

    /* 
      ================================================
      å…³é”®ä¿®å¤ï¼šè›‹ç³•å®¹å™¨ä½¿ç”¨å›ºå®šé€»è¾‘åæ ‡ç³» 512x512
      ================================================
    */
    .cake-workspace {
      position: relative;
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      /* ä½¿ç”¨ padding-bottom æŠ€å·§ä¿æŒ 1:1 æ¯”ä¾‹ */
      padding-bottom: 100%;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 16px;
      overflow: visible;
      touch-action: none;
    }

    @media (max-width: 480px) {
      .cake-workspace {
        max-width: 280px;
      }
    }

    .cake-inner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* 
        å†…éƒ¨ä½¿ç”¨ 512x512 é€»è¾‘åæ ‡ç³»
        æ‰€æœ‰å­å…ƒç´ éƒ½åŸºäºè¿™ä¸ªåæ ‡ç³»å®šä½
      */
      --cake-size: 512;
    }

    .cake-base-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.2s;
    }

    .decorations-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      /* 
        å…³é”®ï¼šå»ºç«‹ä¸€ä¸ªä¸å›¾ç‰‡å®Œå…¨é‡åˆçš„åæ ‡ç³»
      */
    }

    /* è£…é¥°å…ƒç´ ä½¿ç”¨ calc() åŸºäºç™¾åˆ†æ¯”å®šä½ï¼Œç¡®ä¿ç²¾ç¡® */
    .cream-flower {
      position: absolute;
      width: calc(96 / var(--cake-size) * 100%);
      height: auto;
      aspect-ratio: 1;
      pointer-events: none;
      z-index: 15;
      animation: creamGrow 0.3s ease-out forwards;
      transform-origin: center center;
      /* å±…ä¸­å®šä½ */
      margin-left: calc(-48 / var(--cake-size) * 100%);
      margin-top: calc(-48 / var(--cake-size) * 100%);
    }

    .cream-flower img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    @keyframes creamGrow {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    .static-fruit {
      position: absolute;
      z-index: 16;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
      animation: fruitDrop 0.5s ease-out forwards;
      transform-origin: center center;
      /* å±…ä¸­ */
      margin-left: calc(-15 / var(--cake-size) * 100%);
      margin-top: calc(-15 / var(--cake-size) * 100%);
    }

    .static-fruit.strawberry {
      width: calc(39 / var(--cake-size) * 100%);
      margin-left: calc(-19.5 / var(--cake-size) * 100%);
      margin-top: calc(-19.5 / var(--cake-size) * 100%);
    }

    .static-fruit.medium {
      width: calc(48 / var(--cake-size) * 100%);
      margin-left: calc(-24 / var(--cake-size) * 100%);
      margin-top: calc(-24 / var(--cake-size) * 100%);
    }

    .static-fruit:not(.strawberry):not(.medium) {
      width: calc(30 / var(--cake-size) * 100%);
    }

    .static-fruit img {
      width: 100%;
      height: auto;
      display: block;
    }

    @keyframes fruitDrop {
      0% { transform: scale(0) translateY(-20px); }
      70% { transform: scale(1.2) translateY(5px); }
      100% { transform: scale(1) translateY(0); }
    }

    .candle {
      position: absolute;
      width: calc(48 / var(--cake-size) * 100%);
      margin-left: calc(-24 / var(--cake-size) * 100%);
      margin-top: calc(-48 / var(--cake-size) * 100%); /* ä»åº•éƒ¨å¯¹é½ */
      cursor: pointer;
      z-index: 20;
      transition: transform 0.2s;
      animation: candleInsert 0.3s ease-out;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      transform-origin: center bottom;
    }

    .candle img {
      width: 100%;
      height: auto;
      display: block;
    }

    @keyframes candleInsert {
      from { transform: translateY(-30px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .candle:hover { transform: scale(1.1); }
    .candle.lit {
      animation: flicker 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px #ff6b35) drop-shadow(0 0 20px #ffd93d);
    }

    @keyframes flicker {
      from { transform: scale(1) rotate(-2deg); }
      to { transform: scale(1.05) rotate(2deg); }
    }

    .decoration-emoji {
      position: absolute;
      font-size: calc(28 / var(--cake-size) * 100%);
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
      transform-origin: center center;
      /* ç²¾ç¡®å±…ä¸­ */
      transform: translate(-50%, -50%);
    }

    .decoration-img {
      position: absolute;
      z-index: 20;
      animation: decorPlace 0.3s ease-out;
      transform-origin: center center;
    }

    .decoration-img:not(.qhanyu-large):not(.qghy2) {
      width: calc(50 / var(--cake-size) * 100%);
      margin-left: calc(-25 / var(--cake-size) * 100%);
      margin-top: calc(-25 / var(--cake-size) * 100%);
    }

    .decoration-img.qhanyu-large {
      width: calc(85 / var(--cake-size) * 100%);
      margin-left: calc(-42.5 / var(--cake-size) * 100%);
      margin-top: calc(-42.5 / var(--cake-size) * 100%);
    }

    .decoration-img.qghy2 {
      width: calc(50 / var(--cake-size) * 100%);
      margin-left: calc(-25 / var(--cake-size) * 100%);
      margin-top: calc(-25 / var(--cake-size) * 100%);
    }

    @keyframes decorPlace {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    /* ç»“æœé¡µä¹Ÿä½¿ç”¨ç›¸åŒçš„åæ ‡ç³» */
    .result-cake-container {
      position: relative;
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      padding-bottom: 100%;
      height: 0;
      background: #fff9fc;
      border-radius: 16px;
      overflow: visible;
    }

    @media (max-width: 480px) {
      .result-cake-container {
        max-width: 280px;
      }
    }

    .result-cake-inner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      --cake-size: 512;
    }

    .emoji-palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      max-height: 140px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .emoji-item {
      width: 42px;
      height: 42px;
      font-size: 22px;
      cursor: grab;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .emoji-item img {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }

    .emoji-item:active {
      transform: scale(0.95);
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 22px;
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: clamp(13px, 3.5vw, 16px);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(211,47,47,0.3);
      transition: all 0.2s;
      font-family: 'ZCOOL KuaiLe', cursive;
      touch-action: manipulation;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #d32f1f;
    }

    .result-page { 
      display: none; 
      animation: fadeIn 0.5s;
      padding: 10px;
    }

    .result-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .result-compare { 
        grid-template-columns: 1fr; 
      }
    }

    .result-box {
      background: white;
      border-radius: 20px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .result-title {
      font-family: 'ZCOOL KuaiLe', cursive; 
      color: #e91e63; 
      margin-bottom: 10px;
      font-size: clamp(16px, 4vw, 20px);
    }

    .final-message {
      font-size: clamp(28px, 8vw, 42px);
      text-align: center;
      margin: 20px 0;
      font-family: 'ZCOOL KuaiLe', cursive;
      background: linear-gradient(45deg, #ff6b6b, #f9ca24, #ff9ff3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s ease infinite;
      background-size: 200% 200%;
    }

    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      font-size: clamp(16px, 5vw, 24px);
      animation: fall 4s linear forwards;
    }

    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }

    .fluff-popup {
      position: absolute;
      color: #e91e63;
      font-weight: bold;
      font-size: clamp(13px, 4vw, 16px);
      pointer-events: none;
      z-index: 100;
      animation: floatUp 1s ease-out forwards;
      font-family: 'ZCOOL KuaiLe', cursive;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
      white-space: nowrap;
      transform: translate(-50%, -50%);
    }

    @keyframes floatUp {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      20% { transform: translate(-50%, -70%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -120%) scale(1); opacity: 0; }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      font-size: 14px;
      white-space: nowrap;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .save-indicator {
      position: fixed;
      top: 15px;
      right: 15px;
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3000;
    }

    .save-indicator.show { opacity: 1; }

    .continue-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.95);
      border: 2px solid #e91e63;
      color: #e91e63;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      display: none;
      z-index: 100;
      font-family: 'ZCOOL KuaiLe', cursive;
    }
  </style>
</head>
<body>
  <div class="main-container" id="makeStage">
    <button class="continue-btn" id="continueBtn" onclick="loadProgress()">ğŸ“‚ ç»§ç»­ä¸Šæ¬¡åˆ¶ä½œ</button>
    <h1>ğŸ‚ å¥¶ç³•çš„ç”Ÿæ—¥æ´¾å¯¹è›‹ç³•åˆ¶ä½œ</h1>

    <div class="step-indicator" id="stepIndicator">
      <div class="step-dot active"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
      <div class="step-dot"></div>
    </div>

    <div class="workspace">
      <div class="guide-panel">
        <div class="guide-label">ğŸ“– åˆ¶ä½œæŒ‡å¼•</div>
        <img src="images/1.jpg" class="guide-image" id="guideImage" alt="æŒ‡å¼•å›¾" loading="lazy">
        <div class="guide-text" id="guideText">é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾</div>
      </div>

      <div class="work-panel" id="workPanel">
        <div class="work-label">ğŸ‘©â€ğŸ³ ä½ çš„å·¥ä½œå°</div>
        <div class="instruction-text" id="instruction">ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼</div>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

        <!-- 
          å…³é”®ç»“æ„ï¼špadding-bottom: 100% ä¿æŒæ­£æ–¹å½¢
          å†…éƒ¨ cake-inner æ˜¯ç»å¯¹å®šä½çš„ 100% x 100%
        -->
        <div class="cake-workspace" id="cakeArea">
          <div class="cake-inner">
            <img src="images/7.png" class="cake-base-img" id="workImage" alt="å·¥ä½œè›‹ç³•">
            <div class="decorations-layer" id="decorationsLayer"></div>
          </div>
        </div>

        <div class="emoji-palette" id="emojiPalette" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
      <button class="btn" onclick="nextStep()" id="nextBtn">ä¸‹ä¸€æ­¥ ğŸ‘‰</button>
      <button class="btn btn-secondary" onclick="resetStep()" id="resetBtn" style="display: none;">é‡ç½® â†©ï¸</button>
      <button class="btn btn-secondary" onclick="undoLast()" id="undoBtn" style="display: none;">æ’¤é”€ â†¶</button>
      <button class="btn" onclick="finish()" id="finishBtn" style="display: none;">å®Œæˆæ´¾å¯¹ï¼ğŸ‰</button>
    </div>
  </div>

  <div class="result-page" id="resultPage">
    <h1 style="text-align: center; color: #d32f2f; font-family: 'ZCOOL KuaiLe', cursive;">âœ¨ å¤§åŠŸå‘Šæˆ âœ¨</h1>
    <div class="result-compare">
      <div class="result-box">
        <div class="result-title">ğŸ¨ ä½ åˆ¶ä½œçš„è›‹ç³•</div>
        <!-- ç»“æœé¡µä½¿ç”¨å®Œå…¨ç›¸åŒçš„ç»“æ„ -->
        <div class="result-cake-container" id="playerCake"></div>
      </div>
      <div class="result-box">
        <div class="result-title">âœ¨ å®Œç¾æˆå“å‚è€ƒ</div>
        <div class="result-cake-container">
          <div class="result-cake-inner">
            <img src="images/6.jpg" alt="æˆå“" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;">
          </div>
        </div>
      </div>
    </div>
    <div class="final-message">ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚</div>
    <div class="button-group">
      <button class="btn" onclick="location.reload()">å†åšä¸€ä¸ª ğŸ”„</button>
    </div>
  </div>

  <div class="celebration" id="celebration"></div>
  <div class="toast" id="toast"></div>
  <div class="save-indicator" id="saveIndicator">ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜</div>

  <script>
    // ==========================================
    // é…ç½®å’ŒçŠ¶æ€
    // ==========================================
    const CAKE_SIZE = 512; // é€»è¾‘åæ ‡ç³»å¤§å°
    
    const steps = [
      { guide: 'images/1.jpg', work: 'images/7.png', instruction: 'ç¬¬ä¸€æ­¥ï¼šæŒ‰ä½è›‹ç³•æ‹æ‰“ï¼Œè®©é¢å›¢è†¨èƒ€ï¼', guideText: 'é¦–å…ˆå‡†å¤‡å¥½è›‹ç³•åº•èƒšï¼ŒæŒ‰ä½è›‹ç³•æ‹æ‰“è®©å®ƒå˜å¾—è“¬æ¾', action: 'fluff', hasProgress: true },
      { guide: 'images/2.jpg', work: 'images/7.png', instruction: 'ç¬¬äºŒæ­¥ï¼šæ¶‚æŠ¹å¥¶æ²¹ï¼ˆæŒ‰ä½æ‹–åŠ¨æ¶‚æŠ¹ï¼‰', guideText: 'åœ¨è›‹ç³•ä¸Šå‡åŒ€æ¶‚æŠ¹å¥¶æ²¹', action: 'cream' },
      { guide: 'images/3.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»æ·»åŠ æ°´æœè£…é¥°', guideText: 'æŒ‘é€‰æ–°é²œæ°´æœç‚¹ç¼€è›‹ç³•', action: 'fruit', hasProgress: true, clearCream: true },
      { guide: 'images/4.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å››æ­¥ï¼šç‚¹å‡»æ’ä¸Šç”Ÿæ—¥èœ¡çƒ›ï¼ˆæœ€å¤š5æ ¹ï¼‰', guideText: 'æ’ä¸Šèœ¡çƒ›å‡†å¤‡åº†ç¥ï¼ˆæœ€å¤š5æ ¹ï¼‰', action: 'candle', hasProgress: true },
      { guide: 'images/5.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬äº”æ­¥ï¼šç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬ï¼', guideText: 'ç‚¹å‡»èœ¡çƒ›ç‚¹ç‡ƒå®ƒä»¬', action: 'light' },
      { guide: 'images/6.jpg', work: 'images/creamcake.jpg', instruction: 'ç¬¬å…­æ­¥ï¼šæ‹–æ‹½è£…é¥°ç‰©è¿›è¡Œè‡ªç”±è£…é¥°', guideText: 'æœ€åç‚¹ç¼€ï¼Œè®©è›‹ç³•æ›´å®Œç¾ï¼', action: 'decorate' }
    ];

    let currentStep = 0;
    let fluffiness = 0;
    let candleCount = 0;
    let decorations = [];
    let hasLitCandle = false;
    let lastTouchTime = 0;

    const fluffMessages = ['è“¬æ¾åº¦ +1', 'è›‹ç³•èƒšå˜æ¾è½¯äº†ï½', 'æ‰‹æ„Ÿè¶Šæ¥è¶Šå¥½äº†ï¼', 'ç»§ç»­æ‹ï¼Œæ›´è“¬æ¾âœ¨', 'è›‹ç³•èƒšå¿«è¦è“¬æ¾äº†', 'å·²ç»å¾ˆå®Œç¾äº†ï¼', 'è›‹ç³•è“¬æ¾çš„è¦é£èµ·æ¥äº†ğŸˆ', 'æ¾è½¯åº¦UPï¼'];
    const emojis = ['ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ‚', 'âœ¨', 'ğŸ’–', 'ğŸ', 'ğŸ¦„', 'ğŸŒˆ', 'â­', 'ğŸ€'];
    const fruits = ['images/blue.png', 'images/lemon.png', 'images/strawberry.png'];
    const extraImages = [
      { src: 'images/fox2.png', name: 'fox2', scale: 1 },
      { src: 'images/Q_ghy2.png', name: 'qghy2', scale: 1 },
      { src: 'images/q_hanyu.png', name: 'qhanyu', scale: 1.7 },
      { src: 'images/fox.png', name: 'fox', scale: 1 }
    ];

    // ==========================================
    // æ ¸å¿ƒåæ ‡è½¬æ¢å‡½æ•°ï¼ˆä¿®å¤åç§»çš„å…³é”®ï¼‰
    // ==========================================
    
    /**
     * è·å–è›‹ç³•å†…éƒ¨å…ƒç´ çš„çŸ©å½¢ä¿¡æ¯
     * è¿”å›çš„æ˜¯ .cake-inner å…ƒç´ çš„å®é™…æ¸²æŸ“å°ºå¯¸
     */
    function getCakeRect() {
      const inner = document.querySelector('.cake-inner');
      if (!inner) return null;
      return inner.getBoundingClientRect();
    }

    /**
     * å°†å±å¹•åæ ‡è½¬æ¢ä¸ºè›‹ç³•é€»è¾‘åæ ‡ (0-CAKE_SIZE)
     * è¿™æ˜¯æ‰€æœ‰å®šä½çš„æ ¸å¿ƒå‡½æ•°
     */
    function screenToCakeCoords(screenX, screenY) {
      const rect = getCakeRect();
      if (!rect) return null;
      
      // è€ƒè™‘é¡µé¢æ»šåŠ¨
      const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
      const scrollY = window.pageYOffset || document.documentElement.scrollTop;
      
      // è®¡ç®—ç›¸å¯¹äºè›‹ç³•å®¹å™¨çš„ä½ç½®ï¼ˆ0-1ï¼‰
      const relativeX = (screenX - rect.left) / rect.width;
      const relativeY = (screenY - rect.top) / rect.height;
      
      // è½¬æ¢ä¸ºé€»è¾‘åæ ‡
      return {
        x: relativeX * CAKE_SIZE,
        y: relativeY * CAKE_SIZE,
        relativeX: relativeX,
        relativeY: relativeY
      };
    }

    /**
     * å°†è›‹ç³•é€»è¾‘åæ ‡è½¬æ¢ä¸ºCSS left/topå€¼ï¼ˆå¸¦å•ä½ï¼‰
     */
    function cakeToCssCoords(cakeX, cakeY) {
      const percentX = (cakeX / CAKE_SIZE) * 100;
      const percentY = (cakeY / CAKE_SIZE) * 100;
      return {
        left: percentX + '%',
        top: percentY + '%'
      };
    }

    // ==========================================
    // å·¥å…·å‡½æ•°
    // ==========================================
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    function getPointerCoords(e) {
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }

    // é˜²æ­¢iOSåŒå‡»ç¼©æ”¾
    let lastTapTime = 0;
    document.addEventListener('touchend', (e) => {
      const currentTime = new Date().getTime();
      if (currentTime - lastTapTime < 300) {
        e.preventDefault();
      }
      lastTapTime = currentTime;
    }, { passive: false });

    // ==========================================
    // å­˜æ¡£ç®¡ç†
    // ==========================================
    function saveProgress() {
      try {
        const decorData = decorations.map(d => ({
          step: d.step,
          type: d.type,
          x: d.x, // ä¿å­˜é€»è¾‘åæ ‡ (0-512)
          y: d.y,
          src: d.src,
          emoji: d.emoji,
          scale: d.scale,
          rotation: d.rotation,
          className: d.className
        }));

        const data = {
          currentStep,
          fluffiness,
          candleCount,
          hasLitCandle,
          decorations: decorData,
          timestamp: new Date().toISOString(),
          version: 3 // æ–°ç‰ˆæœ¬å·
        };
        localStorage.setItem('cakeProgress_v3', JSON.stringify(data));
        showSaveIndicator();
      } catch(e) {
        console.log('ä¿å­˜å¤±è´¥', e);
      }
    }

    function loadProgress() {
      try {
        const saved = localStorage.getItem('cakeProgress_v3');
        if (!saved) {
          showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è®°å½•');
          return;
        }

        const data = JSON.parse(saved);
        if (data.version !== 3) {
          showToast('å­˜æ¡£ç‰ˆæœ¬ä¸å…¼å®¹');
          return;
        }

        currentStep = data.currentStep || 0;
        fluffiness = data.fluffiness || 0;
        candleCount = data.candleCount || 0;
        hasLitCandle = data.hasLitCandle || false;

        document.getElementById('decorationsLayer').innerHTML = '';
        decorations = [];

        if (data.decorations && Array.isArray(data.decorations)) {
          data.decorations.forEach(d => restoreDecoration(d));
        }

        updateStep();
        if (hasLitCandle) applyCandleAmbiance();

        const date = new Date(data.timestamp);
        showToast(`å·²æ¢å¤ ${date.getMonth()+1}/${date.getDate()} çš„åˆ¶ä½œè¿›åº¦`);
        document.getElementById('continueBtn').style.display = 'none';
      } catch(e) {
        console.log('åŠ è½½å¤±è´¥', e);
        showToast('åŠ è½½å¤±è´¥');
      }
    }

    function restoreDecoration(data) {
      const decorLayer = document.getElementById('decorationsLayer');
      const coords = cakeToCssCoords(data.x, data.y);
      let el;

      if (data.type === 'cream') {
        el = document.createElement('div');
        el.className = 'cream-flower';
        el.innerHTML = '<img src="images/cream.png" alt="cream">';
        el.style.left = coords.left;
        el.style.top = coords.top;
      } else if (data.type === 'fruit') {
        el = document.createElement('div');
        el.className = data.className || 'static-fruit';
        el.innerHTML = `<img src="${data.src}" alt="fruit">`;
        el.style.left = coords.left;
        el.style.top = coords.top;
        if (data.rotation) {
          setTimeout(() => { el.style.transform = `rotate(${data.rotation}deg)`; }, 10);
        }
      } else if (data.type === 'candle') {
        el = document.createElement('div');
        el.className = data.className?.includes('lit') ? 'candle lit' : 'candle';
        el.innerHTML = '<img src="images/candle.png" alt="candle">';
        el.style.left = coords.left;
        el.style.top = coords.top;
      } else if (data.type === 'emoji') {
        el = document.createElement('div');
        el.className = 'decoration-emoji';
        el.textContent = data.emoji;
        el.style.left = coords.left;
        el.style.top = coords.top;
      } else if (data.type === 'image') {
        el = document.createElement('img');
        el.className = 'decoration-img';
        if (data.className) {
          data.className.split(' ').forEach(c => { if(c) el.classList.add(c); });
        }
        el.src = data.src;
        el.style.left = coords.left;
        el.style.top = coords.top;
      }

      if (el) {
        decorLayer.appendChild(el);
        decorations.push({...data, el});
      }
    }

    function checkSavedProgress() {
      try {
        const saved = localStorage.getItem('cakeProgress_v3');
        if (saved) {
          document.getElementById('continueBtn').style.display = 'block';
        }
      } catch(e) {}
    }

    // ==========================================
    // UIæ§åˆ¶
    // ==========================================
    function applyCandleAmbiance() {
      document.getElementById('makeStage').classList.add('candle-lit');
      document.getElementById('workPanel').classList.add('candle-glow');
    }

    function removeCandleAmbiance() {
      document.getElementById('makeStage').classList.remove('candle-lit');
      document.getElementById('workPanel').classList.remove('candle-glow');
    }

    function showFluffPopup(cakeX, cakeY, message) {
      const popup = document.createElement('div');
      popup.className = 'fluff-popup';
      popup.textContent = message;
      const coords = cakeToCssCoords(cakeX, cakeY);
      popup.style.left = coords.left;
      popup.style.top = coords.top;
      document.querySelector('.cake-inner').appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    function updateStep() {
      const step = steps[currentStep];
      
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.className = 'step-dot' + (idx < currentStep ? ' completed' : '') + (idx === currentStep ? ' active' : '');
      });

      document.getElementById('guideImage').src = step.guide;
      document.getElementById('workImage').src = step.work;
      document.getElementById('guideText').textContent = step.guideText;
      document.getElementById('instruction').textContent = step.instruction;

      document.getElementById('progressBar').style.display = step.hasProgress ? 'block' : 'none';
      updateProgressDisplay();

      setupStepInteraction();

      document.getElementById('prevBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('resetBtn').style.display = currentStep > 0 ? 'inline-block' : 'none';
      document.getElementById('undoBtn').style.display = (currentStep >= 2 && currentStep <= 5) ? 'inline-block' : 'none';

      if (currentStep === 5) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('finishBtn').style.display = 'inline-block';
        document.getElementById('emojiPalette').style.display = 'flex';
        createEmojiPalette();
      } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('emojiPalette').style.display = 'none';
      }

      if (currentStep !== 4 && !hasLitCandle) {
        removeCandleAmbiance();
      }

      if (step.clearCream) {
        document.querySelectorAll('.cream-flower').forEach(el => el.remove());
        decorations = decorations.filter(d => d.type !== 'cream');
      }
    }

    function updateProgressDisplay(current, max) {
      const fill = document.getElementById('progressFill');
      if (currentStep === 0) {
        fill.style.width = (fluffiness / 50 * 100) + '%';
      } else if (current !== undefined && max) {
        fill.style.width = (current / max * 100) + '%';
      }
    }

    // ==========================================
    // äº¤äº’è®¾ç½®ï¼ˆæ ¸å¿ƒä¿®å¤éƒ¨åˆ†ï¼‰
    // ==========================================
    function setupStepInteraction() {
      const cakeArea = document.getElementById('cakeArea');
      const step = steps[currentStep];

      // æ¸…é™¤æ—§äº‹ä»¶ï¼ˆé€šè¿‡å…‹éš†ï¼‰
      const newArea = cakeArea.cloneNode(true);
      cakeArea.parentNode.replaceChild(newArea, cakeArea);

      // é‡æ–°è·å–å¼•ç”¨
      const freshArea = document.getElementById('cakeArea');
      
      // æ¢å¤è£…é¥°å±‚å†…å®¹
      const decorLayer = freshArea.querySelector('.decorations-layer');
      decorations.forEach(d => {
        if (!d.el.parentNode) decorLayer.appendChild(d.el);
      });

      if (step.action === 'fluff') setupFluff(freshArea);
      else if (step.action === 'cream') setupCream(freshArea);
      else if (step.action === 'fruit') setupFruit(freshArea);
      else if (step.action === 'candle') setupCandle(freshArea);
      else if (step.action === 'light') setupLight(freshArea);
    }

    function setupFluff(cakeArea) {
      let pressing = false;
      let interval;
      let workImage = cakeArea.querySelector('.cake-base-img');

      const start = (e) => {
        e.preventDefault();
        if (pressing) return;
        pressing = true;
        workImage.style.transform = 'scale(0.95, 1.05)';

        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (!cakeCoords) return;

        showFluffPopup(cakeCoords.x, cakeCoords.y, fluffMessages[Math.floor(Math.random() * fluffMessages.length)]);

        interval = setInterval(() => {
          if (fluffiness < 50) {
            fluffiness = Math.min(fluffiness + 2, 50);
            updateProgressDisplay();
            if (fluffiness >= 50) {
              clearInterval(interval);
              showToast('è›‹ç³•å·²ç»å¾ˆè“¬æ¾äº†ï¼');
              saveProgress();
              setTimeout(nextStep, 500);
            }
          }
        }, 100);
      };

      const end = () => {
        pressing = false;
        clearInterval(interval);
        workImage.style.transform = 'scale(1)';
      };

      cakeArea.addEventListener('mousedown', start, {passive: false});
      cakeArea.addEventListener('touchstart', start, {passive: false});
      cakeArea.addEventListener('mouseup', end);
      cakeArea.addEventListener('mouseleave', end);
      cakeArea.addEventListener('touchend', end);
    }

    function setupCream(cakeArea) {
      const decorLayer = cakeArea.querySelector('.decorations-layer');
      let isPressed = false;
      let lastCakeX = 0, lastCakeY = 0;

      const addCream = (cakeX, cakeY) => {
        const coords = cakeToCssCoords(cakeX, cakeY);
        const cream = document.createElement('div');
        cream.className = 'cream-flower';
        cream.innerHTML = '<img src="images/cream.png" alt="cream">';
        cream.style.left = coords.left;
        cream.style.top = coords.top;
        
        const scale = 0.8 + Math.random() * 0.4;
        cream.style.transform = `scale(${scale}) rotate(${Math.random()*360}deg)`;
        
        decorLayer.appendChild(cream);
        decorations.push({ step: currentStep, type: 'cream', x: cakeX, y: cakeY, el: cream });
      };

      const start = (e) => {
        e.preventDefault();
        isPressed = true;
        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (cakeCoords) {
          lastCakeX = cakeCoords.x;
          lastCakeY = cakeCoords.y;
          addCream(cakeCoords.x, cakeCoords.y);
        }
      };

      const move = (e) => {
        if (!isPressed) return;
        e.preventDefault();
        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (!cakeCoords) return;

        const dist = Math.hypot(cakeCoords.x - lastCakeX, cakeCoords.y - lastCakeY);
        if (dist > 10) {
          const steps = Math.ceil(dist / 10);
          for (let i = 1; i <= steps; i++) {
            const t = i / steps;
            addCream(lastCakeX + (cakeCoords.x - lastCakeX) * t, lastCakeY + (cakeCoords.y - lastCakeY) * t);
          }
          lastCakeX = cakeCoords.x;
          lastCakeY = cakeCoords.y;
        }
      };

      const end = () => {
        if (isPressed) {
          isPressed = false;
          saveProgress();
        }
      };

      cakeArea.addEventListener('mousedown', start, {passive: false});
      cakeArea.addEventListener('mousemove', move, {passive: false});
      cakeArea.addEventListener('mouseup', end);
      cakeArea.addEventListener('mouseleave', end);
      cakeArea.addEventListener('touchstart', start, {passive: false});
      cakeArea.addEventListener('touchmove', move, {passive: false});
      cakeArea.addEventListener('touchend', end);
    }

    function setupFruit(cakeArea) {
      const decorLayer = cakeArea.querySelector('.decorations-layer');
      
      const handle = (e) => {
        e.preventDefault();
        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (!cakeCoords) return;

        const fruit = document.createElement('div');
        const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
        fruit.innerHTML = `<img src="${randomFruit}" alt="fruit">`;
        
        let className = 'static-fruit';
        if (randomFruit.includes('strawberry')) className += ' strawberry';
        else className += ' medium';
        fruit.className = className;

        const cssCoords = cakeToCssCoords(cakeCoords.x, cakeCoords.y);
        fruit.style.left = cssCoords.left;
        fruit.style.top = cssCoords.top;

        const rotation = Math.random() * 360;
        setTimeout(() => { fruit.style.transform = `rotate(${rotation}deg)`; }, 50);

        decorLayer.appendChild(fruit);
        decorations.push({
          step: currentStep,
          type: 'fruit',
          x: cakeCoords.x,
          y: cakeCoords.y,
          src: randomFruit,
          rotation: rotation,
          className: className,
          el: fruit
        });

        const count = decorations.filter(d => d.type === 'fruit').length;
        updateProgressDisplay(count, 10);
        if (count % 3 === 0) saveProgress();
      };

      cakeArea.addEventListener('click', handle);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        handle(e);
      }, {passive: false});
    }

    function setupCandle(cakeArea) {
      const decorLayer = cakeArea.querySelector('.decorations-layer');
      candleCount = 0;
      updateProgressDisplay(0, 5);

      const handle = (e) => {
        e.preventDefault();
        if (candleCount >= 5) {
          showToast('æœ€å¤šåªèƒ½æ’5æ ¹èœ¡çƒ›ï¼');
          return;
        }

        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (!cakeCoords) return;

        const candle = document.createElement('div');
        candle.className = 'candle';
        candle.innerHTML = '<img src="images/candle.png" alt="candle">';
        
        const cssCoords = cakeToCssCoords(cakeCoords.x, cakeCoords.y);
        candle.style.left = cssCoords.left;
        candle.style.top = cssCoords.top;

        decorLayer.appendChild(candle);
        decorations.push({
          step: currentStep,
          type: 'candle',
          x: cakeCoords.x,
          y: cakeCoords.y,
          el: candle
        });

        candleCount++;
        updateProgressDisplay(candleCount, 5);
        saveProgress();

        if (candleCount === 5) {
          showToast('èœ¡çƒ›æ’æ»¡äº†ï¼Œå‡†å¤‡ç‚¹ç‡ƒï¼');
          setTimeout(nextStep, 800);
        }
      };

      cakeArea.addEventListener('click', handle);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        handle(e);
      }, {passive: false});
    }

    function setupLight(cakeArea) {
      const decorLayer = cakeArea.querySelector('.decorations-layer');

      const handle = (e) => {
        e.preventDefault();
        const coords = getPointerCoords(e);
        const cakeCoords = screenToCakeCoords(coords.x, coords.y);
        if (!cakeCoords) return;

        const candles = decorLayer.querySelectorAll('.candle:not(.lit)');
        if (candles.length === 0 && candleCount > 0) {
          nextStep();
          return;
        }

        let litNew = false;
        candles.forEach(candle => {
          // è§£æèœ¡çƒ›çš„é€»è¾‘åæ ‡
          const decorData = decorations.find(d => d.el === candle);
          if (!decorData) return;
          
          const dist = Math.hypot(cakeCoords.x - decorData.x, cakeCoords.y - decorData.y);
          if (dist < 40) { // 40pxé€»è¾‘è·ç¦»
            candle.classList.add('lit');
            decorData.className = 'candle lit';
            litNew = true;
          }
        });

        if (litNew && !hasLitCandle) {
          hasLitCandle = true;
          applyCandleAmbiance();
          saveProgress();
        }

        if (decorLayer.querySelectorAll('.candle:not(.lit)').length === 0 && candleCount > 0) {
          showToast('âœ¨ å…¨éƒ¨ç‚¹ç‡ƒäº†ï¼');
          setTimeout(nextStep, 1000);
        }
      };

      cakeArea.addEventListener('click', handle);
      cakeArea.addEventListener('touchend', (e) => {
        e.preventDefault();
        handle(e);
      }, {passive: false});
    }

    // ==========================================
    // è£…é¥°é¢æ¿
    // ==========================================
    function createEmojiPalette() {
      const palette = document.getElementById('emojiPalette');
      palette.innerHTML = '';

      [...extraImages, ...emojis.map(e => ({emoji: e, isEmoji: true}))].forEach(item => {
        const div = document.createElement('div');
        div.className = 'emoji-item';
        
        if (item.isEmoji) {
          div.textContent = item.emoji;
        } else {
          div.innerHTML = `<img src="${item.src}" alt="${item.name}">`;
        }

        const startDrag = (e) => {
          e.preventDefault();
          const startCoords = getPointerCoords(e);
          
          // åˆ›å»ºæ‹–æ‹½å¹½çµ
          const ghost = document.createElement('div');
          ghost.style.cssText = `
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            left: ${startCoords.x}px;
            top: ${startCoords.y}px;
            transform: translate(-50%, -50%);
            font-size: 40px;
          `;
          if (item.isEmoji) {
            ghost.textContent = item.emoji;
          } else {
            const size = item.scale === 1.7 ? 85 : 50;
            ghost.innerHTML = `<img src="${item.src}" style="width:${size}px;height:${size}px;">`;
          }
          document.body.appendChild(ghost);

          const move = (e) => {
            const coords = getPointerCoords(e);
            ghost.style.left = coords.x + 'px';
            ghost.style.top = coords.y + 'px';
          };

          const end = (e) => {
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', end);
            document.removeEventListener('touchmove', move);
            document.removeEventListener('touchend', end);

            const endCoords = getPointerCoords(e);
            const cakeRect = getCakeRect();
            
            if (cakeRect && 
                endCoords.x >= cakeRect.left && endCoords.x <= cakeRect.right &&
                endCoords.y >= cakeRect.top && endCoords.y <= cakeRect.bottom) {
              
              const cakeCoords = screenToCakeCoords(endCoords.x, endCoords.y);
              const cssCoords = cakeToCssCoords(cakeCoords.x, cakeCoords.y);
              const decorLayer = document.querySelector('.decorations-layer');
              
              if (item.isEmoji) {
                const el = document.createElement('div');
                el.className = 'decoration-emoji';
                el.textContent = item.emoji;
                el.style.left = cssCoords.left;
                el.style.top = cssCoords.top;
                decorLayer.appendChild(el);
                decorations.push({step: currentStep, type: 'emoji', x: cakeCoords.x, y: cakeCoords.y, emoji: item.emoji, el});
              } else {
                const el = document.createElement('img');
                el.className = 'decoration-img';
                if (item.scale === 1.7) el.classList.add('qhanyu-large');
                el.src = item.src;
                el.style.left = cssCoords.left;
                el.style.top = cssCoords.top;
                decorLayer.appendChild(el);
                decorations.push({step: currentStep, type: 'image', x: cakeCoords.x, y: cakeCoords.y, src: item.src, scale: item.scale, className: el.className, el});
              }
              saveProgress();
            }
            ghost.remove();
          };

          document.addEventListener('mousemove', move, {passive: false});
          document.addEventListener('mouseup', end);
          document.addEventListener('touchmove', move, {passive: false});
          document.addEventListener('touchend', end);
        };

        div.addEventListener('mousedown', startDrag, {passive: false});
        div.addEventListener('touchstart', startDrag, {passive: false});
        palette.appendChild(div);
      });
    }

    // ==========================================
    // å¯¼èˆªå’Œæ§åˆ¶
    // ==========================================
    function undoLast() {
      for (let i = decorations.length - 1; i >= 0; i--) {
        if (decorations[i].step === currentStep) {
          decorations[i].el.remove();
          decorations.splice(i, 1);
          showToast('å·²æ’¤é”€');
          saveProgress();
          return;
        }
      }
      showToast('æ²¡æœ‰å¯æ’¤é”€çš„');
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
        saveProgress();
      }
    }

    function nextStep() {
      if (currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
        saveProgress();
      }
    }

    function resetStep() {
      decorations = decorations.filter(d => {
        if (d.step === currentStep) {
          d.el.remove();
          return false;
        }
        return true;
      });
      if (currentStep === 0) fluffiness = 0;
      if (currentStep === 3) candleCount = 0;
      if (currentStep === 4) {
        hasLitCandle = false;
        removeCandleAmbiance();
        decorations.filter(d => d.type === 'candle').forEach(d => {
          d.el.classList.remove('lit');
          d.className = 'candle';
        });
      }
      updateStep();
      saveProgress();
      showToast('å·²é‡ç½®å½“å‰æ­¥éª¤');
    }

    // ==========================================
    // å®Œæˆå‡½æ•°ï¼ˆç¡®ä¿ç»“æœé¡µå®Œå…¨ä¸€è‡´ï¼‰
    // ==========================================
    function finish() {
      document.getElementById('makeStage').style.display = 'none';
      document.getElementById('resultPage').style.display = 'block';
      
      try {
        localStorage.removeItem('cakeProgress_v3');
      } catch(e) {}

      const playerCake = document.getElementById('playerCake');
      playerCake.innerHTML = '';

      // åˆ›å»ºä¸åˆ¶ä½œæ—¶å®Œå…¨ç›¸åŒçš„ç»“æ„
      const container = document.createElement('div');
      container.className = 'result-cake-inner';
      
      // åº•å›¾
      const baseImg = document.createElement('img');
      baseImg.src = steps[currentStep].work;
      baseImg.className = 'cake-base-img';
      baseImg.alt = 'è›‹ç³•';
      container.appendChild(baseImg);

      // è£…é¥°å±‚ - ä½¿ç”¨ç›¸åŒçš„åæ ‡ç³»ç»Ÿ
      const decorLayer = document.createElement('div');
      decorLayer.className = 'decorations-layer';

      decorations.forEach(d => {
        const coords = cakeToCssCoords(d.x, d.y);
        let clone;
        
        if (d.type === 'cream') {
          clone = document.createElement('div');
          clone.className = 'cream-flower';
          clone.innerHTML = '<img src="images/cream.png" alt="cream">';
        } else if (d.type === 'fruit') {
          clone = document.createElement('div');
          clone.className = d.className || 'static-fruit';
          clone.innerHTML = `<img src="${d.src}" alt="fruit">`;
          if (d.rotation) clone.style.transform = `rotate(${d.rotation}deg)`;
        } else if (d.type === 'candle') {
          clone = document.createElement('div');
          clone.className = d.className || 'candle';
          clone.innerHTML = '<img src="images/candle.png" alt="candle">';
          if (clone.classList.contains('lit')) {
            clone.style.animation = 'none';
            clone.style.filter = 'drop-shadow(0 0 8px #ff6b35)';
          }
        } else if (d.type === 'emoji') {
          clone = document.createElement('div');
          clone.className = 'decoration-emoji';
          clone.textContent = d.emoji;
        } else if (d.type === 'image') {
          clone = document.createElement('img');
          clone.className = 'decoration-img';
          if (d.className) d.className.split(' ').forEach(c => { if(c) clone.classList.add(c); });
          clone.src = d.src;
        }

        if (clone) {
          clone.style.left = coords.left;
          clone.style.top = coords.top;
          clone.style.position = 'absolute';
          clone.style.pointerEvents = 'none';
          decorLayer.appendChild(clone);
        }
      });

      container.appendChild(decorLayer);
      playerCake.appendChild(container);

      // åº†ç¥åŠ¨ç”»
      const celebration = document.getElementById('celebration');
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.textContent = ['ğŸ€', 'ğŸ‰', 'ğŸˆ', 'ğŸ', 'ğŸŠ', 'âœ¨', 'ğŸ§'][Math.floor(Math.random() * 7)];
          c.style.left = Math.random() * 100 + 'vw';
          c.style.animationDuration = (3 + Math.random() * 2) + 's';
          celebration.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i * 30);
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==========================================
    // åˆå§‹åŒ–
    // ==========================================
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ
    document.body.addEventListener('touchmove', (e) => {
      if (e.target.closest('.emoji-palette')) return;
      e.preventDefault();
    }, { passive: false });

    checkSavedProgress();
    updateStep();
  </script>
</body>
</html>











